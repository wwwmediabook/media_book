<!DOCTYPE html>
<html lng="bn">
<head>
    <meta charset="UTF-8">
    <!-- এই লাইনটি পরিবর্তন করে জুম বন্ধ করা হয়েছে -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Media book</title>
    <!-- Google Fonts & Font Awesome -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #1877F2; --primary-hover: #166fe5; --background-color: #F0F2F5; --card-background: #FFFFFF;
            --text-color: #050505; --secondary-text-color: #65676B; --border-color: #CED0D4;
            --divider-color: #E4E6EB; --success-color: #42b72a; --error-color: #F02849;
            --love-color: #F33E58; --haha-color: #F7B125; --wow-color: #F7B125; --sad-color: #F7B125; --angry-color: #E9710F; --dislike-color: var(--secondary-text-color);
            --header-height: 56px;
            --bottom-nav-height: 50px; /* নতুন বটম নেভিগেশন বারের জন্য */
            --notification-unread-bg: #E7F3FF;
        }
        body.dark-theme {
            --primary-color: #1877F2; --primary-hover: #2184ff; --background-color: #18191A; --card-background: #242526;
            --text-color: #E4E6EB; --secondary-text-color: #B0B3B8; --border-color: #3E4042;
            --divider-color: #3E4042;
            --notification-unread-bg: #2D3A4F;
        }
        body { font-family: 'Hind Siliguri', sans-serif; background: var(--background-color); margin: 0; color: var(--text-color); transition: background-color 0.2s, color 0.2s; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .btn { padding: 10px 16px; border: none; border-radius: 6px; font-weight: 600; font-size: 15px; cursor: pointer; background-color: var(--primary-color); color: white; transition: background-color 0.2s; }
        .btn:disabled { background-color: #a0c3ff; color: #e0e0e0; cursor: not-allowed; }
        body.dark-theme .btn:disabled { background-color: #3A3B3C; color: #8a8d91; }
        .btn.full-width { width: 100%; padding: 14px; margin-top: 10px; font-size: 16px; font-weight: 700;}
        .btn.secondary { background-color: #E4E6EB; color: #050505; }
        body.dark-theme .btn.secondary { background-color: #3A3B3C; color: #E4E6EB; }
        .btn.secondary:hover { background-color: #d8dbdf; }
        body.dark-theme .btn.secondary:hover { background-color: #4E4F50; }
        .btn.flat { background: none; color: var(--secondary-text-color); font-weight: 600; padding: 10px 15px; flex: 1; text-align: center; }
        .btn.flat:hover { background-color: var(--divider-color); }
        .btn.flat.active.like { color: var(--primary-color); }
        .btn.flat.active.dislike { color: var(--dislike-color); }
        .btn.flat.active.love { color: var(--love-color); }
        .btn.flat.active.wow { color: var(--wow-color); }
        .btn.flat.active.sad { color: var(--sad-color); }
        .btn.flat.active.angry { color: var(--angry-color); }
        .btn.success { background-color: var(--success-color); color: white; }
        .btn.danger { background-color: var(--error-color); color: white; }
        .btn.small { padding: 5px 10px; font-size: 12px; }
        .input, .textarea, .select { width: 100%; padding: 14px 16px; box-sizing: border-box; margin: 8px 0; border-radius: 6px; border: 1px solid var(--border-color); font-size: 17px; background-color: #F5F6F7; color: #050505; font-family: 'Hind Siliguri', sans-serif; }
        body.dark-theme .input, body.dark-theme .textarea, body.dark-theme .select { background-color: #3A3B3C; border-color: #3E4042; color: #E4E6EB; }
        .input:focus, .textarea:focus, .select:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px #e7f3ff; }
        .card { background: var(--card-background); border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); transition: background-color 0.2s; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; flex-shrink: 0; background-size: cover; background-position: center; border: 1px solid var(--divider-color); cursor: pointer; }
        .modal-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); display: flex; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(4px); }
        body.dark-theme .modal-background { background: rgba(0, 0, 0, 0.7); }
        .modal-content { width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #auth-page-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        #auth-card { width: 100%; max-width: 430px; box-sizing: border-box; padding: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1); }
        #auth-card h1 { color: var(--primary-color); font-size: 56px; font-weight: 700; margin-bottom: 10px; }
        #auth-card p { font-size: 18px; color: var(--secondary-text-color); margin-bottom: 25px; }
        .auth-form-divider { border-bottom: 1px solid var(--divider-color); margin: 20px -20px; }
        #show-register-modal-btn { background-color: #42b72a; font-size: 17px; padding: 14px 18px; }
        #show-register-modal-btn:hover { background-color: #36a420; }
        .register-modal-content { max-width: 430px; padding: 0; }
        .register-header { padding: 10px 16px; border-bottom: 1px solid var(--divider-color); }
        .register-header h2 { margin: 0; font-size: 32px; }
        .register-header p { margin: 0; color: var(--secondary-text-color); }
        .register-body { padding: 16px; }
        #register-btn { background-color: #42b72a; font-size: 18px; }
        .forgot-password { color: var(--primary-color); font-size: 14px; margin-top: 15px; cursor: pointer; }
        .forgot-password:hover { text-decoration: underline; }

        #app-header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); background: var(--card-background); box-shadow: 0 2px 4px rgba(0,0,0,.1); display: flex; align-items: center; padding: 0 16px; z-index: 100; justify-content: space-between; }
        #header-left { display: flex; align-items: center; gap: 10px; }
        /* --- স্ক্রিনশট অনুযায়ী হেডার টাইটেল বামে --- */
        .header-title {
            font-size: 24px;
            font-weight: 600;
        }
        .logo-m { display: none; } /* M লোগোটি আপাতত হাইড করা হলো */
        #header-center { display: none; } /* ডেক্সটপের সেন্টার আইকন হাইড */
        .header-icon { font-size: 20px; color: var(--secondary-text-color); cursor: pointer; width: 40px; height: 40px; display: grid; place-items: center; border-radius: 50%; background: var(--background-color); border: none; position: relative; }
        body.dark-theme .header-icon { background-color: #3A3B3C; }
        .header-icon.active { color: var(--primary-color); }
        .header-icon:not(.active):hover { background-color: var(--divider-color); }
        .notification-badge { position: absolute; top: 5px; right: 5px; background-color: var(--error-color); color: white; border-radius: 50%; padding: 1px 6px; font-size: 11px; font-weight: bold; line-height: 1.2; }
        #header-right { display: flex; align-items: center; gap: 10px; }
        #mobile-menu-toggle { display: none; background: none; color: var(--text-color); border-radius: 50%; width: 40px; height: 40px; place-items: center; font-size: 20px; border: none; }
        body.dark-theme #mobile-menu-toggle { background-color: transparent; }

        #app-container { display: grid; grid-template-columns: 300px 1fr 300px; max-width: 1400px; margin: auto; gap: 20px; padding: 20px; padding-top: calc(var(--header-height) + 20px); }
        .main-content-profile-grid { max-width: 1040px; margin: 0 auto; }
        .left-sidebar { position: sticky; top: calc(var(--header-height) + 20px); height: calc(100vh - var(--header-height) - 40px); overflow-y: auto; transition: transform 0.3s ease-in-out; }
        .right-sidebar { position: sticky; top: calc(var(--header-height) + 20px); height: calc(100vh - var(--header-height) - 40px); overflow-y: auto; }
        .sidebar-menu .menu-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; position: relative; }
        .menu-item:hover { background-color: var(--divider-color); }
        .menu-item i { font-size: 20px; width: 30px; text-align: center; color: var(--primary-color); }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 998; }

        #header-search-container { position: relative; }
        #header-search-input { background-color: var(--background-color); border: none; border-radius: 20px; padding: 8px 16px 8px 36px; width: 220px; font-family: 'Hind Siliguri', sans-serif; }
        #header-search-container i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--secondary-text-color); }
        #search-results { display: none; position: absolute; top: 110%; left: 0; width: 250px; background-color: var(--card-background); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 400px; overflow-y: auto; z-index: 101; }
        .search-result-item { display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; }
        .search-result-item:hover { background-color: var(--divider-color); }
        .search-result-item .avatar { width: 36px; height: 36px; font-size: 18px; }

        /* --- নতুন বটম নেভিগেশন বার --- */
        #bottom-nav { display: none; }
        
        /* --- স্ক্রিনশট থেকে ফ্লোটিং বাটন --- */
        #floating-action-button {
            display: none;
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + 20px);
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--secondary-text-color);
            color: white;
            border-radius: 15px;
            display: grid;
            place-items: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 990;
        }


        .admin-badge { margin-left: 5px; font-size: 16px; }
        .verified-badge { color: var(--primary-color); margin-left: 4px; font-size: 0.9em; vertical-align: middle; }

        .settings-card { padding: 16px; }
        .settings-card h4 { margin-top: 0; border-bottom: 1px solid var(--divider-color); padding-bottom: 10px; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .qr-code-container { text-align: center; margin: 20px 0; }
        .qr-code-container img { max-width: 200px; border: 4px solid var(--divider-color); border-radius: 8px; }
        .qr-code-container p { color: var(--secondary-text-color); margin-top: 10px; font-size: 14px; }


        .create-post-card { display: flex; gap: 10px; align-items: center; padding: 12px; }
        #post-input-placeholder { flex-grow: 1; border-radius: 20px; border: none; background: var(--background-color); padding: 12px 16px; cursor: pointer; text-align: left; color: var(--secondary-text-color); }
        body.dark-theme #post-input-placeholder { background: #3A3B3C; color: var(--secondary-text-color); }
        #post-input-placeholder:hover { background-color: #e2e5e9; }
        body.dark-theme #post-input-placeholder:hover { background-color: #4E4F50; }
        .post { padding: 0; }
        .post-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px 0; }
        .post-header-info { flex-grow: 1; cursor: pointer; }
        .post-header-info small { color: var(--secondary-text-color); }
        .post-audience-icon { margin-left: 8px; color: var(--secondary-text-color); }
        .post-content { padding: 15px 16px; font-size: 16px; white-space: pre-wrap; word-wrap: break-word; }
        .post-content .mention-link, .intro-item .mention-link, .comment-bubble .mention-link, .post-content .hashtag-link { color: var(--primary-color); font-weight: 600; text-decoration: none; cursor: pointer; }
        .post-content .mention-link:hover, .intro-item .mention-link:hover, .comment-bubble .mention-link:hover, .post-content .hashtag-link:hover { text-decoration: underline; }
        .post-content a, .comment-bubble a { color: var(--primary-color); text-decoration: underline; }
        .post-media { max-width: 100%; height: auto; margin-top: 10px; border-top: 1px solid var(--divider-color); border-bottom: 1px solid var(--divider-color); display: block; }
        .post-stats { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; color: var(--secondary-text-color); font-size: 14px; border-bottom: 1px solid var(--divider-color); }
        .post-stats-left { display: flex; align-items: center; gap: 4px; cursor: pointer; }
        .post-stats-right { display: flex; align-items: center; gap: 10px; }
        .post-stats-left .reaction-icon { font-size: 18px; }
        .post-actions { display: flex; justify-content: space-around; padding: 4px 0; }
        .reaction-button-container { position: relative; flex: 1; }
        .reaction-popup { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: var(--card-background); border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 4px 8px; margin-bottom: 8px; white-space: nowrap; z-index: 10; }
        .reaction-button-container:hover .reaction-popup { display: flex; gap: 12px; }
        .reaction-popup .reaction { font-size: 28px; cursor: pointer; transition: transform 0.1s ease-in-out; }
        .reaction-popup .reaction:hover { transform: scale(1.3); }
        .post-comments { padding: 0 16px 16px; }
        .comment-item { display: flex; gap: 8px; margin-top: 10px; }
        .comment-item .avatar { width: 32px; height: 32px; font-size: 16px; }
        .comment-bubble { background: var(--background-color); padding: 8px 12px; border-radius: 18px; word-wrap: break-word; flex-grow: 1; position: relative; }
        .comment-bubble .comment-delete-btn { display: none; position: absolute; top: 4px; right: 8px; cursor: pointer; color: var(--secondary-text-color); font-size: 14px; }
        .comment-item-wrapper:hover .comment-delete-btn { display: inline; }
        body.dark-theme .comment-bubble { background-color: #3A3B3C; }
        .comment-actions { font-size: 12px; font-weight: bold; color: var(--secondary-text-color); padding-left: 52px; margin-top: -4px;}
        .comment-actions .reply-btn { cursor: pointer; } .comment-actions .reply-btn:hover { text-decoration: underline; }
        .comment-replies { margin-left: 52px; padding-left: 10px; border-left: 2px solid var(--divider-color); }
        .comment-reply-form { margin-top: 8px; display: flex; gap: 8px; align-items: center; }
        .comment-reply-form .input { margin: 0; font-size: 14px; padding: 6px 10px; }
        .comment-form-wrapper { position: relative; display: flex; gap: 8px; margin-top: 10px; }
        .comment-form { display: flex; flex-grow: 1; gap: 8px; }
        .comment-form .input { margin: 0; width: 100%; border-radius: 18px; padding: 8px 12px; font-size: 15px; }
        .mention-suggestions { display: none; position: absolute; bottom: 100%; left: 0; right: 0; background: var(--card-background); border: 1px solid var(--border-color); border-radius: 8px; max-height: 150px; overflow-y: auto; z-index: 10; margin-bottom: 5px; }
        .mention-item { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .mention-item:hover { background-color: var(--divider-color); }
        .mention-item .avatar { width: 24px; height: 24px; font-size: 12px; }

        .post-modal-actions { display: flex; gap: 10px; margin-top: 15px; align-items: center; }
        .post-modal-actions .audience-selector { flex-shrink: 0; width: 150px; }
        .post-modal-actions .btn-group { flex-grow: 1; display: flex; gap: 10px; }
        .post-modal-actions .btn-group .btn { flex-grow: 1; }

        .post-actions-menu { position: relative; cursor: pointer; padding: 8px; border-radius: 50%; width: 20px; text-align: center; }
        .post-actions-menu:hover { background-color: var(--divider-color); }
        .post-actions-menu .dropdown-menu { position: absolute; top: 100%; right: 0; background: var(--card-background); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); list-style: none; padding: 8px 0; margin: 5px 0 0; min-width: 180px; z-index: 10; display: none; }
        .post-actions-menu:hover .dropdown-menu { display: block; }
        .dropdown-menu li { padding: 10px 15px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .dropdown-menu li:hover { background-color: var(--divider-color); }
        
        /* --- Styles for other sections remain the same --- */
        .profile-header-container { background-color: var(--card-background); box-shadow: 0 1px 2px rgba(0,0,0,.1); border-radius: 8px; }
        .profile-cover { height: 200px; background: linear-gradient(to bottom, rgba(0,0,0,0.2), transparent); background-size: cover; background-position: center; border-radius: 8px 8px 0 0; }
        .profile-details-wrapper { padding: 0 16px; }
        .profile-details-bar { display: flex; align-items: flex-end; padding-bottom: 20px; border-bottom: 1px solid var(--divider-color); }
        .profile-avatar-container { margin-top: -30px; margin-right: 16px; }
        .profile-avatar-large { width: 168px; height: 168px; border-radius: 50%; border: 4px solid var(--card-background); background-size: cover; background-position: center; font-size: 80px; flex-shrink: 0; }
        .profile-info-actions-wrapper { display: flex; justify-content: space-between; align-items: flex-end; flex-grow: 1; }
        .profile-info h1 { margin: 0 0 5px; font-size: 32px; }
        .profile-info .profile-category { margin: 0 0 10px; font-size: 17px; color: var(--secondary-text-color); font-weight: 600; }
        .profile-stats { display: flex; flex-wrap: wrap; gap: 10px 20px; color: var(--secondary-text-color); font-weight: 600; }
        .profile-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; position: relative; }
        .profile-actions .more-menu { position: relative; }
        .profile-nav { display: flex; padding: 0 16px; }
        .profile-nav-item { padding: 16px; font-weight: 600; color: var(--secondary-text-color); cursor: pointer; border-bottom: 3px solid transparent; }
        .profile-nav-item.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .profile-body { padding: 20px 32px; display: grid; grid-template-columns: 380px 1fr; gap: 20px; }
        .profile-intro-card .intro-item { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; color: var(--text-color); }
        .profile-intro-card .intro-item i { width: 20px; text-align: center; color: var(--secondary-text-color); }
        #profile-link-text { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; color: var(--secondary-text-color); }
        .profile-actions .dropdown-menu { position: absolute; top: 100%; right: 0; background: var(--card-background); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); list-style: none; padding: 8px 0; margin: 5px 0 0; min-width: 180px; z-index: 10; display: none; }
        .profile-actions .more-menu:hover .dropdown-menu { display: block; }
        
        #admin-panel-controls { padding: 16px; border-bottom: 1px solid var(--divider-color); }
        .admin-user-card { display: flex; flex-direction: column; gap: 15px; padding: 16px; border-bottom: 1px solid var(--divider-color); }
        .admin-user-card:last-child { border-bottom: none; }
        .admin-user-header { display: flex; gap: 15px; align-items: center; }
        .admin-user-info { flex-grow: 1; }
        .admin-user-info strong { font-size: 16px; display: flex; align-items: center; }
        .admin-user-info small { color: var(--secondary-text-color); word-break: break-all; }
        .admin-user-info .role-badge { margin-left: 8px; font-size: 12px; padding: 2px 6px; border-radius: 10px; color: white; }
        .admin-user-info .role-badge.superadmin { background-color: gold; color: black; }
        .admin-user-info .role-badge.admin { background-color: var(--primary-color); }
        .admin-user-info .role-badge.user { background-color: var(--secondary-text-color); }
        .admin-user-details { font-size: 13px; color: var(--secondary-text-color); display: grid; grid-template-columns: auto 1fr; gap: 4px 10px; margin-top: 10px; }
        .admin-user-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; margin-top: 10px; }
        #monetization-settings-form { padding: 16px; display: grid; grid-template-columns: 1fr; gap: 15px; align-items: center; }
        #notification-form { padding: 16px; } 
        #notification-list .notification-item { display: flex; gap: 12px; padding: 12px; border-bottom: 1px solid var(--divider-color); cursor: pointer; }
        #notification-list .notification-item.unread { background-color: var(--notification-unread-bg); }
        #notification-list .notification-item:hover { background-color: var(--divider-color); }
        #notification-list .notification-item .avatar { width: 56px; height: 56px; flex-shrink: 0; }
        #notification-list .notification-item .notification-content p { margin: 0; }
        #notification-list .notification-item .notification-content small { color: var(--secondary-text-color); }

        .chat-container { display: flex; flex-direction: column; height: calc(100vh - var(--header-height)); }
        .chat-header { display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-bottom: 1px solid var(--divider-color); }
        .chat-header .back-btn { font-size: 20px; cursor: pointer; padding: 5px; }
        .chat-messages { flex-grow: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .message-item { display: flex; gap: 8px; margin-bottom: 10px; max-width: 80%; }
        .message-item .avatar { width: 32px; height: 32px; font-size: 16px; flex-shrink: 0; align-self: flex-end; }
        .message-bubble { background: var(--background-color); padding: 8px 12px; border-radius: 18px; word-wrap: break-word; }
        body.dark-theme .message-bubble { background-color: #3A3B3C; }
        .message-item.sent { align-self: flex-end; flex-direction: row-reverse; }
        .message-item.sent .message-bubble { background: var(--primary-color); color: white; }
        .message-form-wrapper { position: relative; padding: 10px; border-top: 1px solid var(--divider-color); background: var(--card-background); }
        .message-form { display: flex; gap: 10px; }
        .message-form .input { margin: 0; width: 100%; border-radius: 18px; padding: 8px 16px; font-size: 15px; }
        .inbox-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 8px; cursor: pointer; }
        .inbox-item:hover { background-color: var(--divider-color); }
        .inbox-item-details { flex-grow: 1; }
        .inbox-item-details .last-message { color: var(--secondary-text-color); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .typing-indicator-container { padding: 0 16px 10px; display: flex; align-items: center; gap: 8px; }
        .typing-indicator-container .avatar { width: 32px; height: 32px; font-size: 16px; flex-shrink: 0; }
        .typing-indicator-dots { display: flex; align-items: center; gap: 3px; background-color: var(--background-color); padding: 8px 12px; border-radius: 18px;}
        body.dark-theme .typing-indicator-dots { background-color: #3A3B3C; }
        .typing-indicator-dots span { width: 8px; height: 8px; background-color: var(--secondary-text-color); border-radius: 50%; animation: typing-pulse 1.4s infinite ease-in-out both; }
        .typing-indicator-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing-pulse { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        #user-directory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
        .user-directory-card { text-align: center; padding: 16px; }
        .user-directory-card .avatar { width: 80px; height: 80px; font-size: 40px; margin: 0 auto 10px; }
        .user-directory-card-name { font-weight: 600; margin-bottom: 12px; cursor: pointer; }
        .user-directory-card-name:hover { text-decoration: underline; }
        .user-directory-card-actions { display: flex; flex-direction: column; gap: 8px; }
        
        .ad-placeholder { padding: 10px 0; text-align: center; overflow: hidden; min-height: 90px; display: flex; justify-content: center; align-items: center;}
        .ad-placeholder iframe { max-width: 100% !important; }

        #global-notification-banner { position: fixed; top: var(--header-height); left: 0; right: 0; background-color: var(--primary-color); color: white; padding: 12px; text-align: center; z-index: 999; display: flex; justify-content: center; align-items: center; font-weight: 500; font-size: 14px; }
        #global-notification-banner .close-btn { position: absolute; right: 15px; font-size: 20px; cursor: pointer; }

        .balance-history-table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px; }
        .balance-history-table th, .balance-history-table td { padding: 8px; border: 1px solid var(--divider-color); text-align: left; }
        .balance-history-table th { background-color: var(--background-color); }
        .balance-history-table .amount-positive { color: var(--success-color); font-weight: bold; }
        .balance-history-table .amount-negative { color: var(--error-color); font-weight: bold; }

        .blocked-user-item { display: flex; align-items: center; gap: 15px; padding: 10px; border-bottom: 1px solid var(--divider-color); }
        .blocked-user-item:last-child { border-bottom: none; }
        .blocked-user-item .avatar { width: 40px; height: 40px; }
        .blocked-user-item span { flex-grow: 1; font-weight: 600; }

        #story-reel-container { padding: 12px; display: flex; gap: 10px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        #story-reel-container::-webkit-scrollbar { display: none; }
        .story-item { display: inline-flex; flex-direction: column; align-items: center; cursor: pointer; width: 70px; text-align: center; }
        .story-avatar-wrapper { width: 60px; height: 60px; border-radius: 50%; display: grid; place-items: center; padding: 3px; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }
        .story-avatar-wrapper.seen { background: var(--border-color); }
        .story-avatar-wrapper.create { background: none; border: 2px dashed var(--secondary-text-color); }
        .story-avatar { width: 100%; height: 100%; border-radius: 50%; background-size: cover; background-position: center; border: 2px solid var(--card-background); }
        .story-item .create-icon { font-size: 24px; color: var(--primary-color); }
        .story-name { font-size: 12px; color: var(--secondary-text-color); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        #story-viewer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1001; display: flex; align-items: center; justify-content: center; }
        .story-viewer-content { width: 100%; height: 100%; max-width: 450px; max-height: 100vh; position: relative; display: flex; flex-direction: column; }
        .story-viewer-header { position: absolute; top: 0; left: 0; right: 0; padding: 15px; display: flex; flex-direction: column; gap: 5px; z-index: 2; background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent); }
        .story-progress-bars { display: flex; gap: 3px; width: 100%; }
        .story-progress-bar { flex-grow: 1; height: 3px; background-color: rgba(255, 255, 255, 0.4); border-radius: 2px; }
        .story-progress-bar-inner { height: 100%; width: 0; background-color: #fff; border-radius: 2px; transition: width 0.1s linear; }
        .story-viewer-info { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .story-viewer-info .avatar { width: 36px; height: 36px; }
        .story-viewer-info span { color: white; font-weight: 600; }
        #story-viewer-video { width: 100%; height: 100%; object-fit: contain; }
        .story-viewer-close { position: absolute; top: 20px; right: 15px; font-size: 24px; color: white; cursor: pointer; z-index: 3; text-shadow: 0 0 5px black; }
        .story-viewer-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; color: white; display: grid; place-items: center; cursor: pointer; z-index: 3; }
        #story-nav-prev { left: 10px; }
        #story-nav-next { right: 10px; }
        .story-viewer-footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; z-index: 2; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .story-reaction-bar { display: flex; gap: 20px; padding: 8px 20px; background-color: rgba(0,0,0,0.5); border-radius: 25px; }
        .story-reaction-bar .reaction { font-size: 28px; cursor: pointer; transition: transform 0.1s ease-in-out; }
        .story-reaction-bar .reaction:hover { transform: scale(1.3); }
        #story-video-preview { max-width: 100%; max-height: 40vh; margin-top: 10px; border: 1px solid var(--divider-color); }
        
        .reactions-modal-content { max-width: 450px; padding: 0; }
        .reactions-modal-header { padding: 12px 16px; border-bottom: 1px solid var(--divider-color); font-size: 20px; font-weight: 700; }
        .reactions-modal-tabs { display: flex; padding: 0 16px; border-bottom: 1px solid var(--divider-color); overflow-x: auto; }
        .reactions-modal-tab { padding: 12px 16px; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; white-space: nowrap; }
        .reactions-modal-tab:hover { background-color: var(--divider-color); }
        .reactions-modal-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .reaction-user-list { padding: 8px; max-height: 50vh; overflow-y: auto; }
        .reaction-user-item { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 6px; }
        .reaction-user-item:hover { background-color: var(--divider-color); }
        .reaction-user-item .avatar { width: 40px; height: 40px; }
        .reaction-user-item .name { flex-grow: 1; font-weight: 600; }
        .reaction-user-item .reaction-icon { font-size: 20px; }
        .story-viewers-footer-button { background: rgba(255,255,255,0.2); color: white; font-weight: 600; }

        .dashboard-header-card { display: flex; align-items: center; gap: 15px; padding: 16px; }
        .dashboard-header-card .avatar { width: 50px; height: 50px; font-size: 24px; }
        .dashboard-header-info { flex-grow: 1; }
        .dashboard-header-info h4 { margin: 0 0 4px; font-size: 18px; }
        .dashboard-header-info p { margin: 0; color: var(--secondary-text-color); font-size: 14px; }
        .dashboard-progress-bar { height: 8px; background-color: var(--divider-color); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .dashboard-progress-bar-inner { height: 100%; width: 4%; background-color: var(--primary-color); border-radius: 4px; }
        
        .dashboard-section { padding: 16px; }
        .dashboard-section-title { font-size: 20px; font-weight: 700; margin: 0 0 12px; }
        .dashboard-action-item { display: flex; align-items: center; gap: 16px; padding: 12px 0; border-bottom: 1px solid var(--divider-color); cursor: pointer; }
        .dashboard-action-item:last-child { border-bottom: none; }
        .dashboard-action-item:hover { background-color: var(--background-color); }
        .dashboard-action-icon { font-size: 20px; color: var(--secondary-text-color); width: 36px; height: 36px; display: grid; place-items: center; background-color: var(--divider-color); border-radius: 50%; }
        .dashboard-action-text strong { font-size: 16px; display: block; }
        .dashboard-action-text small { color: var(--secondary-text-color); font-size: 13px; }
        .dashboard-action-arrow { font-size: 20px; color: var(--secondary-text-color); margin-left: auto; }
        
        .dashboard-insights-summary { margin-bottom: 16px; font-size: 17px; }
        .dashboard-insights-summary strong { font-size: 24px; }
        .stat-change { font-weight: 600; margin-left: 8px; }
        .stat-change.positive { color: var(--success-color); }
        .stat-change.negative { color: var(--error-color); }
        
        .insights-chart-container { width: 100%; overflow: hidden; }
        .insights-chart-container svg { width: 100%; height: auto; }
        .insights-chart-container .grid-line { stroke: var(--divider-color); stroke-width: 1; }
        .insights-chart-container .axis-label { fill: var(--secondary-text-color); font-size: 12px; }
        .insights-chart-container .chart-line { fill: none; stroke: var(--primary-color); stroke-width: 2.5; }
        
        .dashboard-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
        .dashboard-stat-card { padding: 16px; }
        .dashboard-stat-card h5 { margin: 0 0 4px; color: var(--secondary-text-color); font-size: 15px; font-weight: 500; }
        .dashboard-stat-card .value { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        
        .friend-request-item { display: flex; align-items: center; gap: 12px; padding: 10px; }
        .friend-request-info { flex-grow: 1; }
        .friend-request-info .name { font-weight: 600; cursor: pointer; }
        .friend-request-actions { display: flex; gap: 8px; }

        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease-out;
        }
        #splash-logo {
            font-family: Arial, sans-serif;
            font-size: 80px;
            font-weight: 700;
            color: var(--primary-color);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* --- GAMING SECTION STYLES --- */
        #games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .game-card {
            background-color: var(--card-background);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }
        .game-card:hover {
            transform: perspective(1000px) translateY(-10px) rotateY(5deg) rotateX(5deg);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        .game-card-thumbnail {
            width: 100%;
            height: 150px;
            background-size: cover;
            background-position: center;
            border-bottom: 1px solid var(--divider-color);
        }
        .game-card-title {
            padding: 12px;
            font-weight: 600;
            font-size: 16px;
        }
        #game-player-container {
            width: 100%;
            height: 100%;
        }
        #game-player-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
        }
        #game-canvas {
            width: 100%;
            height: calc(100vh - var(--header-height) - 100px); /* Adjust height as needed */
            background: #000;
        }
        #game-canvas iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #admin-games-manager { padding: 16px; }
        .admin-game-item { display: flex; align-items: center; gap: 15px; padding: 10px; border-bottom: 1px solid var(--divider-color); }
        .admin-game-item:last-child { border-bottom: none; }
        .admin-game-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .admin-game-item span { flex-grow: 1; font-weight: 600; }

        /* Desktop First Styles */
        @media (min-width: 769px) and (max-width: 1024px) { 
            #app-container { grid-template-columns: 300px 1fr; padding: 10px; padding-top: calc(var(--header-height) + 10px); } 
            .right-sidebar { display: none; } 
            .profile-body { grid-template-columns: 1fr; } 
        }

        /* --- MOBILE OPTIMIZED STYLES --- */
        @media (max-width: 768px) {
            /* --- মেইন কন্টেইনার এবং সাইডবার পরিবর্তন --- */
            #app-container { 
                grid-template-columns: 1fr; 
                padding: 10px; 
                padding-top: calc(var(--header-height) + 10px); 
                padding-bottom: calc(var(--bottom-nav-height) + 10px); /* বটম বারের জন্য জায়গা */
            } 
            .right-sidebar, .left-sidebar .sidebar-menu { display: none; } /* ডান সাইডবার এবং মেনু হাইড */
            .left-sidebar { 
                position: fixed; left: 0; top: 0; height: 100%; width: 280px; max-width: 80%;
                z-index: 1000; background-color: var(--card-background); transform: translateX(-100%);
                transition: transform 0.3s ease-in-out; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
                padding-top: 20px; box-sizing: border-box;
            }
            .left-sidebar .sidebar-menu { display: block; } /* স্লাইড-আউট মেনুতে আইটেম দেখাবে */
            .left-sidebar.open { transform: translateX(0); }
            
            /* --- হেডার পরিবর্তন (স্ক্রিনশট অনুযায়ী) --- */
            #app-header { padding: 0 10px; }
            #header-left { flex-grow: 1; } /* বাম অংশকে বড় করা হলো */
            #header-right .logo-m { display: none; } /* M লোগোকে হেডার থেকে সরানো হলো */
            #header-center { display: none; } /* উপরের নেভিগেশন আইকন হাইড */
            #mobile-menu-toggle { display: none; } /* হ্যামবার্গার মেনু বাটনও হাইড */
            #header-search-container { display: none; } /* সার্চ বার হাইড */
            
            /* --- নতুন বটম নেভিগেশন বার ডিজাইন --- */
            #bottom-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: var(--bottom-nav-height);
                background-color: var(--card-background);
                box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
                justify-content: space-around;
                align-items: center;
                z-index: 999;
            }
            .bottom-nav-item {
                font-size: 24px;
                color: var(--secondary-text-color);
                cursor: pointer;
                flex-grow: 1;
                text-align: center;
                padding: 10px 0;
                border-top: 3px solid transparent;
            }
            .bottom-nav-item.active {
                color: var(--primary-color);
            }

            /* --- ফ্লোটিং বাটন দৃশ্যমান করা --- */
            #floating-action-button {
                display: grid;
            }
            
            #auth-card h1 { font-size: 40px; }
            .card { border-radius: 0; margin-left: -10px; margin-right: -10px; } /* Full-width cards */
            .main-content { margin: 0; }
            
            .modal-content, .register-modal-content, .reactions-modal-content { max-width: 95%; }

            /* Profile Page Mobile */
            .profile-body { padding: 10px 0; grid-template-columns: 1fr; } 
            .profile-details-bar { flex-direction: column; align-items: center; } 
            .profile-avatar-container { margin-right: 0; margin-top: -60px; }
            .profile-avatar-large { width: 120px; height: 120px; font-size: 60px; }
            .profile-info-actions-wrapper { flex-direction: column; align-items: center; gap: 15px; margin-top: 10px; width: 100%; } 
            .profile-info { text-align: center; }
            .profile-info h1 { font-size: 26px; }
            .profile-stats { justify-content: center; font-size: 14px; }
            .profile-actions { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
            .profile-actions .btn { font-size: 14px; padding: 8px; }
            .profile-actions .more-menu { grid-column: 1 / -1; }
            .profile-cover { height: 150px; border-radius: 0; }
            .profile-header-container { border-radius: 0; }
            .profile-nav { justify-content: space-around; }
            .profile-intro-card { padding: 16px; }
            
            /* Post Mobile (ফোল্ডারিং UI) */
            .post {
                border-left: none;
                border-right: none;
            }
            .post-content { 
                font-size: 15px; 
                padding: 12px 16px;
            }
            .post-media {
                margin-left: -16px;
                margin-right: -16px;
                border-radius: 0;
                border-top: 1px solid var(--divider-color);
                border-bottom: 1px solid var(--divider-color);
            }
            .post-stats {
                 padding: 8px 16px;
            }
            .post-actions { 
                padding: 2px 0; 
            }
            .btn.flat { 
                font-size: 14px;
                padding: 8px 12px;
            }
            .post-comments {
                padding: 0 16px 12px;
            }
            .comment-form .input {
                padding: 8px 14px;
                font-size: 14px;
            }

            /* User Directory Mobile */
            #user-directory-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; padding: 8px; }
            .user-directory-card { padding: 12px; }
            .user-directory-card .avatar { width: 60px; height: 60px; font-size: 30px; }

            #monetization-settings-form { grid-template-columns: 1fr; }
            
            /* Games Mobile */
            #games-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 10px; }
            .game-card-thumbnail { height: 100px; }
        }
    </style>
</head>
<body>
    <!-- --- NEW SPLASH SCREEN --- -->
    <div id="splash-screen">
        <div id="splash-logo">M</div>
    </div>

    <div id="auth-page-container" class="hidden">
        <div id="auth-card" class="card">
            <h1>Media book</h1>
            <p data-lang-key="auth_subtitle">বন্ধুদের সাথে সংযোগ স্থাপন করুন এবং বিশ্বের সাথে শেয়ার করুন।</p>
            <div id="login-form">
                <input class="input" type="email" id="loginEmail" data-lang-placeholder-key="email_or_phone_placeholder">
                <input class="input" type="password" id="loginPassword" data-lang-placeholder-key="password_placeholder">
                <button id="loginBtn" class="btn full-width" data-lang-key="login_button">লগইন করুন</button>
                <div class="forgot-password" id="forgot-password-link" data-lang-key="forgot_password">পাসওয়ার্ড ভুলে গেছেন?</div>
            </div>
            <div class="auth-form-divider"></div>
            <button id="show-register-modal-btn" class="btn" data-lang-key="create_new_account_button">নতুন অ্যাকাউন্ট তৈরি করুন</button>
            <p id="authError" style="color:var(--error-color); margin-top:15px; font-weight: bold;"></p>
        </div>
    </div>
    <div id="app-wrapper" class="hidden"> 
        <header id="app-header"> 
             <!-- পরিবর্তিত হেডার -->
            <div id="header-left"> 
                <span class="header-title">Media book</span>
            </div> 
            
            <div id="header-right">
                <!-- ডেক্সটপ ভিউ-এর জন্য এই আইকনগুলো থাকবে -->
                <div id="desktop-header-icons" style="display: flex; gap: 10px;">
                    <div class="header-icon" data-view="feed" data-lang-title-key="home"><i class="fa-solid fa-house"></i></div> 
                    <div class="header-icon" data-view="videos" data-lang-title-key="videos"><i class="fa-solid fa-clapperboard"></i></div>
                    <div class="header-icon" data-view="games" data-lang-title-key="games"><i class="fa-solid fa-gamepad"></i></div>
                    <div class="header-icon" data-view="people" data-lang-title-key="people"><i class="fa-solid fa-users"></i></div> 
                </div>

                <div class="header-icon" data-view="inbox" data-lang-title-key="messages"><i class="fa-solid fa-comment-dots"></i></div>
                <div class="header-icon" data-view="notifications" data-lang-title-key="notifications">
                    <i class="fa-solid fa-bell"></i>
                    <span id="notification-badge" class="notification-badge hidden"></span>
                </div>
                 <div class="post-actions-menu">
                    <i class="fa-solid fa-ellipsis-v"></i>
                    <ul class="dropdown-menu" style="min-width: 220px;">
                        <li data-view="profile"><i class="fa-solid fa-user"></i> <span data-lang-key="profile">প্রোফাইল</span></li>
                        <li data-view="dashboard" id="dropdown-dashboard-btn" class="hidden"><i class="fa-solid fa-chart-line"></i> <span data-lang-key="professional_dashboard">প্রফেশনাল ড্যাশবোর্ড</span></li>
                        <li data-view="admin" id="dropdown-admin-btn" class="hidden"><i class="fa-solid fa-user-shield"></i> <span data-lang-key="admin_panel">অ্যাডমিন প্যানেল</span></li>
                        <li data-view="games"><i class="fa-solid fa-gamepad"></i> <span data-lang-key="games">গেমস</span></li>
                        <hr style="border-color: var(--divider-color); margin: 5px 0;">
                        <li data-action="logout"><i class="fa-solid fa-right-from-bracket"></i> <span data-lang-key="logout">লগআউট</span></li>
                    </ul>
                </div>
            </div> 
        </header> 
        
        <div id="global-notification-banner" class="hidden"> <span class="message"></span> <i class="fa-solid fa-xmark close-btn" data-action="close-notification"></i> </div> 
        <div id="sidebar-overlay" class="hidden"></div>
        
        <div id="app-container"> 
            <!-- পরিবর্তিত সাইডবার -->
            <aside class="left-sidebar"> 
                 <!-- এই সাইডবারটি এখন হ্যামবার্গার মেনুতে ক্লিক করলে দেখাবে -->
                <div id="mobile-search-container" style="padding: 0 10px; margin-bottom: 15px;">
                    <div id="header-search-container-mobile" style="position: relative;">
                        <i class="fa-solid fa-search" style="top: 50%; transform: translateY(-50%); position: absolute; left: 12px; color: var(--secondary-text-color);"></i>
                        <input type="text" id="header-search-input-mobile" data-lang-placeholder-key="search_users_placeholder" style="width: 100%; box-sizing: border-box; background-color: var(--background-color); border: none; border-radius: 20px; padding: 8px 16px 8px 36px;">
                        <div id="search-results-mobile" style="display: none; position: absolute; top: 110%; left: 0; width: 100%; background-color: var(--card-background); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 400px; overflow-y: auto; z-index: 1001;"></div>
                    </div>
                </div>
                <div class="sidebar-menu"> 
                    <div class="menu-item" id="my-profile-btn" data-view="profile"> <div class="avatar" id="sidebar-avatar"></div> <span id="sidebar-name"></span> </div> 
                    <div class="menu-item hidden" id="admin-panel-btn" data-view="admin"><i class="fa-solid fa-user-shield"></i><span data-lang-key="admin_panel">অ্যাডমিন প্যানেল</span></div> 
                    <div class="menu-item hidden" id="dashboard-btn" data-view="dashboard"><i class="fa-solid fa-chart-line"></i><span data-lang-key="professional_dashboard">প্রফেশনাল ড্যাশবোর্ড</span></div>
                    <div class="menu-item" data-view="feed"><i class="fa-solid fa-house"></i><span data-lang-key="home">হোম</span></div> 
                    <div class="menu-item" data-view="videos"><i class="fa-solid fa-clapperboard"></i><span data-lang-key="videos">ভিডিও</span></div>
                    <div class="menu-item" data-view="games"><i class="fa-solid fa-gamepad"></i><span data-lang-key="games">গেমস</span></div>
                    <div class="menu-item" data-view="people"><i class="fa-solid fa-users"></i><span data-lang-key="people">মানুষজন</span></div> 
                    <div class="menu-item" data-view="notifications" data-lang-title-key="notifications">
                        <i class="fa-solid fa-bell"></i>
                        <span data-lang-key="notifications">নোটিফিকেশন</span>
                        <span id="sidebar-notification-badge" class="notification-badge hidden" style="position:static; margin-left: auto;"></span>
                    </div>
                    <div class="menu-item" data-view="inbox"><i class="fa-solid fa-comment-dots"></i><span data-lang-key="messages">মেসেজ</span></div> 
                    <div class="menu-item hidden" id="balance-menu-item"> <i class="fa-solid fa-dollar-sign"></i><span data-lang-key="balance">ব্যালেন্স</span>: ৳<span id="user-balance">0.00</span> </div> 
                    <div class="menu-item" data-action="logout"><i class="fa-solid fa-right-from-bracket"></i><span data-lang-key="logout">লগআউট</span></div> 
                </div> 
                <hr style="border-color: var(--divider-color);">
                <div class="card settings-card" style="margin: 10px; padding: 10px;">
                    <h4 data-lang-key="settings">সেটিংস</h4>
                    <div class="settings-row">
                        <span data-lang-key="language">ভাষা</span>
                        <div>
                            <button class="btn small" data-action="set-lang" data-lang="bn">বাংলা</button>
                            <button class="btn small" data-action="set-lang" data-lang="en">EN</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <span data-lang-key="theme">থিম</span>
                         <div>
                            <button class="btn small" data-action="set-theme" data-theme="light" data-lang-key="light_theme">লাইট</button>
                            <button class="btn small" data-action="set-theme" data-theme="dark" data-lang-key="dark_theme">ডার্ক</button>
                        </div>
                    </div>
                </div>
            </aside> 
            <main id="main-content"></main> 
            <aside class="right-sidebar"> 
                 <div class="card" id="sidebar-ad-container" style="padding:16px;"></div>
                <div class="card" style="padding:16px;"> 
                    <h4 data-lang-key="contacts">কন্টাক্টস</h4> <div id="contacts-list"></div> 
                </div> 
            </aside> 
        </div>
        
        <!-- নতুন বটম নেভিগেশন বার -->
        <nav id="bottom-nav">
            <div class="bottom-nav-item active" data-view="feed" data-lang-title-key="home"><i class="fa-solid fa-house"></i></div>
            <div class="bottom-nav-item" data-view="people" data-lang-title-key="people"><i class="fa-solid fa-users"></i></div>
            <div class="bottom-nav-item" data-view="games" data-lang-title-key="games"><i class="fa-solid fa-gamepad"></i></div>
            <div class="bottom-nav-item" data-view="videos" data-lang-title-key="videos"><i class="fa-solid fa-clapperboard"></i></div>
            <div class="bottom-nav-item" data-view="profile" data-lang-title-key="profile"><i class="fa-solid fa-user"></i></div>
        </nav>

        <!-- নতুন ফ্লোটিং বাটন -->
        <div id="floating-action-button">
            <i class="fa-solid fa-wrench"></i>
        </div>
    </div>
    
    <div id="modal-container" class="modal-background hidden"></div> 
    <div id="loader-modal" class="modal-background hidden"><div class="loading-spinner"></div></div>
    
    <div id="story-viewer-container"></div>

    <div id="recaptcha-container" style="position: fixed; bottom: 0; right: 0;"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script>
        // --- আপনার সম্পূর্ণ জাভাস্ক্রিপ্ট কোডটি এখানে থাকবে ---
        const firebaseConfig = { apiKey: "AIzaSyCOzGA68m9ub2d7Ks99NvwHJfRADkmUYVA", authDomain: "media-book-c19c8.firebaseapp.com", databaseURL: "https://media-book-c19c8-default-rtdb.firebaseio.com", projectId: "media-book-c19c8", storageBucket: "media-book-c19c8.appspot.com", messagingSenderId: "455770361782", appId: "1:455770361782:android:63fa899fddce561e5dfb17" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.database(), storage = firebase.storage();
        const ADMIN_EMAIL = "mediabookofficial24@gmail.com", BASE_URL = "https://media.book.id";
        const loader = document.getElementById('loader-modal');
        let currentUser = null, currentUserData = {}, currentView = 'feed', userDbListener = null, activeChatListener = null, mentionableUsersCache = [], friendRequestDbListener = null, unreadNotificationsListener = null;
        
        let activeTypingListener = null;
        let typingTimeout = null;

        let currentLang = 'bn', currentTheme = 'light';
        let blockedUserIds = new Set();
        let mfaResolver = null;
        let mfaVerificationId = null; 
        let mfaHint = null;
        let totpEnrollment = null; 
        let storyViewerState = {
            isShowing: false,
            groupedStories: [],
            currentUserIndex: 0,
            currentStoryIndex: 0,
            storyTimeout: null
        };
        let allUsersCache = [];

        const reactionEmojis = {
            like: '👍', love: '❤️', haha: '😂', wow: '😱', sad: '😭', angry: '😡',
        };

        const translations = {
            bn: {
                delete_comment: "কমেন্ট মুছুন", confirm_comment_delete: "আপনি কি নিশ্চিত যে এই কমেন্টটি মুছতে চান?", comment_deleted_success: "কমেন্ট সফলভাবে মুছে ফেলা হয়েছে।", comment_delete_fail: "কমেন্ট মুছতে সমস্যা হয়েছে।", games: "গেমস", add_game: "নতুন গেম যোগ করুন", game_title: "গেমের নাম", thumbnail_url: "থাম্বনেইল ইউআরএল", game_type: "গেমের প্রকার", game_type_url: "ইউআরএল (URL)", game_type_html: "এইচটিএমএল (HTML)", game_content_url: "গেমের ইউআরএল দিন", game_content_html: "গেমের এইচটিএমএল কোড দিন", manage_games: "গেম ম্যানেজমেন্ট", no_games_found: "কোনো গেম পাওয়া যায়নি।", add_new_game: "নতুন গেম যোগ করুন", edit_game: "গেম এডিট করুন", delete_game: "গেম মুছুন", confirm_game_delete: "আপনি কি নিশ্চিত যে এই গেমটি মুছে ফেলতে চান?", game_added_success: "গেম সফলভাবে যোগ করা হয়েছে!", game_updated_success: "গেম সফলভাবে আপডেট করা হয়েছে!", game_deleted_success: "গেম সফলভাবে মুছে ফেলা হয়েছে!", game_op_failed: "গেম অপারেশনে সমস্যা হয়েছে।", add_friend: "ফ্রেন্ড হিসাবে যোগ করুন", friends: "ফ্রেন্ডস", cancel_request: "রিকোয়েস্ট বাতিল করুন", respond_to_request: "রিকোয়েস্টে সাড়া দিন", accept: "গ্রহণ করুন", decline: "বাতিল করুন", unfriend: "আনফ্রেন্ড", confirm_unfriend: "আপনি কি নিশ্চিত যে {name}-কে আনফ্রেন্ড করতে চান?", friend_requests: "ফ্রেন্ড রিকোয়েস্ট", no_friend_requests: "কোনো নতুন ফ্রেন্ড রিকোয়েস্ট নেই।", your_tools: "আপনার টুলস", insights_at_a_glance: "এক নজরে ইনসাইটস", balance_and_history: "ব্যালেন্স ও হিস্ট্রি", view_balance_details: "আপনার আয় এবং লেনদেনের ইতিহাস দেখুন", monetization_locked: "মনিটাইজেশন লক করা আছে", admin_approval_needed: "আনলক করার জন্য এডমিনের অনুমোদন প্রয়োজন", reply: "রিপ্লাই", liked_your_post: "<b>{name}</b> আপনার পোস্টে রিঅ্যাক্ট দিয়েছেন:", commented_on_your_post: "<b>{name}</b> আপনার পোস্টে কমেন্ট করেছেন:", replied_to_your_comment: "<b>{name}</b> আপনার কমেন্টে রিপ্লাই দিয়েছেন:", no_notifications: "আপনার কোনো নতুন নোটিফিকেশন নেই।", role_management: "ভূমিকা ব্যবস্থাপনা", role: "ভূমিকা (Role)", user_role: "ব্যবহারকারী", admin_role: "অ্যাডমিন", superadmin_role: "সুপার অ্যাডমিন", change_role_success: "{name}-এর ভূমিকা সফলভাবে পরিবর্তন করা হয়েছে।", change_role_fail: "ভূমিকা পরিবর্তন করতে সমস্যা হয়েছে।", cannot_change_own_role: "আপনি নিজের ভূমিকা পরিবর্তন করতে পারবেন না।", created_at: "তৈরির তারিখ", user_id: "ইউজার আইডি", send_password_reset: "পাসওয়ার্ড রিসেট পাঠান", password_reset_sent_success: "{email}-এ পাসওয়ার্ড রিসেট লিঙ্ক পাঠানো হয়েছে।", password_reset_sent_fail: "পাসওয়ার্ড রিসেট লিঙ্ক পাঠাতে সমস্যা হয়েছে।", admin_search_placeholder: "নাম বা ইমেইল দিয়ে খুঁজুন...", typing: "টাইপ করছেন...", send_gift: "গিফট পাঠান", gift_amount: "গিফটের পরিমাণ", gift_note: "নোট (ঐচ্ছিক)", confirm_gift: "আপনি কি নিশ্চিত যে আপনি {name}-কে ৳{amount} গিফট করতে চান?", insufficient_balance: "আপনার অ্যাকাউন্টে পর্যাপ্ত ব্যালেন্স নেই।", gift_success: "সফলভাবে {name}-কে ৳{amount} গিফট পাঠানো হয়েছে!", gift_fail: "গিফট পাঠাতে সমস্যা হয়েছে।", reason_gift_sent: "{name}-কে গিফট পাঠানো হয়েছে", reason_gift_received: "{name}-এর থেকে গিফট পাওয়া গেছে", gift_received_notification: "<b>{name}</b> আপনাকে ৳{amount} গিফট পাঠিয়েছেন!", next_steps: "পরবর্তী পদক্ষেপ", weekly_challenge: "সাপ্তাহিক চ্যালেঞ্জ", weekly_challenge_remaining: "{percent}% বাকি", continue_weekly_challenge: "আপনার সাপ্তাহিক চ্যালেঞ্জ চালিয়ে যান!", requirements_left: "এই সপ্তাহের চ্যালেঞ্জটি সম্পূর্ণ করতে আপনার {count}টি প্রয়োজনীয়তা বাকি আছে।", earn_reels_achievement: "একটি রিল অর্জন করুন", learn_reels_tools: "রিল তৈরির টুলস অন্বেষণ করতে সাহায্য করে এমন অর্জনগুলি কীভাবে অর্জন করবেন তা জানুন।", insights: "ইনসাইটস", last_28_days: "শেষ ২৮ দিন", great_job_views: "দারুণ কাজ, আপনার <strong>{count}</strong> ভিউ হয়েছে!", from_previous_28_days: "পূর্ববর্তী ২৮ দিনের থেকে", approximate_earnings: "আনুমানিক আয়", engagement: "এনগেজমেন্ট", net_followers: "নেট ফলোয়ার্স", like: "লাইক", dislike: "ডিজলাইক", love: "লাভ", wow: "ওয়াও", sad: "স্যাড", angry: "অ্যাংরি", haha: "হাহা", create_story: "স্টোরি তৈরি", your_story: "আপনার স্টোরি", upload_story: "স্টোরি আপলোড করুন", upload_story_prompt: "একটি ভিডিও ফাইল (সর্বোচ্চ ২ মিনিট) বাছাই করুন:", error_story_duration: "দুঃখিত, ভিডিওটি অবশ্যই ২ মিনিটের কম হতে হবে।", story_upload_success: "স্টোরি সফলভাবে আপলোড হয়েছে!", story_upload_fail: "স্টোরি আপলোড করতে সমস্যা হয়েছে: {message}", no_stories_found: "বন্ধুদের কোনো নতুন স্টোরি নেই।", react_to_story: "স্টোরিতে রিঅ্যাক্ট দিন", viewers: "ভিউয়ার ({count})", reactions_title: "রিঅ্যাকশনস", story_viewers_title: "স্টোরি ভিউয়ারস", all: "সব", no_reactions_yet: "এখনো কোনো রিঅ্যাকশন নেই।", no_views_yet: "এখনো কেউ দেখেনি।", auth_subtitle: "বন্ধুদের সাথে সংযোগ স্থাপন করুন এবং বিশ্বের সাথে শেয়ার করুন।", email_or_phone_placeholder: "ইমেইল অথবা ফোন নম্বর", password_placeholder: "পাসওয়ার্ড", login_button: "লগইন করুন", forgot_password: "পাসওয়ার্ড ভুলে গেছেন?", create_new_account_button: "নতুন অ্যাকাউন্ট তৈরি করুন", home: "হোম", videos: "ভিডিও", notifications: "নোটিফিকেশন", messages: "মেসেজ", profile: "প্রোফাইল", admin_panel: "অ্যাডমিন প্যানেল", balance: "ব্যালেন্স", logout: "লগআউট", settings: "সেটিংস", language: "ভাষা", theme: "থিম", light_theme: "লাইট", dark_theme: "ডার্ক", contacts: "কন্টাক্টস", search_users_placeholder: "ব্যবহারকারী খুঁজুন...", no_results_found: "কোনো ফলাফল পাওয়া যায়নি", whats_on_your_mind: "কী ভাবছেন, {name}?", no_posts_found: "এই সেকশনে কোনো পোস্ট পাওয়া যায়নি।", no_videos_found: "কোনো ভিডিও পোস্ট পাওয়া যায়নি।", user_not_found: "ব্যবহারকারীকে খুঁজে পাওয়া যায়নি।", account_suspended: "এই অ্যাকাউন্টটি সাসপেন্ড করা হয়েছে।", edit_profile: "প্রোফাইল এডিট", follow: "ফলো", following: "ফলোয়িং", message: "মেসেজ", posts: "পোস্ট", followers: "ফলোয়ার", following_count: "ফলোয়িং", intro: "পরিচিতি", name: "নাম", email: "ইমেইল", phone: "ফোন", application_or_request: "এপ্লিকেশন বা আবেদন", copy: "কপি", copied: "কপি হয়েছে!", no_posts_by_user: "এই ব্যবহারকারী এখনো কোনো পোস্ট করেননি।", comment: "কমেন্ট", comments: "{count} কমেন্ট", write_a_comment: "একটি কমেন্ট লিখুন...", user_suspended_alert: "আপনার অ্যাকাউন্টটি সাসপেন্ড করা হয়েছে।", new_user_bio: "আমি একজন নতুন ব্যবহারকারী!", relationship_single: "সিঙ্গেল", with_person: "এর সাথে {status}", balance_history: "হিস্ট্রি", balance_with_currency: "ব্যালেন্স: ৳", profile_link: "প্রোফাইল লিঙ্ক", admin_panel_users: "অ্যাডমিন প্যানেল - ব্যবহারকারী", unverify: "আনভেরিফাই", verify: "ভেরিফাই", remove_monetization: "মনিটাইজেশন সরান", monetize: "মনিটাইজ করুন", manage_balance: "ব্যালেন্স", unsuspend: "আনসাসপেন্ড", suspend: "সাসপেন্ড", global_notification: "গ্লোবাল নোটিফিকেশন", send_notification_placeholder: "সকল ব্যবহারকারীকে একটি নোটিফিকেশন পাঠান...", send_notification: "নোটিফিকেশন পাঠান", monetization_settings: "মনিটাইজেশন সেটিংস", reactions_per_balance: "রিঅ্যাকশন প্রতি ব্যালেন্স (কত?)", balance_amount: "ব্যালেন্সের পরিমাণ (কত?)", save_settings: "সেটিংস সংরক্ষণ", no_messages: "আপনার কোনো মেসেজ নেই।", write_a_message: "মেসেজ লিখুন...", no_messages_yet: "এখনো কোনো মেসেজ নেই।", new_post: "নতুন পোস্ট", whats_in_your_mind: "আপনার মনের কথা লিখুন...", upload_media: "ছবি/ভিডিও আপলোড করুন:", post_button: "পোস্ট", cancel: "বাতিল", signup: "সাইন আপ", signup_subtitle: "এটি দ্রুত এবং সহজ।", full_name: "আপনার পুরো নাম", new_password: "নতুন পাসওয়ার্ড", edit_profile_title: "প্রোফাইল এডিট করুন", bio: "বায়ো", write_about_yourself: "আপনার সম্পর্কে কিছু লিখুন...", relationship_status: "রিলেশনশিপ স্ট্যাটাস", partner_username: "পার্টনারের ইউজারনেম (e.g., @username)", profile_picture: "প্রোফাইল ছবি", cover_photo: "কভার ছবি", save: "সংরক্ষণ", manage_balance_for: "'{name}' এর ব্যালেন্স ম্যানেজ করুন", current_balance: "বর্তমান ব্যালেন্স", set_new_balance: "নতুন ব্যালেন্স সেট করুন", balance_history_title: "ব্যালেন্স হিস্ট্রি", date: "তারিখ", reason: "কারণ", amount: "টাকার পরিমাণ", new_balance: "নতুন ব্যালেন্স", reason_reaction: "রিঅ্যাকশন মাইলস্টোন বোনাস", reason_admin: "এডমিন কর্তৃক আপডেট", reason_unknown: "অজানা কারণ", no_transaction_history: "কোনো লেনদেনের ইতিহাস পাওয়া যায়নি।", close: "বন্ধ করুন", error_generic: "দুঃখিত, একটি সমস্যা হয়েছে।", error_post_delete: "পোস্ট ডিলিট করতে সমস্যা হয়েছে: {message}", confirm_post_delete: "আপনি কি নিশ্চিত যে এই পোস্টটি ডিলিট করতে চান?", error_login: "ভুল ইমেইল অথবা পাসওয়ার্ড।", fill_all_fields: "অনুগ্রহ করে সকল তথ্য পূরণ করুন।", registration_failed: "রেজিস্ট্রেশন ব্যর্থ: {message}", post_creation_failed: "পোস্ট করতে সমস্যা হয়েছে: {message}", profile_update_failed: "প্রোফাইল আপডেট করতে সমস্যা হয়েছে: {message}", invalid_number: "অনুগ্রহ করে একটি সঠিক সংখ্যা দিন।", balance_update_failed: "ব্যালেন্স আপডেট করতে সমস্যা হয়েছে: {message}", balance_update_success: "ব্যালেন্স সফলভাবে আপডেট করা হয়েছে!", settings_save_success: "সেটিংস সফলভাবে সংরক্ষিত হয়েছে!", settings_save_failed: "সেটিংস সংরক্ষণ করতে সমস্যা হয়েছে: {message}", notification_sent_success: "নোটিফিকেশন সফলভাবে পাঠানো হয়েছে!", notification_removed: "নোটিফিকেশন সরানো হয়েছে।", notification_send_failed: "নোটিফিকেশন পাঠাতে সমস্যা হয়েছে: {message}", action_failed: "একটি সমস্যা হয়েছে।", password_reset_prompt: "পাসওয়ার্ড রিসেট করার জন্য আপনার ইমেইল এড্রেসটি দিন:", password_reset_success: "আপনার ইমেইলে পাসওয়ার্ড রিসেট করার জন্য একটি লিঙ্ক পাঠানো হয়েছে।", password_reset_fail: "পাসওয়ার্ড রিসেট লিঙ্ক পাঠাতে সমস্যা হয়েছে: {message}", delete_post_action: "পোস্ট ডিলিট করুন", copy_post_link_action: "লিঙ্ক কপি করুন", account_security: "অ্যাকাউন্ট ও নিরাপত্তা", current_password_placeholder: "বর্তমান পাসওয়ার্ড (পরিবর্তনের জন্য আবশ্যক)", confirm_password_placeholder: "নতুন পাসওয়ার্ড নিশ্চিত করুন", profile_update_success: "প্রোফাইল সফলভাবে আপডেট করা হয়েছে!", password_mismatch_error: "নতুন পাসওয়ার্ড দুটি মেলেনি।", reauth_required_error: "ইমেল বা পাসওয়ার্ড পরিবর্তন করতে, অনুগ্রহ করে আপনার বর্তমান পাসওয়ার্ড লিখুন।", reauth_failed_error: "বর্তমান পাসওয়ার্ডটি ভুল। অনুগ্রহ করে আবার চেষ্টা করুন।", people: "মানুষজন", find_people_title: "সবাইকে খুঁজুন", no_users_found: "কোনো ব্যবহারকারী পাওয়া যায়নি।", total_likes: "মোট লাইক", total_views: "মোট ভিউ", views_count: "{count} ভিউ", audience_select: "কারা দেখবে?", public: "পাবলিক", only_me: "শুধু আমি", hashtag_feed_title: "হ্যাশট্যাগ #{tag}", no_posts_with_hashtag: "এই হ্যাশট্যাগ দিয়ে কোনো পোস্ট পাওয়া যায়নি।", block_user: "ব্যবহারকারীকে ব্লক করুন", unblock_user: "ব্যবহারকারীকে আনব্লক করুন", user_blocked_message: "আপনি এই ব্যবহারকারীকে ব্লক করেছেন।", user_not_available_message: "এই ব্যবহারকারী উপলব্ধ নয়।", confirm_block: "আপনি কি নিশ্চিত যে {name}-কে ব্লক করতে চান?", confirm_unblock: "আপনি কি নিশ্চিত যে {name}-কে আনব্লক করতে চান?", mfa_title: "দুই-ধাপ যাচাইকরণ (2FA)", mfa_enroll_title: "2FA চালু করুন", mfa_enter_phone_code_prompt: "আপনার ফোনে পাঠানো ৬-সংখ্যার কোডটি দিন:", mfa_verification_code_placeholder: "যাচাইকরণ কোড", mfa_verify_button: "যাচাই করুন", mfa_phone_enroll_fail: "ফোন 2FA চালু করতে সমস্যা হয়েছে: {message}", mfa_phone_enroll_success: "ফোন 2FA সফলভাবে চালু হয়েছে।", mfa_login_prompt: "আপনার অ্যাকাউন্ট সুরক্ষিত। অনুগ্রহ করে যাচাইকরণ কোড দিন।", mfa_disable_prompt: "আপনি কি 2FA বন্ধ করতে চান?", mfa_phone_disable_success: "ফোন 2FA সফলভাবে বন্ধ করা হয়েছে।", mfa_phone_disable_fail: "ফোন 2FA বন্ধ করতে ব্যর্থ হয়েছে।", manage_2fa: "2FA ম্যানেজ করুন", manage_blocked_list: "ম্যানেজ ব্লক লিস্ট", blocked_users_title: "ব্লক করা ব্যবহারকারীদের তালিকা", unblock: "আনব্লক", no_blocked_users: "আপনি কাউকে ব্লক করেননি।", mfa_add_phone_prompt: "ফোন 2FA চালু করার জন্য, অনুগ্রহ করে প্রথমে আপনার প্রোফাইল এডিট করে একটি ফোন নম্বর যোগ করুন।", mfa_invalid_phone: "অনুগ্রহ করে একটি সঠিক ফোন নম্বর (+880...) প্রদান করুন।", enable_phone_2fa: "ফোন (SMS) 2FA চালু করুন", disable_phone_2fa: "ফোন (SMS) 2FA বন্ধ করুন", enable_totp_2fa: "Authenticator অ্যাপ 2FA চালু করুন", disable_totp_2fa: "Authenticator অ্যাপ 2FA বন্ধ করুন", mfa_scan_qr_prompt: "আপনার Authenticator অ্যাপ দিয়ে এই QR কোডটি স্ক্যান করুন অথবা নিচের সিক্রেট কী ব্যবহার করে ম্যানুয়ালি অ্যাকাউন্ট যোগ করুন। তারপর ভেরিফিকেশন কোডটি দিন।", mfa_enter_totp_code_prompt: "আপনার authenticator অ্যাপ থেকে পাওয়া ৬-সংখ্যার কোডটি দিন:", mfa_totp_enroll_success: "Authenticator অ্যাপ 2FA সফলভাবে চালু হয়েছে!", mfa_totp_enroll_fail: "Authenticator অ্যাপ 2FA চালু করতে সমস্যা হয়েছে: {message}", mfa_totp_disable_success: "Authenticator অ্যাপ 2FA সফলভাবে বন্ধ করা হয়েছে।", mfa_totp_disable_fail: "Authenticator অ্যাপ 2FA বন্ধ করতে ব্যর্থ হয়েছে।", select_2fa_method: "একটি 2FA পদ্ধতি বেছে নিন", phone_sms: "ফোন (এসএমএস)", authenticator_app: "Authenticator অ্যাপ", secret_key: "সিক্রেট কী", click_to_copy: "কপি করতে ক্লিক করুন", professional_mode: "প্রফেশনাল মোড", turn_on_professional_mode: "প্রফেশনাল মোড চালু করুন", turn_off_professional_mode: "প্রফেশনাল মোড বন্ধ করুন", professional_mode_on_success: "প্রফেশনাল মোড চালু হয়েছে!", professional_mode_off_success: "প্রফেশনাল মোড বন্ধ হয়েছে!", digital_creator: "ডিজিটাল ক্রিয়েটর", profile_category: "প্রোফাইল ক্যাটাগরি", professional_dashboard: "প্রফেশনাল ড্যাশবোর্ড", performance_overview: "পারফরম্যান্স ওভারভিউ", post_engagement: "পোস্ট এনগেজমেন্ট", view_dashboard: "ড্যাশবোর্ড দেখুন", managed_by_pro_mode: "ব্যবহারকারীর প্রফেশনাল মোড দ্বারা নিয়ন্ত্রিত",
            },
            en: {
                delete_comment: "Delete Comment", confirm_comment_delete: "Are you sure you want to delete this comment?", comment_deleted_success: "Comment deleted successfully.", comment_delete_fail: "Failed to delete comment.", games: "Games", add_game: "Add New Game", game_title: "Game Title", thumbnail_url: "Thumbnail URL", game_type: "Game Type", game_type_url: "URL", game_type_html: "HTML", game_content_url: "Enter Game URL", game_content_html: "Enter Game HTML Code", manage_games: "Game Management", no_games_found: "No games found.", add_new_game: "Add New Game", edit_game: "Edit Game", delete_game: "Delete Game", confirm_game_delete: "Are you sure you want to delete this game?", game_added_success: "Game added successfully!", game_updated_success: "Game updated successfully!", game_deleted_success: "Game deleted successfully!", game_op_failed: "Game operation failed.", add_friend: "Add Friend", friends: "Friends", cancel_request: "Cancel Request", respond_to_request: "Respond to Request", accept: "Accept", decline: "Decline", unfriend: "Unfriend", confirm_unfriend: "Are you sure you want to unfriend {name}?", friend_requests: "Friend Requests", no_friend_requests: "No new friend requests.", your_tools: "Your Tools", insights_at_a_glance: "Insights at a Glance", balance_and_history: "Balance & History", view_balance_details: "View your earnings and transaction history", monetization_locked: "Monetization Locked", admin_approval_needed: "Requires admin approval to unlock", reply: "Reply", liked_your_post: "<b>{name}</b> reacted to your post:", commented_on_your_post: "<b>{name}</b> commented on your post:", replied_to_your_comment: "<b>{name}</b> replied to your comment:", no_notifications: "You have no new notifications.", role_management: "Role Management", role: "Role", user_role: "User", admin_role: "Admin", superadmin_role: "Super Admin", change_role_success: "Successfully changed role for {name}.", change_role_fail: "Failed to change role.", cannot_change_own_role: "You cannot change your own role.", created_at: "Created At", user_id: "User ID", send_password_reset: "Send Password Reset", password_reset_sent_success: "Password reset link sent to {email}.", password_reset_sent_fail: "Failed to send password reset link.", admin_search_placeholder: "Search by name or email...", typing: "is typing...", send_gift: "Send Gift", gift_amount: "Gift Amount", gift_note: "Note (optional)", confirm_gift: "Are you sure you want to gift ৳{amount} to {name}?", insufficient_balance: "You do not have enough balance in your account.", gift_success: "Successfully gifted ৳{amount} to {name}!", gift_fail: "Failed to send gift.", reason_gift_sent: "Gift sent to {name}", reason_gift_received: "Gift received from {name}", gift_received_notification: "<b>{name}</b> sent you a gift of ৳{amount}!", next_steps: "Next steps", weekly_challenge: "Weekly challenge", weekly_challenge_remaining: "{percent}% remaining", continue_weekly_challenge: "Continue your weekly challenge!", requirements_left: "You have {count} requirements left to complete this week's challenge.", earn_reels_achievement: "Earn a Reels achievement", learn_reels_tools: "Find out how to earn achievements that help you explore the tools for creating reels.", insights: "Insights", last_28_days: "Last 28 days", great_job_views: "Great job, you had <strong>{count}</strong> views!", from_previous_28_days: "from previous 28 days", approximate_earnings: "Approximate earnings", engagement: "Engagement", net_followers: "Net followers", like: "Like", dislike: "Dislike", love: "Love", wow: "Wow", sad: "Sad", angry: "Angry", haha: "Haha", create_story: "Create Story", your_story: "Your Story", upload_story: "Upload Story", upload_story_prompt: "Select a video file (max 2 minutes):", error_story_duration: "Sorry, the video must be less than 2 minutes long.", story_upload_success: "Story uploaded successfully!", story_upload_fail: "Failed to upload story: {message}", no_stories_found: "No new stories from friends.", react_to_story: "React to Story", viewers: "Viewers ({count})", reactions_title: "Reactions", story_viewers_title: "Story Viewers", all: "All", no_reactions_yet: "No reactions yet.", no_views_yet: "No views yet.", auth_subtitle: "Connect with friends and share with the world.", email_or_phone_placeholder: "Email or phone number", password_placeholder: "Password", login_button: "Log In", forgot_password: "Forgot password?", create_new_account_button: "Create New Account", home: "Home", videos: "Videos", notifications: "Notifications", messages: "Messages", profile: "Profile", admin_panel: "Admin Panel", balance: "Balance", logout: "Logout", settings: "Settings", language: "Language", theme: "Theme", light_theme: "Light", dark_theme: "Dark", contacts: "Contacts", search_users_placeholder: "Search users...", no_results_found: "No results found", whats_on_your_mind: "What's on your mind, {name}?", no_posts_found: "No posts found in this section.", no_videos_found: "No video posts found.", user_not_found: "User not found.", account_suspended: "This account has been suspended.", edit_profile: "Edit Profile", follow: "Follow", following: "Following", message: "Message", posts: "Posts", followers: "Followers", following_count: "Following", intro: "Intro", name: "Name", email: "Email", phone: "Phone", application_or_request: "Application or Request", copy: "Copy", copied: "Copied!", no_posts_by_user: "This user hasn't made any posts yet.", comment: "Comment", comments: "{count} Comments", write_a_comment: "Write a comment...", user_suspended_alert: "Your account has been suspended.", new_user_bio: "I'm a new user!", relationship_single: "Single", with_person: "{status} with", balance_history: "History", balance_with_currency: "Balance: $", profile_link: "Profile Link", admin_panel_users: "Admin Panel - Users", unverify: "Unverify", verify: "Verify", remove_monetization: "Remove Monetization", monetize: "Monetize", manage_balance: "Balance", unsuspend: "Unsuspend", suspend: "Suspend", global_notification: "Global Notification", send_notification_placeholder: "Send a notification to all users...", send_notification: "Send Notification", monetization_settings: "Monetization Settings", reactions_per_balance: "Reactions per Balance (How many?)", balance_amount: "Balance Amount (How much?)", save_settings: "Save Settings", no_messages: "You have no messages.", write_a_message: "Write a message...", no_messages_yet: "No messages yet.", new_post: "New Post", whats_in_your_mind: "What's in your mind...", upload_media: "Upload Photo/Video:", post_button: "Post", cancel: "Cancel", signup: "Sign Up", signup_subtitle: "It's quick and easy.", full_name: "Your full name", new_password: "New password", edit_profile_title: "Edit Profile", bio: "Bio", write_about_yourself: "Write something about yourself...", relationship_status: "Relationship Status", partner_username: "Partner's Username (e.g., @username)", profile_picture: "Profile Picture", cover_photo: "Cover Photo", save: "Save", manage_balance_for: "Manage Balance for '{name}'", current_balance: "Current Balance", set_new_balance: "Set new balance", balance_history_title: "Balance History", date: "Date", reason: "Reason", amount: "Amount", new_balance: "New Balance", reason_reaction: "Reaction Milestone Bonus", reason_admin: "Admin Update", reason_unknown: "Unknown Reason", no_transaction_history: "No transaction history found.", close: "Close", error_generic: "Sorry, an error occurred.", error_post_delete: "Failed to delete post: {message}", confirm_post_delete: "Are you sure you want to delete this post?", error_login: "Incorrect email or password.", fill_all_fields: "Please fill in all fields.", registration_failed: "Registration failed: {message}", post_creation_failed: "Failed to create post: {message}", profile_update_failed: "Failed to update profile: {message}", invalid_number: "Please enter a valid number.", balance_update_failed: "Failed to update balance: {message}", balance_update_success: "Balance updated successfully!", settings_save_success: "Settings saved successfully!", settings_save_failed: "Failed to save settings: {message}", notification_sent_success: "Notification sent successfully!", notification_removed: "Notification has been removed.", notification_send_failed: "Failed to send notification: {message}", action_failed: "An error occurred.", password_reset_prompt: "Enter your email address to reset your password:", password_reset_success: "A password reset link has been sent to your email.", password_reset_fail: "Failed to send password reset link: {message}", delete_post_action: "Delete Post", copy_post_link_action: "Copy Link", account_security: "Account & Security", current_password_placeholder: "Current Password (required for changes)", confirm_password_placeholder: "Confirm new password", profile_update_success: "Profile updated successfully!", password_mismatch_error: "The new passwords do not match.", reauth_required_error: "To change email or password, please enter your current password.", reauth_failed_error: "Incorrect current password. Please try again.", people: "People", find_people_title: "Find People", no_users_found: "No users found.", total_likes: "Total Likes", total_views: "Total Views", views_count: "{count} views", audience_select: "Who can see this?", public: "Public", only_me: "Only Me", hashtag_feed_title: "Hashtag #{tag}", no_posts_with_hashtag: "No posts found with this hashtag.", block_user: "Block User", unblock_user: "Unblock User", user_blocked_message: "You have blocked this user.", user_not_available_message: "This user is not available.", confirm_block: "Are you sure you want to block {name}?", confirm_unblock: "Are you sure you want to unblock {name}?", mfa_title: "Two-Factor Authentication (2FA)", mfa_enroll_title: "Enable 2FA", mfa_enter_phone_code_prompt: "Enter the 6-digit code sent to your phone:", mfa_verification_code_placeholder: "Verification Code", mfa_verify_button: "Verify", mfa_phone_enroll_fail: "Failed to enable Phone 2FA: {message}", mfa_phone_enroll_success: "Phone 2FA enabled successfully.", mfa_login_prompt: "Your account is protected. Please enter the verification code.", mfa_disable_prompt: "Are you sure you want to disable 2FA?", mfa_phone_disable_success: "Phone 2FA has been disabled.", mfa_phone_disable_fail: "Failed to disable Phone 2FA.", manage_2fa: "Manage 2FA", manage_blocked_list: "Manage Block List", blocked_users_title: "List of Blocked Users", unblock: "Unblock", no_blocked_users: "You haven't blocked anyone.", mfa_add_phone_prompt: "To enable Phone 2FA, please add a phone number to your profile first.", mfa_invalid_phone: "Please provide a valid phone number (+880...)", enable_phone_2fa: "Enable Phone (SMS) 2FA", disable_phone_2fa: "Disable Phone (SMS) 2FA", enable_totp_2fa: "Enable Authenticator App 2FA", disable_totp_2fa: "Disable Authenticator App 2FA", mfa_scan_qr_prompt: "Scan this QR code with your authenticator app, or add the account manually using the secret key below. Then enter the verification code.", mfa_enter_totp_code_prompt: "Enter the 6-digit code from your authenticator app:", mfa_totp_enroll_success: "Authenticator App 2FA enabled successfully!", mfa_totp_enroll_fail: "Failed to enable Authenticator App 2FA: {message}", mfa_totp_disable_success: "Authenticator App 2FA disabled successfully.", mfa_totp_disable_fail: "Failed to disable Authenticator App 2FA.", select_2fa_method: "Choose a 2FA method", phone_sms: "Phone (SMS)", authenticator_app: "Authenticator App", secret_key: "Secret Key", click_to_copy: "Click to copy", professional_mode: "Professional Mode", turn_on_professional_mode: "Turn on Professional Mode", turn_off_professional_mode: "Turn off Professional Mode", professional_mode_on_success: "Professional Mode has been turned on!", professional_mode_off_success: "Professional Mode has been turned off!", digital_creator: "Digital Creator", profile_category: "Profile Category", professional_dashboard: "Professional Dashboard", performance_overview: "Performance Overview", post_engagement: "Post Engagement", view_dashboard: "View Dashboard", managed_by_pro_mode: "Managed by user's Professional Mode",
            }
        };

        const _t = (key, params = {}) => {
            let text = translations[currentLang]?.[key] || translations['en']?.[key] || key;
            for (const param in params) {
                text = text.replace(`{${param}}`, params[param]);
            }
            return text;
        };
        
        const bengaliToEnglishMap = { 'অ': 'o', 'আ': 'a', 'ই': 'i', 'ঈ': 'i', 'উ': 'u', 'ঊ': 'u', 'ঋ': 'ri', 'এ': 'e', 'ঐ': 'oi', 'ও': 'o', 'ঔ': 'ou', 'ক': 'k', 'খ': 'kh', 'গ': 'g', 'ঘ': 'gh', 'ঙ': 'ng', 'চ': 'ch', 'ছ': 'chh', 'জ': 'j', 'ঝ': 'jh', 'ঞ': 'n', 'ট': 't', 'ঠ': 'th', 'ড': 'd', 'ঢ': 'dh', 'ণ': 'n', 'ত': 't', 'থ': 'th', 'দ': 'd', 'ধ': 'dh', 'ন': 'n', 'প': 'p', 'ফ': 'f', 'ব': 'b', 'ভ': 'bh', 'ম': 'm', 'য': 'j', 'র': 'r', 'ল': 'l', 'শ': 'sh', 'ষ': 'sh', 'স': 's', 'হ': 'h', 'ড়': 'r', 'ঢ়': 'rh', 'য়': 'y', 'া': 'a', 'ি': 'i', 'ী': 'i', 'ু': 'u', 'ূ': 'u', 'ৃ': 'ri', 'ে': 'e', 'ৈ': 'oi', 'ো': 'o', 'ৌ': 'ou', 'ং': 'ng', 'ঃ': 'h', 'ঁ': 'n', '্': '', '০': '0', '১': '1', '২': '2', '৩': '3', '৪': '4', '৫': '5', '৬': '6', '৭': '7', '৮': '8', '৯': '9' };
        function transliterateBengaliToEnglish(text) {
            if (!text) return '';
            let simplifiedResult = '';
            for (const char of text) { simplifiedResult += bengaliToEnglishMap[char] || char; }
            return simplifiedResult.trim().toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-');
        }

        async function generateUniqueSlug(name, uid) {
            let baseSlug = transliterateBengaliToEnglish(name);
            if (!baseSlug) { baseSlug = name.trim().toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-'); }
            if (!baseSlug) { baseSlug = `user-${uid.slice(-6)}`; }
            let finalSlug = baseSlug;
            let counter = 2;
            while (true) {
                const slugSnap = await db.ref('usernameSlugs').child(finalSlug).once('value');
                if (!slugSnap.exists() || slugSnap.val() === uid) {
                    return finalSlug;
                }
                finalSlug = `${baseSlug}-${counter}`;
                counter++;
            }
        }


        const settingsModule = {
            init: () => {
                const savedLang = localStorage.getItem('mediaBookLang') || 'bn';
                const savedTheme = localStorage.getItem('mediaBookTheme') || 'light';
                settingsModule.setLanguage(savedLang, true);
                settingsModule.setTheme(savedTheme);
            },
            setLanguage: (lang, isInitial = false) => {
                currentLang = lang;
                localStorage.setItem('mediaBookLang', lang);
                document.documentElement.lang = lang;
                settingsModule.applyAllTranslations();
                if (currentUser && !isInitial) {
                    const currentUserId = document.querySelector('[data-view="profile"].active')?.dataset.userid || currentUser.uid;
                    uiModule.showView(currentView, { userId: currentUserId });
                }
            },
            setTheme: (theme) => {
                currentTheme = theme;
                localStorage.setItem('mediaBookTheme', theme);
                document.body.classList.remove('light-theme', 'dark-theme');
                document.body.classList.add(`${theme}-theme`);
            },
            applyAllTranslations: () => {
                document.querySelectorAll('[data-lang-key]').forEach(el => { el.textContent = _t(el.dataset.langKey); });
                document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => { el.placeholder = _t(el.dataset.langPlaceholderKey); });
                document.querySelectorAll('[data-lang-title-key]').forEach(el => { el.title = _t(el.dataset.langTitleKey); });
            }
        };

        const authModule = {
            init: () => {
                settingsModule.init();
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible'
                });
                
                auth.onAuthStateChanged(async user => {
                    const splashScreen = document.getElementById('splash-screen');
                    
                    if (user) {
                        setTimeout(async () => {
                            splashScreen.style.opacity = '0';
                            await user.reload();
                            authModule.handleUserLogin(user);
                            setTimeout(() => splashScreen.classList.add('hidden'), 500);
                        }, 1500);
                    } else {
                        splashScreen.style.opacity = '0';
                        setTimeout(() => {
                            splashScreen.classList.add('hidden');
                            uiModule.showAuth();
                        }, 500);
                    }

                    if(userDbListener) userDbListener.off(); 
                    if(activeChatListener) activeChatListener.off();
                    if(activeTypingListener) { activeTypingListener.off(); activeTypingListener = null; }
                    if(friendRequestDbListener) friendRequestDbListener.off();
                    if(unreadNotificationsListener) unreadNotificationsListener.off();

                    if (!user) {
                         currentUser = null; currentUserData = {}; blockedUserIds.clear();
                    }
                });
            },
            handleUserLogin: async (user) => {
                currentUser = user;
                const initialSnap = await db.ref('users/' + user.uid).once('value');
                if (initialSnap.exists() && initialSnap.val().isSuspended) { alert(_t('user_suspended_alert')); authModule.logout(); return; }
                
                await dbModule.getBlockedUserIds();
                const userData = initialSnap.val() || {};
                currentUserData = { 
                    uid: user.uid, 
                    isAdmin: (userData.role === 'admin' || userData.role === 'superadmin'), 
                    ...userData 
                };
                
                uiModule.showApp(); 
                dbModule.cacheAllUsers(); // Cache all users on login
                dbModule.cacheMentionableUsers();
                uiModule.initSearchBars();
                
                const path = window.location.pathname;
                const pathParts = path.split('/').filter(Boolean);

                let targetView = currentUserData.isAdmin ? 'admin' : 'feed';
                let params = {};

                if (pathParts.length > 0 && path !== '/') {
                     if (pathParts[0] === 'post' && pathParts[1]) {
                        targetView = 'feed';
                    } else {
                        const slug = decodeURIComponent(pathParts[0]);
                        const slugSnap = await db.ref('usernameSlugs').child(slug).once('value');
                        if (slugSnap.exists()) {
                            targetView = 'profile';
                            params.userId = slugSnap.val();
                        }
                    }
                }
                
                await uiModule.showView(targetView, params, false); 
                
                 if (targetView === 'feed' && pathParts[0] === 'post' && pathParts[1]) {
                    uiModule.showPostDetailModal(pathParts[1]);
                 }
                
                if(userDbListener) userDbListener.off();
                userDbListener = db.ref('users/' + user.uid).on('value', liveSnap => { 
                    if (liveSnap.exists() && liveSnap.val().isSuspended) { 
                        alert(_t('user_suspended_alert')); 
                        authModule.logout(); 
                        return; 
                    } 
                    const newUserData = liveSnap.val() || {};
                    currentUserData = { 
                        uid: user.uid, 
                        isAdmin: (newUserData.role === 'admin' || newUserData.role === 'superadmin'),
                        ...newUserData 
                    }; 
                    uiModule.updateUserDataInUI(currentUserData); 
                });
                
                if(unreadNotificationsListener) unreadNotificationsListener.off();
                const unreadNotifRef = db.ref(`notifications/${currentUser.uid}`).orderByChild('isRead').equalTo(false);
                unreadNotificationsListener = unreadNotifRef.on('value', snap => {
                    const count = snap.numChildren();
                    const badge = document.getElementById('notification-badge');
                    const sidebarBadge = document.getElementById('sidebar-notification-badge');
                    if (count > 0) {
                         badge.textContent = count;
                         sidebarBadge.textContent = count;
                         badge.classList.remove('hidden');
                         sidebarBadge.classList.remove('hidden');
                    } else {
                         badge.classList.add('hidden');
                         sidebarBadge.classList.add('hidden');
                    }
                });


            },
            register: async (name, email, phone, pass) => { 
                const cred = await auth.createUserWithEmailAndPassword(email, pass); 
                await cred.user.updateProfile({ displayName: name }); 
                const slug = await generateUniqueSlug(name, cred.user.uid);
                const userRole = (email === ADMIN_EMAIL) ? 'superadmin' : 'user';
                const newUser = { 
                    uid: cred.user.uid, name, email, phone, usernameSlug: slug, 
                    bio: _t('new_user_bio'), photoURL: 'https://i.ibb.co/6y2Yx3p/profile.png', 
                    coverPhotoURL: 'https://i.ibb.co/pwnL1Ww/cover.jpg', 
                    relationshipStatus: _t('relationship_single'), relationshipWith: '', 
                    createdAt: firebase.database.ServerValue.TIMESTAMP, 
                    isVerified: (email === ADMIN_EMAIL), 
                    role: userRole,
                    isMonetized: false, balance: 0, isSuspended: false, 
                    totalPostLikes: 0, totalVideoViews: 0, 
                    isProfessionalMode: false, profileCategory: '' 
                }; 
                const updates = {};
                updates[`/users/${cred.user.uid}`] = newUser;
                updates[`/usernameSlugs/${slug}`] = cred.user.uid;
                return db.ref().update(updates);
            },
            login: async (email, pass) => {
                try {
                    await auth.signInWithEmailAndPassword(email, pass);
                } catch (error) {
                    if (error.code === 'auth/multi-factor-auth-required') {
                        mfaResolver = error.resolver;
                        const hint = error.resolver.hints[0];
                        mfaHint = hint; 
                        if (hint.factorId === firebase.auth.PhoneAuthProvider.PROVIDER_ID) {
                            const phoneProvider = new firebase.auth.PhoneAuthProvider(auth);
                            try {
                                mfaVerificationId = await phoneProvider.verifyPhoneNumber({
                                    multiFactorHint: hint,
                                    session: mfaResolver.session
                                }, window.recaptchaVerifier);
                                uiModule.showMfaVerificationModal();
                            } catch (e) {
                                console.error("2FA SMS sending failed:", e);
                                alert(_t('mfa_phone_enroll_fail', {message: e.message}));
                            }
                        } else if (hint.factorId === firebase.auth.TotpMultiFactorGenerator.FACTOR_ID) {
                            uiModule.showMfaVerificationModal();
                        } else {
                            console.error("Unsupported 2FA factor:", hint.factorId);
                            document.getElementById('authError').textContent = _t('error_generic');
                        }
                    } else {
                        console.error("Login error:", error);
                        document.getElementById('authError').textContent = _t('error_login');
                    }
                }
            }, logout: () => auth.signOut(), resetPassword: (email) => auth.sendPasswordResetEmail(email),
            normalizePhoneNumber: (phone) => {
                if (!phone || typeof phone !== 'string') return null;
                let cleaned = phone.replace(/\D/g, '');
                if (cleaned.startsWith('880') && cleaned.length === 13) {
                    return `+${cleaned}`;
                }
                if (cleaned.startsWith('0') && cleaned.length === 11) {
                    return `+88${cleaned}`;
                }
                return null;
            }
        };
        
        const dbModule = {
            getGames: async () => {
                const snap = await db.ref('games').once('value');
                return snap.exists() ? Object.entries(snap.val()).map(([id, data]) => ({ id, ...data })) : [];
            },
            getGame: async (gameId) => {
                const snap = await db.ref(`games/${gameId}`).once('value');
                return snap.exists() ? { id: snap.key, ...snap.val() } : null;
            },
            addGame: async (gameData) => {
                return db.ref('games').push(gameData);
            },
            updateGame: async (gameId, gameData) => {
                return db.ref(`games/${gameId}`).update(gameData);
            },
            deleteGame: async (gameId) => {
                return db.ref(`games/${gameId}`).remove();
            },
            
            uploadFile: (f,p) => storage.ref(`${p}/${Date.now()}_${f.name}`).put(f).then(s=>s.ref.getDownloadURL()),
            createPost: async (t, f, audience = 'public') => { let mU=null,mT=null; if(f){mU=await dbModule.uploadFile(f,'posts');mT=f.type.startsWith('video')?'video':'image';} const pD={text:t,mediaUrl:mU,mediaType:mT,user:{uid:currentUser.uid,name:currentUserData.name,photoURL:currentUserData.photoURL||null, role: currentUserData.role || 'user', isVerified: currentUserData.isVerified || false},time:firebase.database.ServerValue.TIMESTAMP, audience: audience, viewCount: 0}; const newPostRef = await db.ref('posts').push(pD); await dbModule.updateHashtagsForPost(newPostRef.key, t); return newPostRef;},
            deletePost: async (pId) => { const pS=await db.ref(`posts/${pId}`).once('value'); if(!pS.exists())return; const pD=pS.val(); if(pD.mediaUrl){try{await storage.refFromURL(pD.mediaUrl).delete();}catch(e){console.warn("Storage delete failed:",e.message);}} await dbModule.updateHashtagsForPost(pId, pD.text, true); const u={};u[`/posts/${pId}`]=null;u[`/postReactions/${pId}`]=null;u[`/postComments/${pId}`]=null;u[`/notifications`].orderByChild('postId').equalTo(pId).remove(); return db.ref().update(u);},
            
            getFeedPosts: async () => {
                const s = await db.ref('posts').orderByChild('time').limitToLast(50).once('value');
                if (!s.exists()) return [];
                let posts = Object.entries(s.val()).map(([id, d]) => ({ id, ...d }));
                posts.sort((a, b) => b.time - a.time); 

                const friendsSnap = await db.ref(`friends/${currentUser.uid}`).once('value');
                const friendsSet = new Set(Object.keys(friendsSnap.val() || {}));
                const followingSnap = await db.ref(`following/${currentUser.uid}`).once('value');
                const followingSet = new Set(Object.keys(followingSnap.val() || {}));
                
                const visibilityCheckPromises = posts.map(async (post) => {
                    if (!post || !post.user || blockedUserIds.has(post.user.uid)) {
                        return null;
                    }
                    const postAudience = post.audience || 'public';
                    if (post.user.uid === currentUser.uid) { return post; }
                    if (postAudience === 'public') { return post; }
                    if (postAudience === 'only_me') { return null; }
                    const postAuthorSnap = await db.ref(`users/${post.user.uid}`).once('value');
                    if (!postAuthorSnap.exists()) { return null; }
                    const postAuthorData = postAuthorSnap.val();
                    if (postAuthorData.isProfessionalMode) { return followingSet.has(post.user.uid) ? post : null;
                    } else { return friendsSet.has(post.user.uid) ? post : null; }
                });
                const visiblePosts = await Promise.all(visibilityCheckPromises);
                return visiblePosts.filter(Boolean);
            },

            getPostsByUser: async (uId) => {const s=await db.ref('posts').orderByChild('user/uid').equalTo(uId).once('value');return Object.entries(s.val()||{}).map(([id,d])=>({id,...d})).sort((a,b)=>b.time-a.time);},
            getVideoPosts: async () => { const s = await db.ref('posts').orderByChild('mediaType').equalTo('video').once('value'); if (!s.exists()) return []; let posts = Object.entries(s.val()).map(([id, d]) => ({ id, ...d })); for (let i = posts.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [posts[i], posts[j]] = [posts[j], posts[i]]; } return posts; },
            searchUsers: async (query) => { if (!query) return []; return allUsersCache.filter(u => u.uid !== currentUser.uid && !blockedUserIds.has(u.uid) && (u.name.toLowerCase().includes(query.toLowerCase()) || (u.email && u.email.toLowerCase().includes(query.toLowerCase()))) ).slice(0, 10); },
            reactToPost: async(pId,oId,rT)=>{
                await db.ref(`postReactions/${pId}/${currentUser.uid}`).set({type:rT}); 
                db.ref(`users/${oId}/totalPostLikes`).transaction(currentLikes => (currentLikes || 0) + 1); 
                
                if (oId === currentUser.uid) {
                    return; 
                }

                const postSnap = await db.ref(`posts/${pId}`).once('value');
                const postData = postSnap.val();
                
                dbModule.createNotification(oId, {
                    type: 'like', fromUser: {uid: currentUser.uid, name: currentUserData.name, photoURL: currentUserData.photoURL},
                    postId: pId, postTextSnippet: postData.text.substring(0, 50)
                });
                
                const oS=await db.ref(`users/${oId}`).once('value'); 
                if(!oS.exists()||!oS.val().isMonetized)return; 
                
                const rS=await db.ref(`postReactions/${pId}`).once('value');
                const rC=rS.numChildren(); 
                const sS=await db.ref('appSettings').once('value');
                const sets=sS.val()||{likesToBalanceRatio:10,balancePerMilestone:1}; 
                
                if(rC>0&&rC%sets.likesToBalanceRatio===0){
                    await dbModule.incrementUserBalance(oId,sets.balancePerMilestone,'reaction_milestone');
                }
            },
            removeReaction: async (pId, oId) => {
                db.ref(`users/${oId}/totalPostLikes`).transaction(currentLikes => (currentLikes || 1) - 1);

                const [ownerSnap, settingsSnap, reactionsSnap] = await Promise.all([
                    db.ref(`users/${oId}`).once('value'),
                    db.ref('appSettings').once('value'),
                    db.ref(`postReactions/${pId}`).once('value')
                ]);

                const reactionsCountBefore = reactionsSnap.numChildren();
                const isMonetized = ownerSnap.exists() && ownerSnap.val().isMonetized;

                await db.ref(`postReactions/${pId}/${currentUser.uid}`).remove();

                if (isMonetized && reactionsCountBefore > 0) {
                    const settings = settingsSnap.val() || { likesToBalanceRatio: 10, balancePerMilestone: 1 };
                    
                    if (reactionsCountBefore % settings.likesToBalanceRatio === 0) {
                        await dbModule.incrementUserBalance(oId, -settings.balancePerMilestone, 'reaction_milestone'); 
                    }
                }
            },
            logVideoView: (postId, ownerId) => { db.ref(`posts/${postId}/viewCount`).transaction(currentViews => (currentViews || 0) + 1); db.ref(`users/${ownerId}/totalVideoViews`).transaction(currentViews => (currentViews || 0) + 1); },
            addComment:async(pId, t, parentId = null)=>{
                const cD={text:t,user:{uid:currentUser.uid,name:currentUserData.name,photoURL:currentUserData.photoURL||null, role: currentUserData.role || 'user', isVerified: currentUserData.isVerified || false},time:firebase.database.ServerValue.TIMESTAMP, parentId: parentId};
                const newCommentRef = await db.ref(`postComments/${pId}`).push(cD);
                
                const postSnap = await db.ref(`posts/${pId}`).once('value');
                const postData = postSnap.val();
                const postOwnerId = postData.user.uid;

                if (parentId) {
                    const parentCommentSnap = await db.ref(`postComments/${pId}/${parentId}`).once('value');
                    const parentCommentData = parentCommentSnap.val();
                    const parentCommentOwnerId = parentCommentData.user.uid;
                    if(parentCommentOwnerId !== currentUser.uid) {
                         dbModule.createNotification(parentCommentOwnerId, { type: 'reply', fromUser: {uid: currentUser.uid, name: currentUserData.name, photoURL: currentUserData.photoURL}, postId: pId, commentText: t });
                    }
                    if (postOwnerId !== currentUser.uid && postOwnerId !== parentCommentOwnerId) {
                         dbModule.createNotification(postOwnerId, { type: 'comment', fromUser: {uid: currentUser.uid, name: currentUserData.name, photoURL: currentUserData.photoURL}, postId: pId, commentText: t });
                    }
                } else {
                    if(postOwnerId !== currentUser.uid) {
                        dbModule.createNotification(postOwnerId, { type: 'comment', fromUser: {uid: currentUser.uid, name: currentUserData.name, photoURL: currentUserData.photoURL}, postId: pId, commentText: t });
                    }
                }
                return newCommentRef;
            },
            deleteComment: async (postId, commentId) => {
                // First, recursively delete all replies to this comment
                const repliesSnap = await db.ref(`postComments/${postId}`).orderByChild('parentId').equalTo(commentId).once('value');
                if (repliesSnap.exists()) {
                    const replyDeletions = [];
                    repliesSnap.forEach(replySnap => {
                        replyDeletions.push(dbModule.deleteComment(postId, replySnap.key));
                    });
                    await Promise.all(replyDeletions);
                }
                // Finally, delete the comment itself
                return db.ref(`postComments/${postId}/${commentId}`).remove();
            },
            cacheAllUsers: async () => {
                const snap = await db.ref('users').once('value');
                allUsersCache = snap.exists() ? Object.values(snap.val()) : [];
            },
            getAllUsers: () => { // Modified to use cache
                return allUsersCache;
            },
            cacheMentionableUsers: async () => {
                const [followingSnap, friendsSnap] = await Promise.all([
                    db.ref(`following/${currentUser.uid}`).once('value'),
                    db.ref(`friends/${currentUser.uid}`).once('value')
                ]);
                const followingIds = Object.keys(followingSnap.val() || {});
                const friendIds = Object.keys(friendsSnap.val() || {});
                const allIds = [...new Set([...followingIds, ...friendIds])];
                const userPromises = allIds.map(id => db.ref(`users/${id}`).once('value'));
                const userSnaps = await Promise.all(userPromises);
                mentionableUsersCache = userSnaps.map(s => s.val()).filter(Boolean).filter(u => !blockedUserIds.has(u.uid));
            },
            followUser:(uId)=>{const u={};u[`/follows/${uId}/${currentUser.uid}`]=true;u[`/following/${currentUser.uid}/${uId}`]=true;return db.ref().update(u).then(dbModule.cacheMentionableUsers);},
            unfollowUser:(uId)=>{const u={};u[`/follows/${uId}/${currentUser.uid}`]=null;u[`/following/${currentUser.uid}/${uId}`]=null;return db.ref().update(u).then(dbModule.cacheMentionableUsers);},
            sendFriendRequest: (recipientId) => db.ref(`friend_requests/${recipientId}/${currentUser.uid}`).set(true),
            cancelFriendRequest: (recipientId) => db.ref(`friend_requests/${recipientId}/${currentUser.uid}`).remove(),
            acceptFriendRequest: (senderId) => {
                const updates = {};
                updates[`/friends/${currentUser.uid}/${senderId}`] = true;
                updates[`/friends/${senderId}/${currentUser.uid}`] = true;
                updates[`/friend_requests/${currentUser.uid}/${senderId}`] = null;
                return db.ref().update(updates).then(dbModule.cacheMentionableUsers);
            },
            declineFriendRequest: (senderId) => db.ref(`friend_requests/${currentUser.uid}/${senderId}`).remove(),
            unfriendUser: (friendId) => {
                const updates = {};
                updates[`/friends/${currentUser.uid}/${friendId}`] = null;
                updates[`/friends/${friendId}/${currentUser.uid}`] = null;
                return db.ref().update(updates).then(dbModule.cacheMentionableUsers);
            },
            toggleUserVerification:(uId,cS)=>db.ref(`users/${uId}`).update({isVerified:!cS}),
            toggleUserMonetization:(uId,cS)=>db.ref(`users/${uId}`).update({isMonetized:!cS}),
            toggleUserSuspension:(uId,cS)=>db.ref(`users/${uId}`).update({isSuspended:!cS}),
            setUserRole: (uId, role) => db.ref(`users/${uId}/role`).set(role),
            incrementUserBalance:(uId,a,t='unknown')=>{return db.ref(`users/${uId}/balance`).transaction(b=>(b||0)+a).then(r=>{if(r.committed)db.ref(`balanceHistory/${uId}`).push({type:t,amount:a,newBalance:r.snapshot.val(),timestamp:firebase.database.ServerValue.TIMESTAMP});});},
            updateUserBalanceByAdmin:async(uId,nB)=>{const s=await db.ref(`users/${uId}`).once('value');if(!s.exists())throw new Error('User not found.');await db.ref(`users/${uId}`).update({balance:nB});db.ref(`balanceHistory/${uId}`).push({type:'admin_update',amount:nB-(s.val().balance||0),newBalance:nB,timestamp:firebase.database.ServerValue.TIMESTAMP,adminId:currentUser.uid});},
            getBalanceHistory:async(uId)=>{const s=await db.ref(`balanceHistory/${uId}`).orderByChild('timestamp').once('value');if(!s.exists())return[];return Object.values(s.val()).sort((a,b)=>b.timestamp-a.timestamp);},
            updateAppSettings:(s)=>db.ref('appSettings').update(s),
            sendGlobalNotification:(t)=>db.ref('appSettings/globalNotification').set({text:t,timestamp:firebase.database.ServerValue.TIMESTAMP}),
            getChatId:(u1,u2)=>[u1,u2].sort().join('_'),
            sendMessage:async(rId,t)=>{if (blockedUserIds.has(rId)) { throw new Error("Cannot message a blocked user."); } const cId=dbModule.getChatId(currentUser.uid,rId);const m={senderId:currentUser.uid,text:t,time:firebase.database.ServerValue.TIMESTAMP};await db.ref(`chats/${cId}/messages`).push(m);const oS=await db.ref(`users/${rId}`).once('value');const oU=oS.val();const cI={lastMessage:t,lastUpdate:firebase.database.ServerValue.TIMESTAMP,p:{[currentUser.uid]:{name:currentUserData.name,photoURL:currentUserData.photoURL, isAdmin: currentUserData.isAdmin||false},[rId]:{name:oU.name,photoURL:oU.photoURL, isAdmin: oU.isAdmin||false, isVerified: oU.isVerified || false}}};await db.ref(`userChats/${currentUser.uid}/${cId}`).set(cI);await db.ref(`userChats/${rId}/${cId}`).set(cI);},
            getUserChats:async()=>{const s=await db.ref(`userChats/${currentUser.uid}`).orderByChild('lastUpdate').once('value');if (!s.exists()) return []; const chats = Object.entries(s.val()||{}).map(([id,d])=>({id,...d})); const filteredChats = chats.filter(chat => { const otherUserId = Object.keys(chat.p).find(uid => uid !== currentUser.uid); return otherUserId && !blockedUserIds.has(otherUserId); }); return filteredChats.sort((a,b)=>b.lastUpdate-a.lastUpdate);},
            extractHashtags: (text) => {
                if (!text) return [];
                const regex = /#([a-zA-Z0-9_]+)/g;
                const matches = text.match(regex);
                return matches ? matches.map(tag => tag.substring(1).toLowerCase()) : [];
            },
            updateHashtagsForPost: async (postId, text, isDeleting = false) => {
                const tags = dbModule.extractHashtags(text);
                if (tags.length === 0) return;
                const updates = {};
                tags.forEach(tag => { updates[`/hashtags/${tag}/${postId}`] = isDeleting ? null : true; });
                await db.ref().update(updates);
            },
            getPostsByHashtag: async (tag) => {
                const postIdsSnap = await db.ref(`hashtags/${tag.toLowerCase()}`).once('value'); if (!postIdsSnap.exists()) return [];
                const postIds = Object.keys(postIdsSnap.val());
                const postPromises = postIds.map(id => db.ref(`posts/${id}`).once('value'));
                const postSnaps = await Promise.all(postPromises);
                const posts = postSnaps.map(snap => ({ id: snap.key, ...snap.val() })).filter(post => post && post.user && !blockedUserIds.has(post.user.uid));
                return posts.sort((a,b) => b.time - a.time);
            },
            createNotification: (recipientId, data) => { const notifData = {...data, isRead: false, timestamp: firebase.database.ServerValue.TIMESTAMP}; return db.ref(`notifications/${recipientId}`).push(notifData); },
            getNotifications: async(userId) => { const s = await db.ref(`notifications/${userId}`).orderByChild('timestamp').limitToLast(50).once('value'); return s.exists() ? Object.entries(s.val()).map(([id,d])=>({id,...d})).sort((a,b)=>b.timestamp-a.timestamp) : []; },
            markNotificationsAsRead: (userId) => { db.ref(`notifications/${userId}`).orderByChild('isRead').equalTo(false).once('value', snap => { if(!snap.exists()) return; const updates = {}; snap.forEach(child => { updates[`${child.key}/isRead`] = true; }); db.ref(`notifications/${userId}`).update(updates); }); },

            getBlockedUserIds: async () => {
                blockedUserIds.clear(); if (!currentUser) return;
                const iBlockedSnap = await db.ref(`userBlocks/${currentUser.uid}`).once('value');
                if (iBlockedSnap.exists()) { Object.keys(iBlockedSnap.val()).forEach(uid => blockedUserIds.add(uid)); }
                const blockedMeSnap = await db.ref('userBlocks').orderByChild(currentUser.uid).equalTo(true).once('value');
                if (blockedMeSnap.exists()) { Object.keys(blockedMeSnap.val()).forEach(uid => blockedUserIds.add(uid)); }
            },
            blockUser: async (userIdToBlock) => { await db.ref(`userBlocks/${currentUser.uid}/${userIdToBlock}`).set(true); blockedUserIds.add(userIdToBlock); },
            unblockUser: async (userIdToUnblock) => { await db.ref(`userBlocks/${currentUser.uid}/${userIdToUnblock}`).remove(); await dbModule.getBlockedUserIds(); },
            getBlockedUsersList: async () => {
                const iBlockedSnap = await db.ref(`userBlocks/${currentUser.uid}`).once('value'); if (!iBlockedSnap.exists()) return [];
                const blockedIds = Object.keys(iBlockedSnap.val());
                const userPromises = blockedIds.map(uid => db.ref(`users/${uid}`).once('value'));
                const userSnaps = await Promise.all(userPromises);
                return userSnaps.map(snap => snap.val()).filter(Boolean);
            },
            
            createStory: async (file, duration) => {
                const mediaUrl = await dbModule.uploadFile(file, 'stories');
                const storyData = { userId: currentUser.uid, userName: currentUserData.name, userPhotoURL: currentUserData.photoURL, mediaUrl: mediaUrl, mediaType: 'video', duration: duration, timestamp: firebase.database.ServerValue.TIMESTAMP };
                return db.ref('stories').push(storyData);
            },
            getStories: async () => {
                const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
                const storiesSnap = await db.ref('stories').orderByChild('timestamp').startAt(twentyFourHoursAgo).once('value'); if (!storiesSnap.exists()) return [];
                const allStories = [];
                storiesSnap.forEach(snap => { allStories.push({ id: snap.key, ...snap.val() }); });
                const filteredStories = allStories.filter(story => !blockedUserIds.has(story.userId));
                return filteredStories.sort((a,b) => b.timestamp - a.timestamp);
            },
            reactToStory: (storyId, reactionType) => { return db.ref(`storyReactions/${storyId}/${currentUser.uid}`).set({ type: reactionType }); },
            markStoryAsViewed: (storyId) => { return db.ref(`stories/${storyId}/viewers/${currentUser.uid}`).set(true); },
            getPostReactors: async (postId) => {
                const reactionsSnap = await db.ref(`postReactions/${postId}`).once('value'); if (!reactionsSnap.exists()) return [];
                const reactions = reactionsSnap.val();
                const userPromises = Object.keys(reactions).map(uid => db.ref(`users/${uid}`).once('value'));
                const userSnaps = await Promise.all(userPromises);
                return userSnaps.map(snap => { if (!snap.exists()) return null; const user = snap.val(); return { ...user, reactionType: reactions[user.uid].type }; }).filter(Boolean);
            },
            getStoryViewersAndReactors: async (storyId) => {
                const storySnap = await db.ref(`stories/${storyId}`).once('value'); if (!storySnap.exists()) return [];
                const viewers = storySnap.val().viewers || {};
                const reactionsSnap = await db.ref(`storyReactions/${storyId}`).once('value'); const reactions = reactionsSnap.val() || {};
                const userIds = Object.keys(viewers);
                const userPromises = userIds.map(uid => db.ref(`users/${uid}`).once('value'));
                const userSnaps = await Promise.all(userPromises);
                return userSnaps.map(snap => { if (!snap.exists()) return null; const user = snap.val(); return { ...user, reactionType: reactions[user.uid]?.type || null }; }).filter(Boolean);
            },
            sendGift: (recipientId, amount, note) => {
                const senderId = currentUser.uid;
                if (senderId === recipientId) return Promise.reject(new Error("You cannot gift yourself."));
                
                return db.ref('users').transaction(allUsers => {
                    if (allUsers) {
                        const sender = allUsers[senderId];
                        const recipient = allUsers[recipientId];

                        if (!sender || !recipient) { return; }
                        
                        const senderBalance = sender.balance || 0;
                        if (senderBalance < amount) { return; }

                        allUsers[senderId].balance = senderBalance - amount;
                        allUsers[recipientId].balance = (recipient.balance || 0) + amount;
                    }
                    return allUsers;
                }).then(async (result) => {
                    if (!result.committed) {
                        throw new Error(_t('insufficient_balance'));
                    }
                    const newSenderBalance = result.snapshot.child(`${senderId}/balance`).val();
                    const newRecipientBalance = result.snapshot.child(`${recipientId}/balance`).val();
                    const timestamp = firebase.database.ServerValue.TIMESTAMP;
                    
                    const historyUpdates = {};
                    historyUpdates[`/balanceHistory/${senderId}/${db.ref().push().key}`] = {
                        type: 'gift_sent', amount: -amount, newBalance: newSenderBalance,
                        timestamp: timestamp, recipientId: recipientId, recipientName: result.snapshot.child(`${recipientId}/name`).val(), note: note
                    };
                    historyUpdates[`/balanceHistory/${recipientId}/${db.ref().push().key}`] = {
                        type: 'gift_received', amount: amount, newBalance: newRecipientBalance,
                        timestamp: timestamp, senderId: senderId, senderName: currentUserData.name, note: note
                    };
                    await db.ref().update(historyUpdates);

                    await dbModule.createNotification(recipientId, {
                        type: 'gift',
                        fromUser: { uid: senderId, name: currentUserData.name, photoURL: currentUserData.photoURL },
                        amount: amount
                    });

                    return { success: true };
                });
            },
        };

        const uiModule = {
            showLoader: (s) => loader.classList.toggle('hidden', !s),
            showApp: async () => { document.getElementById('app-wrapper').classList.remove('hidden'); document.getElementById('auth-page-container').classList.add('hidden'); uiModule.updateUserDataInUI(currentUserData); await uiModule.renderContacts(); uiModule.initGlobalNotificationListener(); if(window.innerWidth <= 768) { document.getElementById('mobile-search-container').style.display='none'; document.getElementById('desktop-header-icons').style.display='none'; } adsterraModule.renderSidebarAd('sidebar-ad-container'); },
            showAuth: () => { document.getElementById('app-wrapper').classList.add('hidden'); document.getElementById('auth-page-container').classList.remove('hidden'); document.getElementById('authError').textContent = ''; currentView = 'feed'; },
            updateUserDataInUI: (d) => { if (!d) return; const role = d.role || 'user'; let roleIcon = ''; if (role === 'superadmin') roleIcon = '👑'; else if (role === 'admin') roleIcon = '🛡️'; uiModule.renderAvatar(document.getElementById('sidebar-avatar'),d); document.getElementById('sidebar-name').innerHTML = `${d.name}${uiModule.getVerifiedBadgeHTML(d.isVerified)} <span class="admin-badge">${roleIcon}</span>`; document.getElementById('admin-panel-btn').classList.toggle('hidden', !d.isAdmin); document.getElementById('dropdown-admin-btn').classList.toggle('hidden', !d.isAdmin); document.getElementById('balance-menu-item').classList.toggle('hidden', !d.isMonetized); if(d.isMonetized) document.getElementById('user-balance').textContent = (d.balance||0).toFixed(2); document.getElementById('dashboard-btn').classList.toggle('hidden', !d.isProfessionalMode); document.getElementById('dropdown-dashboard-btn').classList.toggle('hidden', !d.isProfessionalMode);},
            showView: async (vN, p = {}, pushState = true) => {
                if (activeChatListener) { activeChatListener.off(); activeChatListener = null; }
                if (activeTypingListener) { activeTypingListener.off(); activeTypingListener = null; }
                if (typingTimeout) clearTimeout(typingTimeout);
                if (currentView === 'chat' && currentUser) {
                    const lastChatUserId = document.querySelector('.chat-header')?.closest('.chat-container')?.querySelector('.message-form')?.dataset.receiverid;
                    if(lastChatUserId) {
                        const chatId = dbModule.getChatId(currentUser.uid, lastChatUserId);
                        db.ref(`typingStatus/${chatId}/${currentUser.uid}`).remove();
                    }
                }
                
                currentView = vN;

                document.querySelectorAll('.bottom-nav-item').forEach(el=>el.classList.remove('active'));
                const activeNavItem = document.querySelector(`.bottom-nav-item[data-view="${vN}"]`);
                if(activeNavItem) activeNavItem.classList.add('active');

                document.querySelectorAll('.header-icon, .menu-item[data-view], .logo-m').forEach(el=>el.classList.remove('active'));
                const pUId = p.userId || currentUser.uid;
                document.querySelectorAll(`[data-view="${vN}"]`).forEach(el=>{if(vN==='profile'){if(el.id==='my-profile-btn'&&pUId===currentUser.uid)el.classList.add('active');}else{el.classList.add('active');}});
                
                const mC = document.getElementById('main-content'); mC.innerHTML = ''; uiModule.showLoader(true);
                
                let targetView = vN, params = p;
                if (pushState) {
                    let url = `/${vN}`;
                    if (vN === 'profile' && p.userId) {
                        const userSnap = await db.ref(`users/${p.userId}`).once('value');
                        const userSlug = userSnap.val()?.usernameSlug;
                        url = userSlug ? `/${userSlug}` : `/${vN}/${p.userId}`;
                    } else if (vN === 'hashtag' && p.tag) {
                        url = `/${vN}/${p.tag}`;
                    } else if (vN === 'game-player' && p.gameId) {
                        url = `/games/${p.gameId}`;
                    }
                    history.pushState({ view: vN, params: p }, '', url);
                }

                try {
                    const viewMap = { 
                        feed: uiModule.renderFeed, 
                        videos: uiModule.renderVideos, 
                        profile: uiModule.renderProfile, 
                        admin: uiModule.renderAdminPanel, 
                        inbox: uiModule.renderInbox, 
                        chat: uiModule.renderChat, 
                        people: uiModule.renderUserDirectory, 
                        hashtag: uiModule.renderHashtagFeed, 
                        dashboard: uiModule.renderDashboard, 
                        notifications: uiModule.renderNotifications,
                        games: uiModule.renderGamesView,
                        'game-player': uiModule.renderGamePlayer
                    };
                    if (vN === 'notifications') { await dbModule.markNotificationsAsRead(currentUser.uid); }
                    await (viewMap[vN] || uiModule.renderFeed)(mC, p.userId || p.gameId || currentUser.uid, p.tag);
                    document.querySelectorAll('.post[data-post-id]').forEach(uiModule.attachPostListeners);
                } catch (e) { console.error(`Error rendering view '${vN}':`, e); mC.innerHTML=`<div class="card" style="padding:20px;color:var(--error-color);"><strong>${_t('error_generic')}</strong><p>${e.message}</p></div>`; }
                finally { uiModule.showLoader(false); window.scrollTo(0, 0); }
            },
            initSearchBars: () => {
                const setupSearch = (inputId, resultsId) => {
                    const searchInput = document.getElementById(inputId);
                    if (!searchInput) return;
                    const searchResults = document.getElementById(resultsId);
                    let debounceTimeout;
                    searchInput.addEventListener('input', () => {
                        clearTimeout(debounceTimeout);
                        const query = searchInput.value.trim();
                        if (query.length < 1) { searchResults.style.display = 'none'; return; }
                        debounceTimeout = setTimeout(async () => { const users = await dbModule.searchUsers(query); uiModule.renderSearchResults(users, searchResults); }, 300);
                    });
                };
                setupSearch('header-search-input', 'search-results');
                setupSearch('header-search-input-mobile', 'search-results-mobile');
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#header-search-container') && !e.target.closest('#header-search-container-mobile')) {
                        const searchResults = document.getElementById('search-results');
                        if(searchResults) searchResults.style.display = 'none';
                        const searchResultsMobile = document.getElementById('search-results-mobile');
                        if(searchResultsMobile) searchResultsMobile.style.display = 'none';
                    }
                });
            },
            renderSearchResults: (users, container) => {
                if (users.length === 0) { container.innerHTML = `<div style="padding: 10px; text-align: center; color: var(--secondary-text-color);">${_t('no_results_found')}</div>`; } else {
                    container.innerHTML = users.map(user => { const role = user.role || 'user'; let roleIcon = ''; if (role === 'superadmin') roleIcon = '👑'; else if (role === 'admin') roleIcon = '🛡️'; return `<div class="search-result-item" data-view="profile" data-userid="${user.uid}"><div class="avatar" id="search-avatar-${container.id}-${user.uid}"></div><span>${user.name}${uiModule.getVerifiedBadgeHTML(user.isVerified)}<span class="admin-badge">${roleIcon}</span></span></div>`; }).join('');
                    users.forEach(user => uiModule.renderAvatar(container.querySelector(`#search-avatar-${container.id}-${user.uid}`), user));
                }
                container.style.display = 'block';
            },
            renderFeed: async (c) => { 
                c.innerHTML=`<div id="story-reel-container" class="card"></div><div class="card create-post-card"><div class="avatar" id="create-post-avatar" data-view="profile"></div><button id="post-input-placeholder" class="input">${_t('whats_on_your_mind', {name: currentUserData.name})}</button></div><div class="card ad-placeholder" id="feed-top-banner-ad" style="padding:16px; margin-bottom:16px;"></div><div id="posts-feed"></div>`; 
                adsterraModule.renderFeedTopBanner('feed-top-banner-ad');
                adsterraModule.loadSocialAdScript();
                uiModule.renderAvatar(document.getElementById('create-post-avatar'), currentUserData); 
                uiModule.renderStoryReel();
                const p = await dbModule.getFeedPosts();
                const pf=document.getElementById('posts-feed');
                if(p.length > 0){
                    pf.innerHTML=p.map(uiModule.createPostElement).join('');
                    p.forEach(post => {if(post.id)adsterraModule.renderPostBannerAd(`ad-container-${post.id}`);});
                } else {
                    pf.innerHTML=`<div class="card" style="padding:20px; text-align:center;">${_t('no_posts_found')}</div>`;
                } 
            },
            renderVideos: async (c) => { 
                c.innerHTML=`<h2 style="padding-left:10px;">${_t('videos')}</h2><div id="video-feed"></div>`;
                const p = await dbModule.getVideoPosts();
                const filteredPosts = p.filter(post => post && post.user && !blockedUserIds.has(post.user.uid) && (post.audience === 'public'));
                const vfc=c.querySelector('#video-feed');
                if(filteredPosts.length>0){
                    vfc.innerHTML=filteredPosts.map(uiModule.createPostElement).join('');
                    filteredPosts.forEach(post => {if(post.id)adsterraModule.renderPostBannerAd(`ad-container-${post.id}`);});
                }else{
                    vfc.innerHTML=`<div class="card" style="padding:20px; text-align:center;">${_t('no_videos_found')}</div>`;
                }
            },
            renderProfile: async (c, uId) => {
                if (blockedUserIds.has(uId)) {
                    const iBlockedThem = (await db.ref(`userBlocks/${currentUser.uid}/${uId}`).once('value')).exists();
                    const message = iBlockedThem ? _t('user_blocked_message') : _t('user_not_available_message');
                    c.innerHTML = `<div class="card" style="padding:20px; text-align:center;">${message}</div>`;
                    return;
                }
                const uS = await db.ref(`users/${uId}`).once('value'); if (!uS.exists()) { c.innerHTML=`<div class="card" style="padding:20px;">${_t('user_not_found')}</div>`; return; }
                const uD = uS.val(); if (uD.isSuspended && uId !== currentUser.uid) { c.innerHTML=`<div class="card" style="padding:20px; text-align:center;">${_t('account_suspended')}</div>`; return; }
                const iMP = uId === currentUser.uid;
                const role = uD.role || 'user'; let roleIcon = ''; if (role === 'superadmin') roleIcon = '👑'; else if (role === 'admin') roleIcon = '🛡️';
                const isBlockedByMe = (await db.ref(`userBlocks/${currentUser.uid}/${uId}`).once('value')).exists();
                const blockButtonText = isBlockedByMe ? _t('unblock_user') : _t('block_user');
                const blockAction = isBlockedByMe ? 'unblock-user' : 'block-user';
                const blockMenu = `<li data-action="${blockAction}" data-userid="${uId}" data-username="${uD.name}"><i class="fa-solid fa-ban"></i> ${blockButtonText}</li>`;
                const moreMenu = !iMP ? `<div class="more-menu"><button class="btn secondary"><i class="fa-solid fa-ellipsis"></i></button><ul class="dropdown-menu">${blockMenu}</ul></div>` : `<div class="more-menu"><button class="btn secondary"><i class="fa-solid fa-ellipsis"></i></button><ul class="dropdown-menu"><li data-action="logout"><i class="fa-solid fa-right-from-bracket"></i> ${_t('logout')}</li></ul></div>`;
                let aBH = '';
                if(iMP){
                    const dashboardBtn = uD.isProfessionalMode ? `<button class="btn" data-view="dashboard"><i class="fa-solid fa-chart-line"></i> ${_t('view_dashboard')}</button>` : '';
                    aBH = `<button class="btn" data-action="edit-profile"><i class="fa-solid fa-pen"></i> ${_t('edit_profile')}</button>${dashboardBtn}${moreMenu}`;
                } else {
                    const [friendsSnap, sentRequestSnap, receivedRequestSnap] = await Promise.all([
                        db.ref(`friends/${currentUser.uid}/${uId}`).once('value'),
                        db.ref(`friend_requests/${uId}/${currentUser.uid}`).once('value'),
                        db.ref(`friend_requests/${currentUser.uid}/${uId}`).once('value')
                    ]);
                    const areFriends = friendsSnap.exists();
                    const sentRequest = sentRequestSnap.exists();
                    const receivedRequest = receivedRequestSnap.exists();
                    const [followsSnap, followingSnap] = await Promise.all([
                        db.ref(`follows/${uId}`).once('value'),
                        db.ref(`following/${currentUser.uid}/${uId}`).once('value')
                    ]);
                    const isFollowing = followsSnap.hasChild(currentUser.uid) || followingSnap.exists();

                    const canGift = currentUserData.isMonetized && (currentUserData.balance || 0) > 0;
                    const giftButton = canGift ? `<button class="btn secondary" data-action="send-gift" data-userid="${uId}" data-username="${uD.name}"><i class="fa-solid fa-gift"></i></button>` : '';

                    if (uD.isProfessionalMode) {
                        aBH = `<button class="btn ${isFollowing ? 'secondary' : ''}" data-action="${isFollowing ? 'unfollow' : 'follow'}" data-userid="${uId}"><i class="fa-solid ${isFollowing ? 'fa-check' : 'fa-user-plus'}"></i> ${isFollowing ? _t('following') : _t('follow')}</button>`;
                    } else {
                        if (areFriends) { aBH = `<div class="more-menu"><button class="btn secondary"><i class="fa-solid fa-user-check"></i> ${_t('friends')}</button><ul class="dropdown-menu"><li data-action="unfriend" data-userid="${uId}" data-username="${uD.name}"><i class="fa-solid fa-user-minus"></i> ${_t('unfriend')}</li></ul></div>`; }
                        else if (sentRequest) { aBH = `<button class="btn secondary" data-action="cancel-friend-request" data-userid="${uId}"><i class="fa-solid fa-user-clock"></i> ${_t('cancel_request')}</button>`; }
                        else if (receivedRequest) { aBH = `<button class="btn" data-view="notifications"><i class="fa-solid fa-user-group"></i> ${_t('respond_to_request')}</button>`; }
                        else { aBH = `<button class="btn" data-action="send-friend-request" data-userid="${uId}"><i class="fa-solid fa-user-plus"></i> ${_t('add_friend')}</button>`; }
                    }
                    aBH += `<button class="btn secondary" data-view="chat" data-userid="${uId}"><i class="fa-solid fa-comment-dots"></i></button>${giftButton}${moreMenu}`;
                }
                let rH = ''; const cVR = iMP || (uD.relationshipWith === currentUserData.name); if(cVR && uD.relationshipStatus && uD.relationshipStatus !== _t('relationship_single')){ rH = `<div class="intro-item"><i class="fa-solid fa-heart"></i><span><strong>${uD.relationshipStatus}</strong>${uD.relationshipWith ? ` ${_t('with_person', { status: uiModule.linkifyText(`@${uD.relationshipWith}`) })}` : ''}</span></div>`; }
                const bHB = iMP && uD.isMonetized ? `<button class="btn small" data-action="view-balance-history" style="margin-left:auto;">${_t('balance_history')}</button>` : '';
                const profileLink = `${BASE_URL}/${uD.usernameSlug || encodeURIComponent(uD.name)}`;
                const pIH = iMP ? `<div class="intro-item"><i class="fa-solid fa-envelope"></i><span>${_t('email')}: ${uD.email}</span></div><div class="intro-item"><i class="fa-solid fa-phone"></i><span>${_t('phone')}: ${uD.phone || 'N/A'}</span></div>${rH}${uD.isMonetized ? `<div class="intro-item"><i class="fa-solid fa-dollar-sign"></i><span>${_t('balance_with_currency')}<strong>${(uD.balance||0).toFixed(2)}</strong></span>${bHB}</div>`:''}<div class="intro-item"><i class="fa-solid fa-file-signature"></i><a href="https://mediabookpaymentmethodadd.blogspot.com" target="_blank" rel="noopener noreferrer">${_t('application_or_request')}</a></div><hr><div class="intro-item"><i class="fa-solid fa-link"></i><span id="profile-link-text">${profileLink}</span><button class="btn small" data-action="copy-profile-link" data-link="${profileLink}" style="margin-left:auto;">${_t('copy')}</button></div>` : rH;
                const followerSnap = await db.ref(`follows/${uId}`).once('value');
                const followingSnap = await db.ref(`following/${uId}`).once('value');
                const friendsSnap = await db.ref(`friends/${uId}`).once('value');
                const followerCount = uD.isProfessionalMode ? followerSnap.numChildren() : friendsSnap.numChildren();
                const followingCount = uD.isProfessionalMode ? followingSnap.numChildren() : 0;
                const profileStatsHTML = `<span id="follower-count"><strong>${followerCount}</strong> ${uD.isProfessionalMode ? _t('followers') : _t('friends')}</span> ${uD.isProfessionalMode ? `<span id="following-count"><strong>${followingCount}</strong> ${_t('following_count')}</span>` : ''} <span><strong>${uD.totalPostLikes || 0}</strong> ${_t('total_likes')}</span> <span><strong>${uD.totalVideoViews || 0}</strong> ${_t('total_views')}</span>`;
                const categoryHTML = uD.isProfessionalMode && uD.profileCategory ? `<p class="profile-category">${uD.profileCategory}</p>` : '';
                c.innerHTML=`<div class="main-content-profile-grid"><div class="profile-header-container"><div class="profile-cover" style="background-image:url(${uD.coverPhotoURL||''})"></div><div class="profile-details-wrapper"><div class="profile-details-bar"><div class="profile-avatar-container"><div id="profile-page-avatar" class="avatar profile-avatar-large"></div></div><div class="profile-info-actions-wrapper"><div class="profile-info"><h1>${uD.name}${uiModule.getVerifiedBadgeHTML(uD.isVerified)}<span class="admin-badge">${roleIcon}</span> ${uD.isSuspended?'<span style="color:var(--error-color);font-size:16px;">(Suspended)</span>':''}</h1>${categoryHTML}<div class="profile-stats">${profileStatsHTML}</div></div><div class="profile-actions">${aBH}</div></div></div><nav class="profile-nav"><div class="profile-nav-item active">${_t('posts')}</div></nav></div></div><div class="profile-body"><div class="profile-body-left"><div class="card profile-intro-card"><h3>${_t('intro')}</h3><p>${uiModule.linkifyText(uD.bio||'')}</p><hr><div class="intro-item"><i class="fa-solid fa-user"></i><span>${_t('name')}: <strong>${uD.name}${uiModule.getVerifiedBadgeHTML(uD.isVerified)}<span class="admin-badge">${roleIcon}</span></strong></span></div>${pIH}</div></div><div class="profile-body-right">${iMP?`<div class="card create-post-card"><div class="avatar" id="profile-create-post-avatar" data-view="profile"></div><button id="post-input-placeholder" class="input">${_t('whats_on_your_mind', { name: '' })}</button></div>`:''}<div id="profile-posts-feed"></div></div></div></div>`;
                uiModule.renderAvatar(document.getElementById('profile-page-avatar'),uD,true); if(iMP)uiModule.renderAvatar(document.getElementById('profile-create-post-avatar'),currentUserData);
                const p = await dbModule.getPostsByUser(uId);
                const pC=document.getElementById('profile-posts-feed');
                if(p.length>0){
                    pC.innerHTML=p.map(uiModule.createPostElement).join('');
                    p.forEach(post=>{if(post.id)adsterraModule.renderPostBannerAd(`ad-container-${post.id}`);});
                } else {
                    pC.innerHTML=`<div class="card" style="padding:20px;text-align:center;">${_t('no_posts_by_user')}</div>`;
                }
            },
            renderUserDirectory: async (c) => {
                const allUsers = dbModule.getAllUsers();
                const [friendsSnap, followingSnap, sentRequestsSnap] = await Promise.all([
                    db.ref(`friends/${currentUser.uid}`).once('value'),
                    db.ref(`following/${currentUser.uid}`).once('value'),
                    db.ref(`friend_requests`).orderByChild(currentUser.uid).equalTo(true).once('value')
                ]);
                const friendsSet = new Set(Object.keys(friendsSnap.val() || {}));
                const followingSet = new Set(Object.keys(followingSnap.val() || {}));
                const sentRequestsSet = new Set(Object.keys(sentRequestsSnap.val() || {}));

                const filteredUsers = allUsers.filter(user => user.uid !== currentUser.uid && !user.isSuspended && !blockedUserIds.has(user.uid));
                
                let usersHtml;
                if(filteredUsers.length > 0) {
                    usersHtml = filteredUsers.map(user => {
                        const role = user.role || 'user'; let roleIcon = ''; if (role === 'superadmin') roleIcon = '👑'; else if (role === 'admin') roleIcon = '🛡️';
                        let actionButton;
                        if (user.isProfessionalMode) {
                            const isFollowing = followingSet.has(user.uid);
                            actionButton = `<button class="btn full-width ${isFollowing ? 'secondary' : ''}" data-action="${isFollowing ? 'unfollow' : 'follow'}" data-userid="${user.uid}"><i class="fa-solid ${isFollowing ? 'fa-check' : 'fa-user-plus'}"></i> ${isFollowing ? _t('following') : _t('follow')}</button>`;
                        } else {
                            if (friendsSet.has(user.uid)) { actionButton = `<button class="btn full-width secondary" disabled><i class="fa-solid fa-user-check"></i> ${_t('friends')}</button>`; }
                            else if (sentRequestsSet.has(user.uid)) { actionButton = `<button class="btn full-width secondary" data-action="cancel-friend-request" data-userid="${user.uid}"><i class="fa-solid fa-user-clock"></i> ${_t('cancel_request')}</button>`; }
                            else { actionButton = `<button class="btn full-width" data-action="send-friend-request" data-userid="${user.uid}"><i class="fa-solid fa-user-plus"></i> ${_t('add_friend')}</button>`; }
                        }
                        return `
                        <div class="card user-directory-card">
                            <div class="avatar" id="dir-avatar-${user.uid}" data-view="profile" data-userid="${user.uid}"></div>
                            <div class="user-directory-card-name" data-view="profile" data-userid="${user.uid}">${user.name}${uiModule.getVerifiedBadgeHTML(user.isVerified)}<span class="admin-badge">${roleIcon}</span></div>
                            <div class="user-directory-card-actions">
                                ${actionButton}
                            </div>
                        </div>`;
                    }).join('');
                } else { usersHtml = `<div class="card" style="padding:20px; text-align:center; grid-column: 1 / -1;">${_t('no_users_found')}</div>`; }
                
                c.innerHTML = ` <h2 style="padding-left:10px;">${_t('find_people_title')}</h2> <div id="user-directory-grid">${usersHtml}</div> `;
                
                filteredUsers.forEach(user => uiModule.renderAvatar(c.querySelector(`#dir-avatar-${user.uid}`), user));
            },
            renderContacts: async()=>{const l=document.getElementById('contacts-list');if(!l)return; const u = dbModule.getAllUsers();l.innerHTML='';u.forEach(user=>{if(user.uid===currentUser.uid||user.isSuspended||blockedUserIds.has(user.uid))return; const role = user.role || 'user'; let roleIcon = ''; if (role === 'superadmin') roleIcon = '👑'; else if (role === 'admin') roleIcon = '🛡️'; const i=document.createElement('div');i.className='menu-item';i.dataset.view='chat';i.dataset.userid=user.uid;i.innerHTML=`<div class="avatar" id="contact-avatar-${user.uid}"></div><span>${user.name}${uiModule.getVerifiedBadgeHTML(user.isVerified)}<span class="admin-badge">${roleIcon}</span></span>`;l.appendChild(i);uiModule.renderAvatar(i.querySelector('.avatar'),user);});},
            linkifyText: (text) => {
                if (!text) return '';
                let linkedText = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
                linkedText = linkedText.replace(/@([a-zA-Z0-9_]+)/g, `<a href="#" class="mention-link" data-username="$1">@$1</a>`);
                linkedText = linkedText.replace(/#([a-zA-Z0-9_]+)/g, `<a href="#" class="hashtag-link" data-view="hashtag" data-tag="$1">#$1</a>`);
                return linkedText;
            },
            createPostElement: (p) => {
                if (!p?.user?.name) return '';
                const isAdminOrOwner = currentUserData.isAdmin || p.user.uid === currentUser.uid;
                const deleteMenu = isAdminOrOwner ? `<li data-action="delete-post" data-postid="${p.id}"><i class="fa-solid fa-trash"></i> ${_t('delete_post_action')}</li>` : '';
                const dropdownMenu = `<div class="post-actions-menu"><i class="fa-solid fa-ellipsis"></i><ul class="dropdown-menu"><li data-action="copy-post-link" data-postid="${p.id}"><i class="fa-solid fa-link"></i> ${_t('copy_post_link_action')}</li>${deleteMenu}</ul></div>`;
                const mH=p.mediaUrl?(p.mediaType==='video'?`<video src="${p.mediaUrl}" class="post-media" controls playsinline></video>`:`<img src="${p.mediaUrl}" class="post-media">`):'';
                const locale = currentLang === 'bn' ? 'bn-BD' : 'en-US';
                const postUserRole = p.user.role || 'user'; let roleIcon = ''; if (postUserRole === 'superadmin') roleIcon = '👑'; else if (postUserRole === 'admin') roleIcon = '🛡️';
                const audienceIcon = {'public': 'fa-globe-asia', 'followers': 'fa-user-friends', 'only_me': 'fa-lock'}[p.audience || 'public'];
                const viewCountHTML = (p.mediaType === 'video' && p.viewCount > 0) ? `<span class="post-views">${_t('views_count', {count: p.viewCount})}</span>` : '';
                return `<div class="card post" data-post-id="${p.id}" data-ownerid="${p.user.uid}"><div class="post-header"><div class="avatar" id="post-avatar-${p.id}"></div><div class="post-header-info" data-view="profile" data-userid="${p.user.uid}"><strong>${p.user.name}${uiModule.getVerifiedBadgeHTML(p.user.isVerified)}<span class="admin-badge">${roleIcon}</span></strong><br><small>${new Date(p.time).toLocaleString(locale)} <i class="fas ${audienceIcon} post-audience-icon"></i></small></div>${dropdownMenu}</div><div class="post-content">${uiModule.linkifyText(p.text)}</div>${mH}<div class="post-stats"><div class="post-stats-left reactions-display" data-action="show-reactions" data-postid="${p.id}"></div><div class="post-stats-right"><span class="comments-count"></span>${viewCountHTML}</div></div><div class="post-actions"><div class="reaction-button-container"><button class="btn flat reaction-btn" data-action="react-post"><i class="fa-regular fa-thumbs-up"></i> ${_t('like')}</button><div class="reaction-popup"><span class="reaction" data-reaction-type="like">${reactionEmojis.like}</span><span class="reaction" data-reaction-type="love">${reactionEmojis.love}</span><span class="reaction" data-reaction-type="haha">${reactionEmojis.haha}</span><span class="reaction" data-reaction-type="wow">${reactionEmojis.wow}</span><span class="reaction" data-reaction-type="sad">${reactionEmojis.sad}</span><span class="reaction" data-reaction-type="angry">${reactionEmojis.angry}</span></div></div><button class="btn flat" data-action="focus-comment"><i class="fa-regular fa-comment"></i> ${_t('comment')}</button></div><div class="ad-placeholder" id="ad-container-${p.id}"></div><div class="post-comments"><div class="comments-list"></div><div class="comment-form-wrapper"><div class="mention-suggestions"></div><form class="comment-form" data-action="add-comment"><div class="avatar" id="comment-form-avatar-${p.id}" data-view="profile" data-userid="${currentUser.uid}"></div><input class="input" type="text" placeholder="${_t('write_a_comment')}" required><button type="submit" class="btn small"><i class="fa-solid fa-paper-plane"></i></button></form></div></div></div>`;
            },
            attachPostListeners: (pE) => {
                const pId=pE.dataset.postId; if(!pId) return;
                const ownerId = pE.dataset.ownerid;

                db.ref(`posts/${pId}/user`).once('value',s=>{if(s.exists())uiModule.renderAvatar(pE.querySelector(`#post-avatar-${pId}`),s.val());});
                uiModule.renderAvatar(pE.querySelector(`#comment-form-avatar-${pId}`),currentUserData);

                const videoEl = pE.querySelector('video.post-media');
                if (videoEl) { videoEl.addEventListener('play', () => { if (videoEl.dataset.viewLogged !== 'true') { videoEl.dataset.viewLogged = 'true'; dbModule.logVideoView(pId, ownerId); } }, { once: true }); }

                db.ref(`postReactions/${pId}`).on('value',s=>{ const r=s.val()||{},c=s.numChildren(),b=pE.querySelector('.reaction-btn'),d=pE.querySelector('.reactions-display');b.className='btn flat reaction-btn';b.innerHTML=`<i class="fa-regular fa-thumbs-up"></i> ${_t('like')}`;if(c>0){const cs={};for(const uid in r){const t=r[uid].type;cs[t]=(cs[t]||0)+1;}const sr=Object.keys(cs).sort((a,b)=>cs[b]-cs[a]);let h='';sr.slice(0,3).forEach(t=>{const e=reactionEmojis[t];if(e)h+=`<span class="reaction-icon">${e}</span>`;});d.innerHTML=`${h}<span>${c}</span>`;}else{d.innerHTML='';}if(r[currentUser.uid]){const myR=r[currentUser.uid].type,rt=_t(myR),re=reactionEmojis[myR];b.classList.add('active',myR);b.innerHTML=`<span style="font-size:1.2em; vertical-align:middle; margin-right:4px;">${re}</span> ${rt}`;}});
                
                db.ref(`postComments/${pId}`).orderByChild('time').on('value',s=>{
                    const cl=pE.querySelector('.comments-list'); cl.innerHTML='';
                    pE.querySelector('.comments-count').textContent=_t('comments', {count: s.numChildren()});
                    if(!s.exists()) return;

                    const allComments = {};
                    s.forEach(cs => { allComments[cs.key] = { id: cs.key, ...cs.val() }; });

                    const commentTree = {}; const topLevelComments = [];
                    Object.values(allComments).forEach(c => {
                        if (c.parentId) {
                            if (!commentTree[c.parentId]) commentTree[c.parentId] = [];
                            commentTree[c.parentId].push(c);
                        } else { topLevelComments.push(c); }
                    });
                    
                    const createCommentElement = (c, isReply = false) => {
                        if (blockedUserIds.has(c.user.uid)) return '';
                        const role = c.user.role || 'user'; let roleIcon = ''; if (role === 'superadmin') roleIcon = '👑'; else if (role === 'admin') roleIcon = '🛡️';
                        const canDelete = currentUserData.isAdmin || c.user.uid === currentUser.uid;
                        const deleteButton = canDelete ? `<i class="fa-solid fa-trash comment-delete-btn" data-action="delete-comment" data-postid="${pId}" data-commentid="${c.id}" title="${_t('delete_comment')}"></i>` : '';
                        
                        return `
                        <div class="comment-item-wrapper" id="comment-${c.id}">
                            <div class="comment-item">
                                <div class="avatar" data-view="profile" data-userid="${c.user.uid}"></div>
                                <div class="comment-bubble">
                                    <strong>${c.user.name}${uiModule.getVerifiedBadgeHTML(c.user.isVerified)}<span class="admin-badge">${roleIcon}</span></strong>
                                    <br>${uiModule.linkifyText(c.text)}
                                    ${deleteButton}
                                </div>
                            </div>
                            <div class="comment-actions">
                                <span class="reply-btn" data-action="show-reply-form" data-comment-id="${c.id}">${_t('reply')}</span>
                            </div>
                            <div class="comment-replies" id="replies-for-${c.id}"></div>
                            <div class="reply-form-container" id="reply-form-for-${c.id}"></div>
                        </div>`;
                    };

                    topLevelComments.sort((a,b) => a.time - b.time).forEach(c => {
                        cl.insertAdjacentHTML('beforeend', createCommentElement(c));
                        uiModule.renderAvatar(cl.querySelector(`#comment-${c.id} .avatar`), c.user);
                        const repliesContainer = cl.querySelector(`#replies-for-${c.id}`);
                        if (commentTree[c.id]) {
                            commentTree[c.id].sort((a,b) => a.time - b.time).forEach(reply => {
                                repliesContainer.insertAdjacentHTML('beforeend', createCommentElement(reply, true));
                                uiModule.renderAvatar(repliesContainer.querySelector(`#comment-${reply.id} .avatar`), reply.user);
                            });
                        }
                    });
                });
                
                const cI=pE.querySelector('.comment-form .input');cI.addEventListener('input',(e)=>uiModule.handleMentionInput(e.target));cI.addEventListener('keydown',(e)=>{if(e.key==='Escape'){const sB=e.target.closest('.comment-form-wrapper').querySelector('.mention-suggestions');if(sB)sB.style.display='none';}});
            },
            renderAdminPanel: async(c)=>{
                await dbModule.cacheAllUsers();
                const s=await db.ref('appSettings').once('value');
                const sets=s.val()||{likesToBalanceRatio:10,balancePerMilestone:1};
                c.innerHTML=`
                    <div class="card" style="padding:0;">
                        <h2 style="padding:16px 16px 0;">${_t('admin_panel_users')}</h2>
                        <div id="admin-panel-controls"> <input class="input" type="text" id="adminUserSearch" placeholder="${_t('admin_search_placeholder')}"> </div>
                        <div id="user-list-admin"></div>
                    </div>
                    <div class="card"><h3 style="padding:16px 16px 0;">${_t('manage_games')}</h3><div id="admin-games-manager"></div></div>
                    <div class="card"><h3 style="padding:16px 16px 0;">${_t('global_notification')}</h3><form id="notification-form"><textarea class="textarea" id="notificationText" placeholder="${_t('send_notification_placeholder')}" required></textarea><button type="submit" class="btn primary full-width">${_t('send_notification')}</button></form></div>
                    <div class="card"><h3 style="padding:16px 16px 0;">${_t('monetization_settings')}</h3><form id="monetization-settings-form"><div><label for="likesRatio">${_t('reactions_per_balance')}</label><input id="likesRatio" type="number" class="input" value="${sets.likesToBalanceRatio}"></div><div><label for="balanceAmount">${_t('balance_amount')}</label><input id="balanceAmount" type="number" step="0.01" class="input" value="${sets.balancePerMilestone}"></div><button type="submit" class="btn success" style="grid-column:1/-1;">${_t('save_settings')}</button></form></div>`;
                
                document.getElementById('adminUserSearch').addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const filteredUsers = allUsersCache.filter(u => u.name.toLowerCase().includes(query) || u.email.toLowerCase().includes(query));
                    uiModule.renderAdminUserList(filteredUsers);
                });
                uiModule.renderAdminUserList(allUsersCache);
                uiModule.renderAdminGamesManager(document.getElementById('admin-games-manager'));
            },
            renderAdminUserList: (users) => {
                const userListContainer = document.getElementById('user-list-admin'); if (!userListContainer) return;
                const sortedUsers = users.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));
                userListContainer.innerHTML = sortedUsers.map(user => {
                    const role = user.role || 'user';
                    const roleTextKey = {'superadmin': 'superadmin_role', 'admin': 'admin_role', 'user': 'user_role'}[role];
                    const roleText = _t(roleTextKey);
                    const vbc=user.isVerified?'danger':'success',vbt=user.isVerified?_t('unverify'):_t('verify');
                    const sbc=user.isSuspended?'success':'danger',sbt=user.isSuspended?_t('unsuspend'):_t('suspend');
                    const mbc = user.isMonetized ? 'danger' : 'success';
                    const mbt = user.isMonetized ? _t('remove_monetization') : _t('monetize');
                    const isSuperAdmin = currentUserData.role === 'superadmin';
                    const canChangeRole = isSuperAdmin && user.role !== 'superadmin';
                    const roleSelector = `<select class="select" data-action="change-role" data-userid="${user.uid}" ${!canChangeRole ? 'disabled' : ''}> <option value="user" ${role === 'user' ? 'selected' : ''}>${_t('user_role')}</option> <option value="admin" ${role === 'admin' ? 'selected' : ''}>${_t('admin_role')}</option> </select>`;
                    return`<div class="admin-user-card">
                        <div class="admin-user-header">
                            <div class="avatar" id="admin-avatar-${user.uid}" data-view="profile" data-userid="${user.uid}"></div>
                            <div class="admin-user-info"> <strong>${user.name}${uiModule.getVerifiedBadgeHTML(user.isVerified)} <span class="role-badge ${role}">${roleText}</span></strong> <small>${user.email}</small> </div>
                        </div>
                        <div class="admin-user-details"> <b>${_t('user_id')}:</b> <span>${user.uid}</span> <b>${_t('created_at')}:</b> <span>${new Date(user.createdAt).toLocaleDateString()}</span> <b>${_t('profile_link')}:</b> <a href="/${user.usernameSlug}" target="_blank" data-view="profile" data-userid="${user.uid}">/${user.usernameSlug}</a> </div>
                        <div class="admin-user-actions">
                            ${isSuperAdmin ? roleSelector : ''}
                            <button class="btn small" data-action="manage-balance" data-userid="${user.uid}" data-username="${user.name}" data-currentbalance="${user.balance||0}">${_t('manage_balance')}</button>
                            <button class="btn small" data-action="send-password-reset" data-user-email="${user.email}">${_t('send_password_reset')}</button>
                            <button class="btn small ${sbc}" data-action="toggle-suspend" data-userid="${user.uid}" data-currentstate="${user.isSuspended||false}">${sbt}</button>
                            <button class="btn small ${vbc}" data-action="toggle-verify" data-userid="${user.uid}" data-currentstate="${user.isVerified}">${vbt}</button>
                            <button class="btn small ${mbc}" data-action="toggle-monetize" data-userid="${user.uid}" data-currentstate="${user.isMonetized}">${mbt}</button>
                        </div>
                    </div>`;
                }).join('');
                users.forEach(user=>{uiModule.renderAvatar(document.getElementById(`admin-avatar-${user.uid}`),user);});
            },
            renderInbox: async(c)=>{const ch=await dbModule.getUserChats();if(ch.length===0){c.innerHTML=`<div class="card" style="padding:20px;text-align:center;">${_t('no_messages')}</div>`;return;}let h=ch.map(chat=>{const oId=Object.keys(chat.p).find(uid=>uid!==currentUser.uid);if(!oId)return'';const oU=chat.p[oId];const role = oU.role || 'user'; let roleIcon = ''; if (role === 'superadmin') roleIcon = '👑'; else if (role === 'admin') roleIcon = '🛡️'; return`<div class="inbox-item" data-view="chat" data-userid="${oId}"><div class="avatar" id="inbox-avatar-${oId}"></div><div class="inbox-item-details"><strong>${oU.name}${uiModule.getVerifiedBadgeHTML(oU.isVerified)}<span class="admin-badge">${roleIcon}</span></strong><p class="last-message">${chat.lastMessage}</p></div></div><div class="ad-placeholder" id="ad-container-inbox-${chat.id}"></div>`;}).join('');c.innerHTML=`<div class="card" style="padding:8px;"><h2 style="padding:8px 8px 0;">${_t('messages')}</h2>${h}</div>`;ch.forEach(chat=>{const oId=Object.keys(chat.p).find(uid=>uid!==currentUser.uid);if(oId){uiModule.renderAvatar(document.getElementById(`inbox-avatar-${oId}`),chat.p[oId]);adsterraModule.renderPostBannerAd(`ad-container-inbox-${chat.id}`);}});},
            renderChat: async(c,oId)=>{
                if (blockedUserIds.has(oId)) { uiModule.showView('inbox'); alert(_t('user_not_available_message')); return; }
                try {
                    const oS=await db.ref(`users/${oId}`).once('value');
                    if (!oS.exists()) { c.innerHTML = `<div class="card" style="padding:20px;">User not found.</div>`; return; }
                    const oU=oS.val();
                    const role = oU.role || 'user'; let roleIcon = ''; if (role === 'superadmin') roleIcon = '👑'; else if (role === 'admin') roleIcon = '🛡️';
                    c.innerHTML=`<div class="card chat-container" style="margin:0;"><div class="chat-header"><i class="fa-solid fa-arrow-left back-btn" data-view="inbox"></i><div class="avatar" id="chat-header-avatar"></div><strong>${oU.name}${uiModule.getVerifiedBadgeHTML(oU.isVerified)}<span class="admin-badge">${roleIcon}</span></strong></div><div class="chat-messages" id="chat-messages-list"><div class="loading-spinner"></div></div><div id="typing-indicator" class="typing-indicator-container hidden"><div class="avatar" id="typing-avatar"></div><div class="typing-indicator-dots"><span></span><span></span><span></span></div></div><div class="message-form-wrapper"><div class="mention-suggestions"></div><form class="message-form" data-action="send-message" data-receiverid="${oId}"><input class="input" type="text" placeholder="${_t('write_a_message')}" required><button type="submit" class="btn"><i class="fa-solid fa-paper-plane"></i></button></form></div></div>`;
                    uiModule.renderAvatar(document.getElementById('chat-header-avatar'),oU);
                    const cId=dbModule.getChatId(currentUser.uid,oId);
                    
                    const mR=db.ref(`chats/${cId}/messages`).orderByChild('time').limitToLast(50);
                    if(activeChatListener) activeChatListener.off();
                    activeChatListener=mR.on('value',s=>{
                        const ml=document.getElementById('chat-messages-list');
                        if (!ml) { if (activeChatListener) activeChatListener.off(); return; }
                        ml.innerHTML='';
                        if(s.exists()){s.forEach(ms=>{const m=ms.val();const i=document.createElement('div');i.className=`message-item ${m.senderId===currentUser.uid?'sent':'received'}`;i.innerHTML=`<div class="message-bubble">${uiModule.linkifyText(m.text)}</div>`;ml.prepend(i);});
                        }else{ml.innerHTML=`<p style="text-align:center;color:var(--secondary-text-color);">${_t('no_messages_yet')}</p>`;}
                    }, (error) => { console.error("Firebase chat listener error:", error); });
                    
                    const messageInput = c.querySelector('.message-form .input');
                    const typingIndicatorEl = document.getElementById('typing-indicator');
                    uiModule.renderAvatar(typingIndicatorEl.querySelector('.avatar'), oU);
                    
                    if (activeTypingListener) activeTypingListener.off();
                    activeTypingListener = db.ref(`typingStatus/${cId}/${oId}`).on('value', snap => {
                        if (snap.exists() && snap.val() === true) {
                            typingIndicatorEl.classList.remove('hidden');
                        } else {
                            typingIndicatorEl.classList.add('hidden');
                        }
                    });

                    messageInput.addEventListener('input', () => {
                        const typingRef = db.ref(`typingStatus/${cId}/${currentUser.uid}`);
                        typingRef.set(true);
                        if (typingTimeout) clearTimeout(typingTimeout);
                        typingTimeout = setTimeout(() => {
                            typingRef.remove();
                        }, 2000);
                    });

                    const mI=c.querySelector('.message-form .input');
                    mI.addEventListener('input',(e)=>uiModule.handleMentionInput(e.target));
                    mI.addEventListener('keydown',(e)=>{if(e.key==='Escape'){const sB=e.target.closest('.message-form-wrapper').querySelector('.mention-suggestions');if(sB)sB.style.display='none';}});
                } catch(error) { console.error("Failed to render chat:", error); c.innerHTML = `<div class="card" style="padding:20px;">Error loading chat. Please try again.</div>`; }
            },
            renderDashboard: async (c) => {
                const uD = currentUserData;
                const followerSnap = await db.ref(`follows/${currentUser.uid}`).once('value');
                const followerCount = followerSnap.numChildren();
                const totalViews = uD.totalVideoViews || 0;
                
                const chartSVG = `
                    <div class="insights-chart-container">
                        <svg viewBox="0 0 300 150" preserveAspectRatio="xMidYMid meet">
                            <line x1="25" y1="120" x2="290" y2="120" class="grid-line" ></line>
                            <text x="5" y="125" class="axis-label">0</text>
                            <line x1="25" y1="95" x2="290" y2="95" class="grid-line" ></line>
                            <text x="5" y="100" class="axis-label">200</text>
                            <line x1="25" y1="70" x2="290" y2="70" class="grid-line" ></line>
                            <text x="5" y="75" class="axis-label">400</text>
                            <line x1="25" y1="45" x2="290" y2="45" class="grid-line" ></line>
                            <text x="5" y="50" class="axis-label">600</text>
                            <path class="chart-line" d="M30,100 L45,85 L60,105 L75,100 L90,110 L105,95 L120,115 L135,100 L150,90 L165,110 L180,80 L195,115 L210,20 L225,90 L240,100 L255,115 L270,95 L285,85" ></path>
                            <text x="35" y="140" class="axis-label">Jun 06</text>
                            <text x="95" y="140" class="axis-label">Jun 11</text>
                            <text x="155" y="140" class="axis-label">Jun 15</text>
                            <text x="205" y="140" class="axis-label">Jun 20</text>
                            <text x="255" y="140" class="axis-label">Jun 25</text>
                        </svg>
                    </div>`;

                c.innerHTML = `
                    <h2 style="padding-left:10px;">${_t('professional_dashboard')}</h2>
                    <div class="card" style="background-color: #333333; color: white; padding:0;">
                        <div class="dashboard-header-card">
                           <div id="dashboard-avatar" class="avatar"></div>
                           <div class="dashboard-header-info">
                                <h4>${uD.name}</h4>
                                <p>${followerCount} ${_t('followers')} • ${_t('weekly_challenge')} • ${_t('weekly_challenge_remaining', {percent: 96})}</p>
                                <div class="dashboard-progress-bar">
                                    <div class="dashboard-progress-bar-inner"></div>
                                </div>
                           </div>
                        </div>
                    </div>
                    <div class="card" style="padding:0;">
                        <div class="dashboard-section">
                            <h3 class="dashboard-section-title">${_t('next_steps')}</h3>
                             <div class="dashboard-action-item">
                                <div class="dashboard-action-icon"><i class="fa-solid fa-trophy"></i></div>
                                <div class="dashboard-action-text">
                                    <strong>${_t('continue_weekly_challenge')}</strong>
                                    <small>${_t('requirements_left', {count: 5})}</small>
                                </div>
                                <i class="fa-solid fa-chevron-right dashboard-action-arrow"></i>
                            </div>
                            <div class="dashboard-action-item">
                                <div class="dashboard-action-icon"><i class="fa-solid fa-play"></i></div>
                                <div class="dashboard-action-text">
                                    <strong>${_t('earn_reels_achievement')}</strong>
                                    <small>${_t('learn_reels_tools')}</small>
                                </div>
                                <i class="fa-solid fa-chevron-right dashboard-action-arrow"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="padding: 16px;">
                        <h3 class="dashboard-section-title">${_t('insights')} <small style="color:var(--secondary-text-color); font-weight:normal;">${_t('last_28_days')}</small></h3>
                        <div class="dashboard-insights-summary">
                           ${_t('great_job_views', {count: totalViews.toLocaleString()})}
                           <span class="stat-change positive">↑77% ${_t('from_previous_28_days')}</span>
                        </div>
                        ${chartSVG}
                    </div>
                    <div class="dashboard-stats-grid">
                        <div class="card dashboard-stat-card">
                            <h5>${_t('approximate_earnings')}</h5>
                            <div class="value">
                                <i class="fa-solid fa-dollar-sign"></i>
                                <span>${uD.isMonetized ? (uD.balance || 0).toFixed(2) : '--'}</span>
                            </div>
                        </div>
                        <div class="card dashboard-stat-card">
                            <h5>${_t('engagement')}</h5>
                             <div class="value">
                                <span>191</span>
                                <span class="stat-change positive">↑5%</span>
                            </div>
                        </div>
                        <div class="card dashboard-stat-card">
                             <h5>${_t('net_followers')}</h5>
                             <div class="value">
                                <span>67</span>
                                 <span class="stat-change positive">↑12%</span>
                            </div>
                        </div>
                    </div>
                `;
                uiModule.renderAvatar(c.querySelector('#dashboard-avatar'), uD);
            },
            renderNotifications: async (c) => {
                const notifications = await dbModule.getNotifications(currentUser.uid);
                c.innerHTML = `<h2 style="padding-left:10px;">${_t('notifications')}</h2><div id="notification-list" class="card" style="padding:0;"></div>`;
                const listContainer = c.querySelector('#notification-list');
                if (notifications.length === 0) {
                    listContainer.innerHTML = `<p style="text-align:center; padding: 20px;">${_t('no_notifications')}</p>`;
                    return;
                }
                const notifHtml = notifications.map(n => {
                    let text = '', snippet = '', action = 'navigate-to-post', postId = n.postId;
                    switch(n.type) {
                        case 'like': text = _t('liked_your_post', { name: n.fromUser.name }); snippet = n.postTextSnippet || ''; break;
                        case 'comment': text = _t('commented_on_your_post', { name: n.fromUser.name }); snippet = n.commentText || ''; break;
                        case 'reply': text = _t('replied_to_your_comment', { name: n.fromUser.name }); snippet = n.commentText || ''; break;
                        case 'gift': text = _t('gift_received_notification', { name: n.fromUser.name, amount: (n.amount || 0).toFixed(2) }); action = 'view-balance-history'; postId = ''; break;
                        default: text = 'New notification';
                    }
                    const contentSnippet = snippet ? `"${snippet.substring(0, 50)}..."` : '';
                    return `
                        <div class="notification-item ${!n.isRead ? 'unread' : ''}" data-action="${action}" data-postid="${postId}">
                            <div class="avatar" style="background-image:url(${n.fromUser.photoURL})"></div>
                            <div class="notification-content">
                                <p>${text} ${contentSnippet}</p>
                                <small>${new Date(n.timestamp).toLocaleString()}</small>
                            </div>
                        </div>`;
                }).join('');
                listContainer.innerHTML = notifHtml;
            },
            renderHashtagFeed: async (container, userId, tag) => {
                container.innerHTML = `<h2 style="padding-left:10px;">${_t('hashtag_feed_title', {tag: tag})}</h2><div id="posts-feed"></div>`;
                const posts = await dbModule.getPostsByHashtag(tag);
                const feedContainer = container.querySelector('#posts-feed');
                if (posts.length > 0) {
                    feedContainer.innerHTML = posts.map(uiModule.createPostElement).join('');
                    posts.forEach(post => { if (post.id) adsterraModule.renderPostBannerAd(`ad-container-${post.id}`); });
                } else {
                    feedContainer.innerHTML = `<div class="card" style="padding:20px; text-align:center;">${_t('no_posts_with_hashtag')}</div>`;
                }
            },
            renderGamesView: async (container) => {
                container.innerHTML = `<h2 style="padding: 10px 20px 0;">${_t('games')}</h2><div id="games-grid"></div>`;
                const grid = container.querySelector('#games-grid');
                const games = await dbModule.getGames();
                if (games.length > 0) {
                    grid.innerHTML = games.map(game => `
                        <div class="game-card" data-view="game-player" data-gameid="${game.id}">
                            <div class="game-card-thumbnail" style="background-image: url('${game.thumbnailUrl || 'https://via.placeholder.com/300x200?text=No+Image'}')"></div>
                            <div class="game-card-title">${game.title}</div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = `<p>${_t('no_games_found')}</p>`;
                }
            },
            renderGamePlayer: async (container, gameId) => {
                const game = await dbModule.getGame(gameId);
                if (!game) {
                    container.innerHTML = `<p>${_t('error_generic')}</p>`;
                    return;
                }
                container.innerHTML = `
                    <div id="game-player-container">
                        <div id="game-player-header">
                            <button class="btn secondary" data-view="games"><i class="fa-solid fa-arrow-left"></i> ${_t('back_to_games') || 'Back'}</button>
                            <h3>${game.title}</h3>
                        </div>
                        <div id="game-canvas"></div>
                    </div>
                `;

                const canvas = document.getElementById('game-canvas');
                if (game.type === 'url') {
                    canvas.innerHTML = `<iframe src="${game.content}" allow="fullscreen"></iframe>`;
                } else if (game.type === 'html') {
                    canvas.innerHTML = game.content;
                    const scripts = canvas.querySelectorAll('script');
                    scripts.forEach(oldScript => {
                        const newScript = document.createElement("script");
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                }
            },
            renderAdminGamesManager: async (container) => {
                const games = await dbModule.getGames();
                const gamesListHtml = games.map(game => `
                    <div class="admin-game-item" id="admin-game-${game.id}">
                        <img src="${game.thumbnailUrl || 'https://via.placeholder.com/50'}" alt="thumbnail">
                        <span>${game.title} (${game.type})</span>
                        <button class="btn small" data-action="edit-game" data-gameid="${game.id}">${_t('edit_game')}</button>
                        <button class="btn small danger" data-action="delete-game" data-gameid="${game.id}">${_t('delete_game')}</button>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div id="admin-games-list">${gamesListHtml}</div>
                    <hr style="margin: 20px 0;">
                    <form id="add-game-form">
                        <h4 id="game-form-title">${_t('add_new_game')}</h4>
                        <input type="hidden" id="gameIdInput">
                        <label for="gameTitleInput">${_t('game_title')}</label>
                        <input type="text" id="gameTitleInput" class="input" required>
                        
                        <label for="gameThumbInput">${_t('thumbnail_url')}</label>
                        <input type="url" id="gameThumbInput" class="input">

                        <label for="gameTypeSelect">${_t('game_type')}</label>
                        <select id="gameTypeSelect" class="select">
                            <option value="url" selected>${_t('game_type_url')}</option>
                            <option value="html">${_t('game_type_html')}</option>
                        </select>
                        
                        <label for="gameContentInput">${_t('game_content')}</label>
                        <textarea id="gameContentInput" class="textarea" rows="6" placeholder="${_t('game_content_url')}" required></textarea>

                        <button type="submit" class="btn success full-width">${_t('save')}</button>
                        <button type="button" id="cancel-edit-game-btn" class="btn secondary full-width hidden">${_t('cancel')}</button>
                    </form>
                `;

                const typeSelect = container.querySelector('#gameTypeSelect');
                const contentInput = container.querySelector('#gameContentInput');
                typeSelect.addEventListener('change', () => {
                    contentInput.placeholder = typeSelect.value === 'url' ? _t('game_content_url') : _t('game_content_html');
                });
            },
            getVerifiedBadgeHTML: (isVerified) => {
                return isVerified ? ' <i class="fa-solid fa-check-circle verified-badge"></i>' : '';
            },
            renderAvatar:(e,u,l=false)=>{if(!e||!u)return;e.style.position='relative';if(l)e.style.cssText+=`width:${window.innerWidth<=768?120:168}px;height:${window.innerWidth<=768?120:168}px;font-size:${window.innerWidth<=768?60:80}px;`;e.style.backgroundImage=u.photoURL?`url(${u.photoURL})`:'none';e.innerHTML=(u.photoURL?'':(u.name?.charAt(0).toUpperCase()||'?'));},
            showModal:(c,t='post')=>{const m=document.getElementById('modal-container');const cl={'register':'register-modal-content', 'reactions': 'reactions-modal-content'}[t]||'modal-content';m.innerHTML=`<div class="${cl} card" style="padding:16px;">${c}</div>`;m.classList.remove('hidden');},
            showPostModal:()=>{
                const modalContent = `<h3>${_t('new_post')}</h3><div style="position:relative;"><div class="mention-suggestions"></div><textarea id="postText" class="textarea" style="min-height:80px;" placeholder="${_t('whats_in_your_mind')}"></textarea></div><label for="mediaFile">${_t('upload_media')}</label><input type="file" id="mediaFile" class="input" accept="image/*,video/*"><div class="post-modal-actions"><select id="postAudience" class="select audience-selector"><option value="public" selected>${_t('public')}</option><option value="followers">${_t('followers')}</option><option value="only_me">${_t('only_me')}</option></select><div class="btn-group"><button id="createPostBtn" class="btn">${_t('post_button')}</button><button class="btn secondary" data-action="close-modal">${_t('cancel')}</button></div></div>`;
                uiModule.showModal(modalContent);
                const pI=document.getElementById('postText');
                pI.addEventListener('input',(e)=>uiModule.handleMentionInput(e.target));
                pI.addEventListener('keydown',(e)=>{if(e.key==='Escape'){document.querySelector('#modal-container .mention-suggestions').style.display='none';}});
            },
            showRegisterModal:()=>uiModule.showModal(`<div class="register-header" style="padding:10px 16px;"><h2>${_t('signup')}</h2><p>${_t('signup_subtitle')}</p></div><div class="register-body" style="padding:16px;"><input class="input" type="text" id="registerName" placeholder="${_t('full_name')}"><input class="input" type="email" id="registerEmail" placeholder="${_t('email')}"><input class="input" type="tel" id="registerPhone" placeholder="${_t('phone')}"><input class="input" type="password" id="registerPassword" placeholder="${_t('new_password')}"><button id="registerBtn" class="btn full-width">${_t('signup')}</button></div>`,'register'),
            showEditProfileModal:(d)=>{
                const mfaButton = `<button class="btn secondary full-width" data-action="manage-2fa">${_t('manage_2fa')}</button>`;
                const blockListButton = `<button class="btn secondary full-width" data-action="manage-blocked-list" style="margin-top:10px;">${_t('manage_blocked_list')}</button>`;
                const proModeButtonText = d.isProfessionalMode ? _t('turn_off_professional_mode') : _t('turn_on_professional_mode');
                const proModeButton = `<hr style="border-color: var(--divider-color); margin: 25px 0;"><h3>${_t('professional_mode')}</h3><button class="btn secondary full-width" data-action="toggle-professional-mode">${proModeButtonText}</button>`;
                const securitySection = `<hr style="border-color: var(--divider-color); margin: 25px 0;"><h3 data-lang-key="account_security">${_t('account_security')}</h3>${mfaButton}${blockListButton}`;
                const content = `<h3>${_t('edit_profile_title')}</h3><label for="editName">${_t('name')}</label><input type="text" id="editName" class="input" value="${d.name}"><label for="editBio">${_t('bio')}</label><textarea id="editBio" class="textarea" placeholder="${_t('write_about_yourself')}">${d.bio||''}</textarea><label for="editRelationshipStatus">${_t('relationship_status')}</label><select id="editRelationshipStatus" class="select"><option value="সিঙ্গেল" ${d.relationshipStatus==='সিঙ্গেল'?'selected':''}>সিঙ্গেল</option><option value="ইন এ রিলেশনশিপ" ${d.relationshipStatus==='ইন এ রিলেশনশিপ'?'selected':''}>ইন এ রিলেশনশিপ</option><option value="এনগেজড" ${d.relationshipStatus==='এনগেজড'?'selected':''}>এনগেজড</option><option value="বিবাহিত" ${d.relationshipStatus==='বিবাহিত'?'selected':''}>বিবাহিত</option><option value="কমপ্লিকেটেড" ${d.relationshipStatus==='কমপ্লিকেটেড'?'selected':''}>এটি কমপ্লিকেটেড</option></select><label for="editRelationshipWith">${_t('partner_username')}</label><input type="text" id="editRelationshipWith" class="input" value="${d.relationshipWith?`@${d.relationshipWith}`:''}"><label for="editProfilePic">${_t('profile_picture')}</label><input type="file" id="editProfilePic" class="input" accept="image/*"><label for="editCoverPic">${_t('cover_photo')}</label><input type="file" id="editCoverPic" class="input" accept="image/*">${proModeButton}<hr style="border-color: var(--divider-color); margin: 25px 0;"><h3 data-lang-key="account_security">অ্যাকাউন্ট ও নিরাপত্তা</h3><label for="editEmail">${_t('email')}</label><input type="email" id="editEmail" class="input" value="${d.email}"><label for="editPhone">${_t('phone')}</label><input type="tel" id="editPhone" class="input" value="${d.phone || ''}"><label for="editNewPassword">${_t('new_password')}</label><input type="password" id="editNewPassword" class="input" placeholder="${_t('new_password')}"><label for="editConfirmPassword">${_t('confirm_password_placeholder')}</label><input type="password" id="editConfirmPassword" class="input" placeholder="${_t('confirm_password_placeholder')}"><input type="password" id="editCurrentPassword" class="input" placeholder="${_t('current_password_placeholder')}" style="margin-top: 15px; border-color: var(--error-color);">${securitySection}<div style="display:flex;gap:10px;margin-top:20px;"><button id="saveProfileBtn" class="btn" style="flex-grow:1;">${_t('save')}</button><button class="btn secondary" data-action="close-modal">${_t('cancel')}</button></div>`;
                uiModule.showModal(content);
            },
            showManageBalanceModal:(uId,uN,cB)=>{const c=`<h3>${_t('manage_balance_for', {name: uN})}</h3><p>${_t('current_balance')}: <strong>৳${parseFloat(cB).toFixed(2)}</strong></p><label for="newBalanceInput">${_t('set_new_balance')}</label><input type="number" step="0.01" id="newBalanceInput" class="input" value="${parseFloat(cB).toFixed(2)}"><div style="display:flex;gap:10px;margin-top:10px;"><button id="saveBalanceBtn" class="btn success" style="flex-grow:1;" data-userid="${uId}">${_t('save')}</button><button class="btn secondary" data-action="close-modal">${_t('cancel')}</button></div>`;uiModule.showModal(c);},
            showBalanceHistoryModal: async (h)=>{
                const reasonPromises = h.map(async item => {
                    let reasonText = '';
                    switch (item.type) {
                        case 'reaction_milestone': reasonText = _t('reason_reaction'); break;
                        case 'admin_update': reasonText = _t('reason_admin'); break;
                        case 'gift_sent': reasonText = _t('reason_gift_sent', { name: item.recipientName || 'N/A' }); break;
                        case 'gift_received': reasonText = _t('reason_gift_received', { name: item.senderName || 'N/A' }); break;
                        default: reasonText = _t('reason_unknown');
                    }
                    return reasonText;
                });

                const reasons = await Promise.all(reasonPromises);

                let hr = h.map((i, index) => {
                    const a = i.amount >= 0 ? 'amount-positive' : 'amount-negative';
                    const s = i.amount >= 0 ? '+' : '';
                    const locale = currentLang === 'bn' ? 'bn-BD' : 'en-US';
                    return `<tr><td>${new Date(i.timestamp).toLocaleString(locale)}</td><td>${reasons[index]}</td><td class="${a}">${s}${i.amount.toFixed(2)}</td><td>${i.newBalance.toFixed(2)}</td></tr>`;
                }).join('');

                if (h.length === 0) hr = `<tr><td colspan="4" style="text-align:center;">${_t('no_transaction_history')}</td></tr>`;
                
                const c = `<h3>${_t('balance_history_title')}</h3><div style="overflow-x:auto;"><table class="balance-history-table"><thead><tr><th>${_t('date')}</th><th>${_t('reason')}</th><th>${_t('amount')}</th><th>${_t('new_balance')}</th></tr></thead><tbody>${hr}</tbody></table></div><button class="btn secondary full-width" data-action="close-modal" style="margin-top:20px;">${_t('close')}</button>`;
                uiModule.showModal(c);
            },
            initGlobalNotificationListener:()=>{db.ref('appSettings/globalNotification').on('value',s=>{const b=document.getElementById('global-notification-banner');if(s.exists()&&s.val().text){b.querySelector('.message').textContent=s.val().text;b.classList.remove('hidden');}else{b.classList.add('hidden');}});},
            handleMentionInput:(iE)=>{const t=iE.value,c=iE.selectionStart,tBC=t.substring(0,c),mM=tBC.match(/@(\w*)$/),sB=iE.closest('div').querySelector('.mention-suggestions')||iE.closest('.comment-form-wrapper').querySelector('.mention-suggestions')||iE.closest('.message-form-wrapper').querySelector('.mention-suggestions');if(mM){const q=mM[1].toLowerCase();const s=mentionableUsersCache.filter(u=>u.name.toLowerCase().includes(q));uiModule.showMentionSuggestions(s,sB,iE);}else if(sB){sB.style.display='none';}},
            showMentionSuggestions:(s,sB,iE)=>{if(!sB||s.length===0){if(sB)sB.style.display='none';return;}sB.innerHTML=s.map(u=>`<div class="mention-item" data-username="${u.name}"><div class="avatar" id="mention-avatar-${u.uid}"></div><span>${u.name}</span></div>`).join('');s.forEach(u=>uiModule.renderAvatar(sB.querySelector(`#mention-avatar-${u.uid}`),u));sB.style.display='block';sB.querySelectorAll('.mention-item').forEach(i=>{i.onclick=()=>{const uN=i.dataset.username,t=iE.value,c=iE.selectionStart,tBC=t.substring(0,c),mM=tBC.match(/@(\w*)$/),sI=mM.index,tAC=t.substring(c);iE.value=t.substring(0,sI)+`@${uN} `+tAC;sB.style.display='none';iE.focus();};});},
            showMfaVerificationModal: () => {
                let prompt = '';
                if(mfaHint.factorId === firebase.auth.PhoneAuthProvider.PROVIDER_ID) { prompt = `${_t('mfa_enter_phone_code_prompt')} (${mfaHint.phoneNumber})`; } 
                else if (mfaHint.factorId === firebase.auth.TotpMultiFactorGenerator.FACTOR_ID) { prompt = _t('mfa_enter_totp_code_prompt'); }
                const modalContent = `<h3>${_t('mfa_title')}</h3><p>${_t('mfa_login_prompt')}</p><p>${prompt}</p><input type="text" id="mfaCode" class="input" placeholder="${_t('mfa_verification_code_placeholder')}"><button id="verifyMfaBtn" class="btn full-width">${_t('mfa_verify_button')}</button><button class="btn secondary full-width" data-action="close-modal">${_t('cancel')}</button>`;
                uiModule.showModal(modalContent);
            },
            showPhoneEnrollVerifyModal: (verificationId) => {
                const modalContent = `<h3>${_t('mfa_enroll_title')}</h3><p>${_t('mfa_enter_phone_code_prompt')}</p><input type="text" id="mfaCode" class="input" placeholder="${_t('mfa_verification_code_placeholder')}"><button id="verifyPhoneEnrollBtn" class="btn full-width" data-verification-id="${verificationId}">${_t('mfa_verify_button')}</button><button class="btn secondary full-width" data-action="close-modal">${_t('cancel')}</button>`;
                uiModule.showModal(modalContent);
            },
            showBlockListModal: async () => {
                const users = await dbModule.getBlockedUsersList();
                let userListHtml = '';
                if (users && users.length > 0) {
                    userListHtml = users.map(user => `
                        <div class="blocked-user-item" id="blocked-user-${user.uid}">
                            <div class="avatar" id="blocked-avatar-${user.uid}"></div>
                            <span>${user.name}</span>
                            <button class="btn small danger" data-action="unblock-user-from-list" data-userid="${user.uid}">${_t('unblock')}</button>
                        </div>
                    `).join('');
                } else { userListHtml = `<p style="text-align: center; color: var(--secondary-text-color);">${_t('no_blocked_users')}</p>`; }
                const modalContent = `<h3>${_t('blocked_users_title')}</h3><div id="blocked-users-container">${userListHtml}</div><button class="btn secondary full-width" data-action="close-modal" style="margin-top: 20px;">${_t('close')}</button>`;
                uiModule.showModal(modalContent);
                if (users && users.length > 0) { users.forEach(user => { uiModule.renderAvatar(document.getElementById(`blocked-avatar-${user.uid}`), user); }); }
            },
            showManage2faModal: () => {
                const enrolledFactors = currentUser.multiFactor.enrolledFactors;
                let phoneFactor = enrolledFactors.find(f => f.factorId === firebase.auth.PhoneAuthProvider.PROVIDER_ID);
                let totpFactor = enrolledFactors.find(f => f.factorId === firebase.auth.TotpMultiFactorGenerator.FACTOR_ID);
                let content = `<h3>${_t('manage_2fa')}</h3>`;
                if (phoneFactor) { content += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"><span>${_t('phone_sms')} (${phoneFactor.phoneNumber})</span><button class="btn danger small" data-action="disable-mfa" data-factor-uid="${phoneFactor.uid}">${_t('disable_phone_2fa')}</button></div>`; } 
                else { content += `<button class="btn secondary full-width" data-action="enable-phone-2fa" style="margin-bottom: 10px;">${_t('enable_phone_2fa')}</button>`; }
                if (totpFactor) { content += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"><span>${_t('authenticator_app')}</span><button class="btn danger small" data-action="disable-mfa" data-factor-uid="${totpFactor.uid}">${_t('disable_totp_2fa')}</button></div>`; } 
                else { content += `<button class="btn secondary full-width" data-action="enable-totp-2fa" style="margin-bottom: 10px;">${_t('enable_totp_2fa')}</button>`; }
                content += `<button class="btn full-width" data-action="close-modal" style="margin-top: 20px;">${_t('close')}</button>`;
                uiModule.showModal(content);
            },
            showTotpEnrollModal: (enrollment) => {
                totpEnrollment = enrollment; 
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(enrollment.qrCodeUrl)}`;
                const modalContent = `<h3>${_t('enable_totp_2fa')}</h3><p>${_t('mfa_scan_qr_prompt')}</p><div class="qr-code-container"><img src="${qrCodeUrl}" alt="QR Code"><p style="margin-top:15px; font-weight:bold;">${_t('secret_key')}: <code style="background:var(--background-color); padding: 4px 8px; border-radius:4px; cursor:pointer;" title="${_t('click_to_copy')}" data-action="copy-secret">${enrollment.secret}</code></p></div><input type="text" id="mfaCode" class="input" placeholder="${_t('mfa_verification_code_placeholder')}"><button id="verifyTotpBtn" class="btn full-width">${_t('mfa_verify_button')}</button><button class="btn secondary full-width" data-action="close-modal">${_t('cancel')}</button>`;
                uiModule.showModal(modalContent);
            },
            showPostDetailModal: async (postId) => {
                uiModule.showLoader(true);
                try {
                    const postSnap = await db.ref(`posts/${postId}`).once('value');
                    if (!postSnap.exists()) { alert(_t('user_not_found')); return; }
                    const postData = { id: postId, ...postSnap.val() };
                    if (blockedUserIds.has(postData.user.uid)) { alert(_t('user_not_available_message')); return; }
                    const modalContent = `<div id="post-detail-modal-content" style="padding:0;">${uiModule.createPostElement(postData)}</div>`;
                    uiModule.showModal(modalContent, 'post-detail');
                    const postElement = document.getElementById('post-detail-modal-content').querySelector('.post');
                    uiModule.attachPostListeners(postElement);
                    adsterraModule.renderPostBannerAd(`ad-container-${postData.id}`);
                } catch (error) { console.error("Error showing post detail:", error); alert(_t('error_generic')); } 
                finally { uiModule.showLoader(false); }
            },
            
            renderStoryReel: async () => {
                const container = document.getElementById('story-reel-container'); if (!container) return;
                const stories = await dbModule.getStories();
                const grouped = stories.reduce((acc, story) => {
                    if (!acc[story.userId]) { acc[story.userId] = { user: { uid: story.userId, name: story.userName, photoURL: story.userPhotoURL }, stories: [] }; }
                    acc[story.userId].stories.push(story);
                    return acc;
                }, {});
                let sortedUsers = Object.values(grouped);
                const myStoriesIndex = sortedUsers.findIndex(u => u.user.uid === currentUser.uid);
                if (myStoriesIndex > -1) { const myStories = sortedUsers.splice(myStoriesIndex, 1)[0]; sortedUsers.unshift(myStories); }
                storyViewerState.groupedStories = sortedUsers;
                let html = `<div class="story-item" data-action="create-story"><div class="story-avatar-wrapper create"><div class="story-avatar" style="display:grid; place-items:center;"><i class="fa-solid fa-plus create-icon"></i></div></div><span class="story-name">${_t('create_story')}</span></div>`;
                if (sortedUsers.length === 0) { container.innerHTML = html + `<p style="align-self:center; color: var(--secondary-text-color);">${_t('no_stories_found')}</p>`; return; }
                html += sortedUsers.map((group, index) => {
                    const hasSeenAll = group.stories.every(s => s.viewers && s.viewers[currentUser.uid]);
                    const isMyStory = group.user.uid === currentUser.uid;
                    return `<div class="story-item" data-action="view-story" data-user-index="${index}"><div class="story-avatar-wrapper ${hasSeenAll ? 'seen' : ''}"><div class="story-avatar" style="background-image: url(${group.user.photoURL})"></div></div><span class="story-name">${isMyStory ? _t('your_story') : group.user.name}</span></div>`;
                }).join('');
                container.innerHTML = html;
            },
            showCreateStoryModal: () => {
                const modalContent = `<h3>${_t('create_story')}</h3><p>${_t('upload_story_prompt')}</p><input type="file" id="storyVideoFile" class="input" accept="video/*"><video id="story-video-preview" class="hidden" controls></video><button id="uploadStoryBtn" class="btn full-width" disabled>${_t('upload_story')}</button><button class="btn secondary full-width" data-action="close-modal">${_t('cancel')}</button>`;
                uiModule.showModal(modalContent);
                const fileInput = document.getElementById('storyVideoFile'), preview = document.getElementById('story-video-preview'), uploadBtn = document.getElementById('uploadStoryBtn');
                let videoFile = null, videoDuration = 0;
                fileInput.onchange = (e) => {
                    videoFile = e.target.files[0]; if (!videoFile) return;
                    preview.classList.remove('hidden');
                    const videoURL = URL.createObjectURL(videoFile);
                    preview.src = videoURL;
                    preview.onloadedmetadata = () => { videoDuration = preview.duration; if (videoDuration > 120) { alert(_t('error_story_duration')); uploadBtn.disabled = true; } else { uploadBtn.disabled = false; } };
                };
                uploadBtn.onclick = async () => { if (videoFile && videoDuration <= 120) { uiModule.showLoader(true); try { await dbModule.createStory(videoFile, videoDuration); alert(_t('story_upload_success')); document.getElementById('modal-container').classList.add('hidden'); uiModule.renderStoryReel(); } catch (err) { alert(_t('story_upload_fail', { message: err.message })); } finally { uiModule.showLoader(false); } } };
            },
            showStoryViewer: (userIndex) => {
                storyViewerState.isShowing = true; storyViewerState.currentUserIndex = userIndex; storyViewerState.currentStoryIndex = 0;
                const container = document.getElementById('story-viewer-container');
                container.innerHTML = `<div id="story-viewer-modal"><div class="story-viewer-content"><div class="story-viewer-header"><div class="story-progress-bars"></div><div class="story-viewer-info"><div class="avatar"></div><span></span></div></div><video id="story-viewer-video" playsinline></video><div class="story-viewer-close"><i class="fa-solid fa-xmark"></i></div><div id="story-nav-prev" class="story-viewer-nav"><i class="fa-solid fa-chevron-left"></i></div><div id="story-nav-next" class="story-viewer-nav"><i class="fa-solid fa-chevron-right"></i></div><div class="story-viewer-footer"><div class="story-reaction-bar" data-action="react-to-story"><span class="reaction" data-reaction-type="like">${reactionEmojis.like}</span><span class="reaction" data-reaction-type="love">${reactionEmojis.love}</span><span class="reaction" data-reaction-type="haha">${reactionEmojis.haha}</span><span class="reaction" data-reaction-type="wow">${reactionEmojis.wow}</span><span class="reaction" data-reaction-type="sad">${reactionEmojis.sad}</span><span class="reaction" data-reaction-type="angry">${reactionEmojis.angry}</span></div></div></div></div>`;
                document.getElementById('story-nav-prev').onclick = () => uiModule.playPreviousUserStory();
                document.getElementById('story-nav-next').onclick = () => uiModule.playNextUserStory();
                document.querySelector('.story-viewer-close').onclick = () => uiModule.closeStoryViewer();
                uiModule.playCurrentStory();
            },
            playCurrentStory: () => {
                const { groupedStories, currentUserIndex, currentStoryIndex } = storyViewerState;
                const userGroup = groupedStories[currentUserIndex]; if (!userGroup) { uiModule.closeStoryViewer(); return; }
                const story = userGroup.stories[currentStoryIndex]; if (!story) { uiModule.playNextUserStory(); return; }
                const header = document.querySelector('.story-viewer-header'), videoEl = document.getElementById('story-viewer-video'), footer = document.querySelector('.story-viewer-footer');
                header.querySelector('.story-viewer-info .avatar').style.backgroundImage = `url(${userGroup.user.photoURL})`;
                header.querySelector('.story-viewer-info span').textContent = userGroup.user.name;
                const progressContainer = header.querySelector('.story-progress-bars');
                progressContainer.innerHTML = userGroup.stories.map((s, i) => `<div class="story-progress-bar"><div class="story-progress-bar-inner" style="width: ${i < currentStoryIndex ? '100%' : '0%'}"></div></div>`).join('');
                const currentProgressBar = progressContainer.children[currentStoryIndex].querySelector('.story-progress-bar-inner');
                videoEl.src = story.mediaUrl; videoEl.currentTime = 0; videoEl.play().catch(e => console.error("Video play failed:", e));
                dbModule.markStoryAsViewed(story.id);
                videoEl.ontimeupdate = () => { if(!videoEl.duration) return; const progress = (videoEl.currentTime / videoEl.duration) * 100; if(currentProgressBar) currentProgressBar.style.width = `${progress}%`; };
                videoEl.onended = () => uiModule.playNextStoryInGroup();
                const existingBtn = footer.querySelector('[data-action="show-story-viewers"]'); if(existingBtn) existingBtn.remove();
                if (userGroup.user.uid === currentUser.uid) {
                    const viewerCount = story.viewers ? Object.keys(story.viewers).length : 0;
                    const viewersBtn = document.createElement('button'); viewersBtn.className = 'btn small story-viewers-footer-button'; viewersBtn.dataset.action = 'show-story-viewers'; viewersBtn.dataset.storyid = story.id;
                    viewersBtn.innerHTML = `<i class="fa-solid fa-eye"></i> ${_t('viewers', {count: viewerCount})}`;
                    footer.appendChild(viewersBtn);
                }
                const reactionBar = document.querySelector('.story-reaction-bar');
                reactionBar.querySelectorAll('.reaction').forEach(r => { r.onclick = (e) => { const reactionType = e.target.dataset.reactionType; dbModule.reactToStory(story.id, reactionType); e.target.style.transform = 'scale(1.5)'; setTimeout(() => e.target.style.transform = 'scale(1)', 200); }; });
            },
            playNextStoryInGroup: () => {
                const { groupedStories, currentUserIndex, currentStoryIndex } = storyViewerState;
                if (currentStoryIndex < groupedStories[currentUserIndex].stories.length - 1) { storyViewerState.currentStoryIndex++; uiModule.playCurrentStory(); } 
                else { uiModule.playNextUserStory(); }
            },
            playNextUserStory: () => {
                if (storyViewerState.currentUserIndex < storyViewerState.groupedStories.length - 1) { storyViewerState.currentUserIndex++; storyViewerState.currentStoryIndex = 0; uiModule.playCurrentStory(); } 
                else { uiModule.closeStoryViewer(); }
            },
            playPreviousUserStory: () => {
                if (storyViewerState.currentUserIndex > 0) { storyViewerState.currentUserIndex--; storyViewerState.currentStoryIndex = 0; uiModule.playCurrentStory(); }
            },
            closeStoryViewer: () => {
                storyViewerState.isShowing = false;
                const container = document.getElementById('story-viewer-container');
                const videoEl = document.getElementById('story-viewer-video');
                if(videoEl) videoEl.pause();
                container.innerHTML = '';
                uiModule.renderStoryReel();
            },
            showPostReactionsModal: async (postId) => {
                const reactors = await dbModule.getPostReactors(postId);
                const tabs = ['all', ...Object.keys(reactionEmojis)];
                const tabsHtml = tabs.map(tab => `<div class="reactions-modal-tab ${tab === 'all' ? 'active' : ''}" data-reaction-type="${tab}"> ${tab === 'all' ? _t('all') : reactionEmojis[tab]} </div>`).join('');
                const modalContent = `<div class="reactions-modal-header">${_t('reactions_title')}</div><div class="reactions-modal-tabs">${tabsHtml}</div><div class="reaction-user-list"></div>`;
                uiModule.showModal(modalContent, 'reactions');
                const userListContainer = document.querySelector('.reaction-user-list');
                const tabsContainer = document.querySelector('.reactions-modal-tabs');
                const renderList = (filterType) => {
                    const filteredReactors = filterType === 'all' ? reactors : reactors.filter(r => r.reactionType === filterType);
                    if (filteredReactors.length === 0) { userListContainer.innerHTML = `<p style="text-align:center; padding: 20px;">${_t('no_reactions_yet')}</p>`; return; }
                    userListContainer.innerHTML = filteredReactors.map(user => `<div class="reaction-user-item" data-view="profile" data-userid="${user.uid}"><div class="avatar" id="reactor-avatar-${user.uid}"></div><span class="name">${user.name}${uiModule.getVerifiedBadgeHTML(user.isVerified)}</span><span class="reaction-icon">${reactionEmojis[user.reactionType]}</span></div>`).join('');
                    filteredReactors.forEach(user => uiModule.renderAvatar(document.getElementById(`reactor-avatar-${user.uid}`), user));
                };
                tabsContainer.addEventListener('click', e => { const tab = e.target.closest('.reactions-modal-tab'); if (tab) { tabsContainer.querySelector('.active').classList.remove('active'); tab.classList.add('active'); renderList(tab.dataset.reactionType); } });
                renderList('all');
            },
            showStoryViewersModal: async (storyId) => {
                 const viewers = await dbModule.getStoryViewersAndReactors(storyId); let listHtml;
                 if (viewers.length === 0) { listHtml = `<p style="text-align:center; padding: 20px;">${_t('no_views_yet')}</p>`; } 
                 else { listHtml = viewers.map(user => `<div class="reaction-user-item" data-view="profile" data-userid="${user.uid}"><div class="avatar" id="viewer-avatar-${user.uid}"></div><span class="name">${user.name}${uiModule.getVerifiedBadgeHTML(user.isVerified)}</span>${user.reactionType ? `<span class="reaction-icon">${reactionEmojis[user.reactionType]}</span>` : ''}</div>`).join(''); }
                 const modalContent = `<div class="reactions-modal-header">${_t('story_viewers_title')}</div><div class="reaction-user-list">${listHtml}</div>`;
                 uiModule.showModal(modalContent, 'reactions');
                 if (viewers.length > 0) { viewers.forEach(user => uiModule.renderAvatar(document.getElementById(`viewer-avatar-${user.uid}`), user)); }
            },
            showGiftModal: (recipientId, recipientName) => {
                const modalContent = `
                    <h3>${_t('send_gift')} to ${recipientName}</h3>
                    <p>${_t('balance_with_currency')} ${(currentUserData.balance || 0).toFixed(2)}</p>
                    <label for="giftAmount">${_t('gift_amount')}</label>
                    <input type="number" id="giftAmount" class="input" step="1" min="1" required>
                    <label for="giftNote">${_t('gift_note')}</label>
                    <input type="text" id="giftNote" class="input">
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button id="confirmGiftBtn" class="btn" style="flex-grow:1;" data-recipient-id="${recipientId}" data-recipient-name="${recipientName}">${_t('send_gift')}</button>
                        <button class="btn secondary" data-action="close-modal">${_t('cancel')}</button>
                    </div>`;
                uiModule.showModal(modalContent);
            },
        };
        
        const adsterraModule = {
            socialAdLoaded: false,
            renderFeedTopBanner: (cId) => {
                const c = document.getElementById(cId); if (!c) return;
                c.innerHTML = '';
                const s = document.createElement('script');
                s.type = 'text/javascript';
                s.src = '//pl24884156.profitableratecpm.com/8f/2b/62/8f2b62291888066e4da1bbe05518f825.js';
                c.appendChild(s);
            },
            loadSocialAdScript: () => {
                if (adsterraModule.socialAdLoaded) return;
                const adContainer = document.createElement('div');
                const s1 = document.createElement('script');
                s1.type = 'text/javascript';
                s1.innerHTML = `atOptions = {'key' : '7e993c9a5ee5c40383d3233682d12774', 'format' : 'iframe', 'height' : 300, 'width' : 160, 'params' : {}};`;
                const s2 = document.createElement('script');
                s2.type = 'text/javascript';
                s2.src = '//www.highperformanceformat.com/7e993c9a5ee5c40383d3233682d12774/invoke.js';
                adContainer.appendChild(s1);
                adContainer.appendChild(s2);
                document.body.appendChild(adContainer);
                adsterraModule.socialAdLoaded = true;
            },
            renderPostBannerAd: (cId) => {
                const c = document.getElementById(cId); if (!c) return;
                c.innerHTML = '';
                const adContainer = document.createElement('div');
                const s1 = document.createElement('script');
                s1.type = 'text/javascript';
                s1.innerHTML = `atOptions = {'key' : '7de88b818e800f43ccfc3d6d01aa172d', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {}};`;
                const s2 = document.createElement('script');
                s2.type = 'text/javascript';
                s2.src = `//www.highperformanceformat.com/7de88b818e800f43ccfc3d6d01aa172d/invoke.js?cb=${Date.now()}`;
                adContainer.appendChild(s1);
                adContainer.appendChild(s2);
                c.appendChild(adContainer);
            },
            renderSidebarAd: (cId) => {
                const c = document.getElementById(cId); if (!c) return;
                c.innerHTML = '';
                const adContainer = document.createElement('div');
                const s1 = document.createElement('script');
                s1.type = 'text/javascript';
                s1.innerHTML = `atOptions = {'key' : '869672b09f31b4807c660659d67070cd', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {}};`;
                const s2 = document.createElement('script');
                s2.type = 'text/javascript';
                s2.src = `//www.highperformanceformat.com/869672b09f31b4807c660659d67070cd/invoke.js?cb=${Date.now()}`;
                adContainer.appendChild(s1);
                adContainer.appendChild(s2);
                c.appendChild(adContainer);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            authModule.init();
            
            window.onpopstate = (event) => {
                if (event.state) {
                    const { view, params } = event.state;
                    uiModule.showView(view, params, false); 
                } else {
                    const defaultView = currentUserData?.isAdmin ? 'admin' : 'feed';
                    uiModule.showView(defaultView, {}, false);
                }
            };

            const menuToggle = document.getElementById('mobile-menu-toggle');
            const leftSidebar = document.querySelector('.left-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const closeMenu = () => { leftSidebar.classList.remove('open'); sidebarOverlay.classList.add('hidden'); };
            if(menuToggle) {
                menuToggle.addEventListener('click', (e) => { e.stopPropagation(); leftSidebar.classList.add('open'); sidebarOverlay.classList.remove('hidden'); });
            }
            sidebarOverlay.addEventListener('click', closeMenu);
            leftSidebar.addEventListener('click', (e) => { const t = e.target.closest('.menu-item, [data-action="set-lang"], [data-action="set-theme"], .search-result-item'); if (t) { if(!t.closest('#mobile-search-container')) { closeMenu(); } else if (t.classList.contains('search-result-item')) { closeMenu(); } } });

            document.getElementById('loginBtn').onclick=()=>{const e=document.getElementById('loginEmail').value,p=document.getElementById('loginPassword').value;if(!e||!p){document.getElementById('authError').textContent=_t('fill_all_fields');return;}uiModule.showLoader(true);authModule.login(e,p).finally(()=>uiModule.showLoader(false));};
            document.getElementById('show-register-modal-btn').onclick=uiModule.showRegisterModal;
            document.getElementById('forgot-password-link').onclick=()=>{const e=prompt(_t('password_reset_prompt'));if(e){uiModule.showLoader(true);authModule.resetPassword(e).then(()=>alert(_t('password_reset_success'))).catch((err)=>alert(_t('password_reset_fail', {message: err.message}))).finally(()=>uiModule.showLoader(false));}};
            
            document.getElementById('modal-container').addEventListener('click',async e=>{
                const t=e.target;
                if (t.closest('[data-view="profile"]')) { document.getElementById('modal-container').classList.add('hidden'); }
                if(t.dataset.action==='close-modal'||t.id==='modal-container'){document.getElementById('modal-container').classList.add('hidden');return;}
                if(t.dataset.action==='copy-secret'){ await navigator.clipboard.writeText(t.textContent); alert(_t('copied')); return; }
                if(t.id==='registerBtn'){uiModule.showLoader(true);const n=document.getElementById('registerName').value,em=document.getElementById('registerEmail').value,p=document.getElementById('registerPhone').value,w=document.getElementById('registerPassword').value;if(!n||!em||!p||!w){alert(_t('fill_all_fields'));uiModule.showLoader(false);return;}try{await authModule.register(n,em,p,w);document.getElementById('modal-container').classList.add('hidden');}catch(err){alert(_t('registration_failed', {message: err.message}));}finally{uiModule.showLoader(false);}}
                else if(t.id==='createPostBtn'){uiModule.showLoader(true);try{const audience = document.getElementById('postAudience').value; await dbModule.createPost(document.getElementById('postText').value,document.getElementById('mediaFile')?.files[0], audience);document.getElementById('modal-container').classList.add('hidden');uiModule.showView(currentView);}catch(err){alert(_t('post_creation_failed', {message: err.message}));}finally{uiModule.showLoader(false);}}
                else if(t.id==='saveProfileBtn'){
                    uiModule.showLoader(true);
                    try {
                        const newName = document.getElementById('editName').value, newBio = document.getElementById('editBio').value, newRelationshipStatus = document.getElementById('editRelationshipStatus').value, newRelationshipWith = document.getElementById('editRelationshipWith').value.replace('@',''), newEmail = document.getElementById('editEmail').value, newPhone = document.getElementById('editPhone').value, newPassword = document.getElementById('editNewPassword').value, confirmPassword = document.getElementById('editConfirmPassword').value, currentPassword = document.getElementById('editCurrentPassword').value, profilePicFile = document.getElementById('editProfilePic').files[0], coverPicFile = document.getElementById('editCoverPic').files[0];
                        const isEmailChanged = newEmail !== currentUser.email, isPasswordChanged = newPassword.length > 0, isNameChanged = newName !== currentUserData.name;
                        const profileUpdates = { name: newName, bio: newBio, relationshipStatus: newRelationshipStatus, relationshipWith: newRelationshipWith, phone: newPhone };
                        if (profilePicFile) profileUpdates.photoURL = await dbModule.uploadFile(profilePicFile, `users/${currentUser.uid}/profile`);
                        if (coverPicFile) profileUpdates.coverPhotoURL = await dbModule.uploadFile(coverPicFile, `users/${currentUser.uid}/cover`);
                        const dbUpdates = {};
                        if (isNameChanged) {
                            const newSlug = await generateUniqueSlug(newName, currentUser.uid);
                            if (currentUserData.usernameSlug) { dbUpdates[`/usernameSlugs/${currentUserData.usernameSlug}`] = null; }
                            profileUpdates.usernameSlug = newSlug;
                            dbUpdates[`/usernameSlugs/${newSlug}`] = currentUser.uid;
                        }
                        if (isEmailChanged || isPasswordChanged) {
                            if (!currentPassword) throw new Error(_t('reauth_required_error'));
                            if (isPasswordChanged && newPassword !== confirmPassword) throw new Error(_t('password_mismatch_error'));
                            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPassword);
                            await currentUser.reauthenticateWithCredential(credential);
                            if (isEmailChanged) { await currentUser.updateEmail(newEmail); profileUpdates.email = newEmail; }
                            if (isPasswordChanged) { await currentUser.updatePassword(newPassword); }
                        }
                        dbUpdates[`/users/${currentUser.uid}`] = { ...currentUserData, ...profileUpdates };
                        await db.ref().update(dbUpdates);
                        alert(_t('profile_update_success'));
                        document.getElementById('modal-container').classList.add('hidden');
                        uiModule.showView('profile');
                    } catch(err) { if (err.code === 'auth/wrong-password' || err.code === 'auth/user-mismatch') { alert(_t('reauth_failed_error')); } else { alert(_t('profile_update_failed', {message: err.message})); }
                    } finally { uiModule.showLoader(false); }
                }
                else if(t.id==='saveBalanceBtn'){uiModule.showLoader(true);const uId=t.dataset.userid,nB=parseFloat(document.getElementById('newBalanceInput').value);if(isNaN(nB)){alert(_t('invalid_number'));uiModule.showLoader(false);return;}try{await dbModule.updateUserBalanceByAdmin(uId,nB);alert(_t('balance_update_success'));document.getElementById('modal-container').classList.add('hidden');await uiModule.showView('admin');}catch(err){alert(_t('balance_update_failed', {message: err.message}));}finally{uiModule.showLoader(false);}}
                else if (t.id === 'verifyMfaBtn') {
                    uiModule.showLoader(true);
                    const code = document.getElementById('mfaCode').value; let credential;
                    if(mfaHint.factorId === firebase.auth.PhoneAuthProvider.PROVIDER_ID) { credential = firebase.auth.PhoneAuthProvider.credential(mfaVerificationId, code); } 
                    else if (mfaHint.factorId === firebase.auth.TotpMultiFactorGenerator.FACTOR_ID) { credential = firebase.auth.TotpMultiFactorGenerator.assertionForSignIn(mfaHint.uid, code); }
                    mfaResolver.resolveSignIn(credential).then(() => { mfaResolver = null; mfaVerificationId = null; mfaHint = null; document.getElementById('modal-container').classList.add('hidden'); }).catch(err => { alert(_t('error_generic') + ": " + err.message); }).finally(() => uiModule.showLoader(false));
                }
                else if (t.id === 'verifyPhoneEnrollBtn') {
                    uiModule.showLoader(true);
                    const code = document.getElementById('mfaCode').value, verificationId = t.dataset.verificationId, credential = firebase.auth.PhoneAuthProvider.credential(verificationId, code), multiFactorAssertion = firebase.auth.PhoneAuthProvider.assertion(credential);
                    await currentUser.multiFactor.enroll(multiFactorAssertion, currentUserData.name + ' Phone');
                    alert(_t('mfa_phone_enroll_success'));
                    document.getElementById('modal-container').classList.add('hidden');
                    await uiModule.showView('profile');
                    uiModule.showLoader(false);
                }
                else if (t.id === 'verifyTotpBtn') {
                    uiModule.showLoader(true);
                    const code = document.getElementById('mfaCode').value;
                    if (totpEnrollment && code) {
                        const credential = firebase.auth.TotpMultiFactorGenerator.assertionForEnrollment(totpEnrollment.uid, code);
                        currentUser.multiFactor.enroll(credential, "Authenticator App").then(() => { alert(_t('mfa_totp_enroll_success')); totpEnrollment = null; document.getElementById('modal-container').classList.add('hidden'); uiModule.showView('profile'); }).catch((err) => { alert(_t('mfa_totp_enroll_fail', {message: err.message})); }).finally(() => uiModule.showLoader(false));
                    }
                }
                else if(t.id === 'confirmGiftBtn'){
                    const amount = parseFloat(document.getElementById('giftAmount').value);
                    const note = document.getElementById('giftNote').value.trim();
                    const recipientId = t.dataset.recipientId;
                    const recipientName = t.dataset.recipientName;

                    if (isNaN(amount) || amount <= 0) { alert(_t('invalid_number')); return; }
                    if (amount > (currentUserData.balance || 0)) { alert(_t('insufficient_balance')); return; }

                    if (confirm(_t('confirm_gift', {name: recipientName, amount: amount.toFixed(2)}))) {
                        uiModule.showLoader(true);
                        try {
                            await dbModule.sendGift(recipientId, amount, note);
                            alert(_t('gift_success', {name: recipientName, amount: amount.toFixed(2)}));
                            document.getElementById('modal-container').classList.add('hidden');
                            await uiModule.showView(currentView, { userId: currentView === 'profile' ? recipientId : currentUser.uid });
                        } catch (err) {
                            alert(_t('gift_fail') + ' ' + err.message);
                        } finally {
                            uiModule.showLoader(false);
                        }
                    }
                }
                 else if (t.id === 'cancel-edit-game-btn') {
                    const form = document.getElementById('add-game-form');
                    form.reset();
                    form.querySelector('#gameIdInput').value = '';
                    form.querySelector('#game-form-title').textContent = _t('add_new_game');
                    t.classList.add('hidden');
                }
            });
            
            document.body.addEventListener('click',async e=>{
                const t=e.target.closest('[data-view],[data-action],#post-input-placeholder,.mention-link,.hashtag-link,.reaction');
                if(!t||!currentUser) return;
                
                const vT=e.target.closest('[data-view]');
                if (vT) {
                    const view = vT.dataset.view;
                    const params = { userId: vT.dataset.userid, tag: vT.dataset.tag, gameId: vT.dataset.gameid };
                    const leftSidebar = document.querySelector('.left-sidebar');
                    if (leftSidebar.classList.contains('open')) {
                        const sidebarOverlay = document.getElementById('sidebar-overlay');
                        leftSidebar.classList.remove('open');
                        sidebarOverlay.classList.add('hidden');
                    }
                    uiModule.showView(view, params);
                    return;
                }

                if(t.id==='post-input-placeholder'){uiModule.showPostModal();return;}
                if(t.matches('.mention-link')){e.preventDefault();const uN=t.dataset.username;uiModule.showLoader(true);try{const s=await db.ref('users').orderByChild('name').equalTo(uN).limitToFirst(1).once('value');if(s.exists()){const uId=Object.keys(s.val())[0];uiModule.showView('profile',{userId:uId});}else{alert(_t('user_not_found'));}}catch(err){console.error(err);}finally{uiModule.showLoader(false);}return;}
                if(t.matches('.reaction') && !t.closest('.story-reaction-bar')){const p=t.closest('.post'),rT=t.dataset.reactionType;await dbModule.reactToPost(p.dataset.postId,p.dataset.ownerid,rT);return;}
                
                const a=t.dataset.action;if(a){
                const nLA=['logout','close-notification','copy-profile-link','edit-profile','manage-balance','view-balance-history','focus-comment','react-post','set-lang','set-theme','copy-post-link', 'create-story', 'view-story', 'show-reactions', 'show-story-viewers', 'show-reply-form', 'navigate-to-post', 'send-gift'];
                if(!nLA.includes(a))uiModule.showLoader(true);
                try{
                    switch(a){
                         case 'delete-comment':
                            const postId = t.dataset.postid;
                            const commentId = t.dataset.commentid;
                            if (confirm(_t('confirm_comment_delete'))) {
                                uiModule.showLoader(true);
                                try {
                                    await dbModule.deleteComment(postId, commentId);
                                    // alert(_t('comment_deleted_success')); // Optional: can be annoying
                                    const commentEl = document.getElementById(`comment-${commentId}`);
                                    if (commentEl) commentEl.remove();
                                } catch (err) {
                                    alert(_t('comment_delete_fail'));
                                    console.error("Comment delete error:", err);
                                } finally {
                                    uiModule.showLoader(false);
                                }
                            }
                            break;
                        case 'delete-game':
                            const gameIdToDelete = t.dataset.gameid;
                            if (confirm(_t('confirm_game_delete'))) {
                                uiModule.showLoader(true);
                                try {
                                    await dbModule.deleteGame(gameIdToDelete);
                                    alert(_t('game_deleted_success'));
                                    uiModule.renderAdminGamesManager(document.getElementById('admin-games-manager'));
                                } catch (err) { alert(_t('game_op_failed')); } 
                                finally { uiModule.showLoader(false); }
                            }
                            break;
                        case 'edit-game':
                            const gameIdToEdit = t.dataset.gameid;
                            const gameToEdit = await dbModule.getGame(gameIdToEdit);
                            if (gameToEdit) {
                                const form = document.getElementById('add-game-form');
                                form.querySelector('#game-form-title').textContent = _t('edit_game');
                                form.querySelector('#gameIdInput').value = gameToEdit.id;
                                form.querySelector('#gameTitleInput').value = gameToEdit.title;
                                form.querySelector('#gameThumbInput').value = gameToEdit.thumbnailUrl;
                                form.querySelector('#gameTypeSelect').value = gameToEdit.type;
                                form.querySelector('#gameContentInput').value = gameToEdit.content;
                                form.querySelector('#cancel-edit-game-btn').classList.remove('hidden');
                                form.scrollIntoView({ behavior: 'smooth' });
                            }
                            break;
                        case 'create-story': uiModule.showCreateStoryModal(); break;
                        case 'view-story': const userIndex = parseInt(t.closest('.story-item').dataset.userIndex, 10); uiModule.showStoryViewer(userIndex); break;
                        case 'show-reactions': uiModule.showPostReactionsModal(t.dataset.postid); break;
                        case 'show-story-viewers': uiModule.showStoryViewersModal(t.dataset.storyid); break;
                        case 'react-post':
                            const p = t.closest('.post'), ownerId = p.dataset.ownerid, postIdReact = p.dataset.postId;
                            const rS = await db.ref(`postReactions/${postIdReact}/${currentUser.uid}`).once('value');
                            if (rS.exists()) { await dbModule.removeReaction(postIdReact, ownerId); } 
                            else { await dbModule.reactToPost(postIdReact, ownerId, 'like'); }
                            break;
                        case 'navigate-to-post': uiModule.showPostDetailModal(t.dataset.postid); break; 
                        case 'show-reply-form':
                            const commentIdReply = t.dataset.commentId;
                            const formContainer = document.getElementById(`reply-form-for-${commentIdReply}`);
                            if(formContainer.innerHTML === '') {
                                formContainer.innerHTML = `
                                <form class="comment-reply-form" data-action="submit-reply" data-parent-id="${commentIdReply}">
                                    <div class="avatar" style="width:28px; height:28px; font-size:14px;"></div>
                                    <input class="input" type="text" placeholder="${_t('write_a_comment')}" required>
                                    <button type="submit" class="btn small"><i class="fa-solid fa-paper-plane"></i></button>
                                </form>`;
                                uiModule.renderAvatar(formContainer.querySelector('.avatar'), currentUserData);
                                formContainer.querySelector('input').focus();
                            } else {
                                formContainer.innerHTML = '';
                            }
                            break;
                        case 'send-password-reset':
                            const email = t.dataset.userEmail;
                            if (email && confirm(`${_t('password_reset_sent_success', {email: email})}?`)) {
                                try { await authModule.resetPassword(email); alert(_t('password_reset_sent_success', {email: email})); } 
                                catch(err) { alert(_t('password_reset_sent_fail')); }
                            }
                            break;
                        case'focus-comment':t.closest('.post').querySelector('.comment-form .input').focus();break;
                        case'follow': await dbModule.followUser(t.dataset.userid); uiModule.showView(currentView === 'people' ? 'people' : 'profile', {userId: t.dataset.userid}); break;
                        case'unfollow': await dbModule.unfollowUser(t.dataset.userid); uiModule.showView(currentView === 'people' ? 'people' : 'profile', {userId: t.dataset.userid}); break;
                        case'send-friend-request': await dbModule.sendFriendRequest(t.dataset.userid); uiModule.showView(currentView === 'people' ? 'people' : 'profile', {userId: t.dataset.userid}); break;
                        case 'cancel-friend-request': await dbModule.cancelFriendRequest(t.dataset.userid); uiModule.showView(currentView === 'people' ? 'people' : 'profile', {userId: t.dataset.userid}); break;
                        case 'accept-friend-request': await dbModule.acceptFriendRequest(t.dataset.userid); document.getElementById(`request-item-${t.dataset.userid}`).remove(); break;
                        case 'decline-friend-request': await dbModule.declineFriendRequest(t.dataset.userid); document.getElementById(`request-item-${t.dataset.userid}`).remove(); break;
                        case 'unfriend': if (confirm(_t('confirm_unfriend', {name: t.dataset.username}))) { await dbModule.unfriendUser(t.dataset.userid); uiModule.showView('profile', {userId: t.dataset.userid}); } break;
                        case'edit-profile':uiModule.showEditProfileModal(currentUserData);break;
                        case 'toggle-professional-mode':
                            const currentState = !!currentUserData.isProfessionalMode, newState = !currentState;
                            await db.ref(`users/${currentUser.uid}`).update({ isProfessionalMode: newState, profileCategory: newState ? _t('digital_creator') : '' });
                            alert(newState ? _t('professional_mode_on_success') : _t('professional_mode_off_success'));
                            document.getElementById('modal-container').classList.add('hidden');
                            await uiModule.showView('profile', { userId: currentUser.uid });
                            break;
                        case'logout':await authModule.logout();break;
                        case 'copy-post-link': const postLink = `${BASE_URL}/post/${t.dataset.postid}`; await navigator.clipboard.writeText(postLink); alert(_t('copied')); break;
                        case'copy-profile-link':await navigator.clipboard.writeText(t.dataset.link);t.innerHTML=_t('copied');setTimeout(()=>{t.innerHTML=_t('copy');},2000);break;
                        case'delete-post':const pEl=t.closest('.post'),pId=t.dataset.postid;if(confirm(_t('confirm_post_delete'))){uiModule.showLoader(true);try{await dbModule.deletePost(pId);pEl.remove();}catch(err){alert(_t('error_post_delete',{message: err.message}));}finally{uiModule.showLoader(false);}}break;
                        case'toggle-verify':if(currentUserData.isAdmin){await dbModule.toggleUserVerification(t.dataset.userid,t.dataset.currentstate==='true');await uiModule.showView('admin');}break;
                        case'toggle-monetize':if(currentUserData.isAdmin){await dbModule.toggleUserMonetization(t.dataset.userid,t.dataset.currentstate==='true');await uiModule.showView('admin');}break;
                        case'toggle-suspend':if(currentUserData.isAdmin){await dbModule.toggleUserSuspension(t.dataset.userid,t.dataset.currentstate==='true');await uiModule.showView('admin');}break;
                        case'close-notification':document.getElementById('global-notification-banner').classList.add('hidden');if(currentUserData.isAdmin)db.ref('appSettings/globalNotification').set(null);break;
                        case'manage-balance':if(currentUserData.isAdmin){uiModule.showManageBalanceModal(t.dataset.userid,t.dataset.username,t.dataset.currentbalance);}break;
                        case'view-balance-history':uiModule.showLoader(true);const h=await dbModule.getBalanceHistory(currentUser.uid);uiModule.showLoader(false);uiModule.showBalanceHistoryModal(h);break;
                        case'set-lang': settingsModule.setLanguage(t.dataset.lang); break;
                        case'set-theme': settingsModule.setTheme(t.dataset.theme); break;
                        case 'block-user': if (confirm(_t('confirm_block', { name: t.dataset.username }))) { await dbModule.blockUser(t.dataset.userid); uiModule.showView('feed'); } break;
                        case 'unblock-user': if (confirm(_t('confirm_unblock', { name: t.dataset.username }))) { await dbModule.unblockUser(t.dataset.userid); uiModule.showView('profile', { userId: t.dataset.userid }); } break;
                        case 'manage-2fa': uiModule.showManage2faModal(); break;
                        case 'enable-phone-2fa':
                            const phone = currentUserData.phone; if (!phone) { alert(_t('mfa_add_phone_prompt')); uiModule.showLoader(false); return; }
                            const normalizedPhone = authModule.normalizePhoneNumber(phone); if (!normalizedPhone) { alert(_t('mfa_invalid_phone')); uiModule.showLoader(false); return; }
                            try { const phoneProvider = new firebase.auth.PhoneAuthProvider(auth), session = await currentUser.multiFactor.getSession(); const verificationId = await phoneProvider.verifyPhoneNumber({ phoneNumber: normalizedPhone, session: session }, window.recaptchaVerifier); uiModule.showPhoneEnrollVerifyModal(verificationId); } 
                            catch (err) { console.error("SMS verification error", err); alert(_t('mfa_phone_enroll_fail', {message: err.message})); }
                            break;
                        case 'enable-totp-2fa':
                            try { const multiFactorSession = await currentUser.multiFactor.getSession(); const enrollment = await firebase.auth.TotpMultiFactorGenerator.generateSecret(multiFactorSession); uiModule.showTotpEnrollModal(enrollment); } 
                            catch (err) { alert(_t('mfa_totp_enroll_fail',{message: err.message})); }
                            break;
                        case 'disable-mfa': if (confirm(_t('mfa_disable_prompt'))) { const factorUid = t.dataset.factorUid; await currentUser.multiFactor.unenroll(factorUid); alert('2FA disabled successfully.'); uiModule.showManage2faModal(); } break;
                        case 'manage-blocked-list': await uiModule.showBlockListModal(); break;
                        case 'unblock-user-from-list': const userIdToUnblock = t.dataset.userid; await dbModule.unblockUser(userIdToUnblock); t.closest('.blocked-user-item').remove(); break;
                        case 'send-gift':
                            uiModule.showGiftModal(t.dataset.userid, t.dataset.username);
                            break;
                    }
                }catch(err){console.error("Action failed:",a,err);alert(_t('action_failed') + ": " + err.message);}finally{if(!nLA.includes(a))uiModule.showLoader(false);}}});
            
            document.body.addEventListener('change', async e => {
                const t = e.target;
                if (t.dataset.action === 'change-role') {
                    const userId = t.dataset.userid, newRole = t.value, userName = allUsersCache.find(u => u.uid === userId)?.name || 'Unknown';
                    if (userId === currentUser.uid) { alert(_t('cannot_change_own_role')); t.value = currentUserData.role; return; }
                    uiModule.showLoader(true);
                    try {
                        await dbModule.setUserRole(userId, newRole);
                        const userIndex = allUsersCache.findIndex(u => u.uid === userId);
                        if(userIndex > -1) allUsersCache[userIndex].role = newRole;
                        alert(_t('change_role_success', {name: userName}));
                        uiModule.renderAdminUserList(allUsersCache);
                    } catch(err) { alert(_t('change_role_fail')); console.error("Role change failed:", err); } 
                    finally { uiModule.showLoader(false); }
                }
            });

            document.body.addEventListener('submit',async e=>{
                e.preventDefault();
                const f=e.target, a=f.dataset.action || f.id;
                
                if(a==='add-comment'){const pId=f.closest('.post').dataset.postId,i=f.querySelector('input');if(i.value.trim()){await dbModule.addComment(pId,i.value.trim());i.value='';f.closest('.comment-form-wrapper').querySelector('.mention-suggestions').style.display='none';}}
                else if (a === 'submit-reply') {
                    const pId = f.closest('.post').dataset.postId, i = f.querySelector('input'), parentId = f.dataset.parentId;
                    if(i.value.trim()){ await dbModule.addComment(pId, i.value.trim(), parentId); f.remove(); }
                }
                else if(a==='send-message'){const rId=f.dataset.receiverid,i=f.querySelector('input'),t=i.value.trim();if(t){i.value='';f.closest('.message-form-wrapper').querySelector('.mention-suggestions').style.display='none';
                    const chatId = dbModule.getChatId(currentUser.uid, rId);
                    db.ref(`typingStatus/${chatId}/${currentUser.uid}`).remove();
                    if(typingTimeout) clearTimeout(typingTimeout);
                    await dbModule.sendMessage(rId,t);
                }}
                else if(f.id==='monetization-settings-form'){uiModule.showLoader(true);try{const s={likesToBalanceRatio:parseInt(document.getElementById('likesRatio').value,10),balancePerMilestone:parseFloat(document.getElementById('balanceAmount').value)};if(isNaN(s.likesToBalanceRatio)||isNaN(s.balancePerMilestone)||s.likesToBalanceRatio<1){alert(_t('invalid_number'));return;}await dbModule.updateAppSettings(s);alert(_t('settings_save_success'));}catch(err){alert(_t('settings_save_failed',{message: err.message}));}finally{uiModule.showLoader(false);}}
                else if(f.id==='notification-form'){uiModule.showLoader(true);const t=document.getElementById('notificationText').value;try{if(t.trim()){await dbModule.sendGlobalNotification(t);alert(_t('notification_sent_success'));document.getElementById('notificationText').value='';}else{await db.ref('appSettings/globalNotification').set(null);alert(_t('notification_removed'));}}catch(err){alert(_t('notification_send_failed',{message: err.message}));}finally{uiModule.showLoader(false);}}
                else if (f.id === 'add-game-form') {
                    uiModule.showLoader(true);
                    const gameId = f.querySelector('#gameIdInput').value;
                    const gameData = {
                        title: f.querySelector('#gameTitleInput').value,
                        thumbnailUrl: f.querySelector('#gameThumbInput').value,
                        type: f.querySelector('#gameTypeSelect').value,
                        content: f.querySelector('#gameContentInput').value
                    };
                    try {
                        if (gameId) {
                            await dbModule.updateGame(gameId, gameData);
                            alert(_t('game_updated_success'));
                        } else {
                            await dbModule.addGame(gameData);
                            alert(_t('game_added_success'));
                        }
                        f.reset();
                        f.querySelector('#gameIdInput').value = '';
                        f.querySelector('#game-form-title').textContent = _t('add_new_game');
                        f.querySelector('#cancel-edit-game-btn').classList.add('hidden');
                        uiModule.renderAdminGamesManager(document.getElementById('admin-games-manager'));
                    } catch (err) {
                        alert(_t('game_op_failed'));
                        console.error("Game form submission error:", err);
                    } finally {
                        uiModule.showLoader(false);
                    }
                }
            });
        });
    </script>
</body>
</html>
<script type="text/javascript">
	atOptions = {
		'key' : '54d479897b78846fa6a6d7fb13b8c40e',
		'format' : 'iframe',
		'height' : 60,
		'width' : 468,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/54d479897b78846fa6a6d7fb13b8c40e/invoke.js"></script>
<script type="text/javascript">
	atOptions = {
		'key' : '5867a709c98d52913b7d8da49b6b71a7',
		'format' : 'iframe',
		'height' : 90,
		'width' : 728,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/5867a709c98d52913b7d8da49b6b71a7/invoke.js"></script>
<script type='text/javascript' src='//pl27278681.profitableratecpm.com/2f/56/51/2f565147eae6b070d99c30d44f83adfe.js'></script>